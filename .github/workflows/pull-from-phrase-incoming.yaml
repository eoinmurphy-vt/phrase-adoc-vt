name: Pull from Phrase Incoming Branch

on:
  workflow_dispatch:
  push:
    branches:
      - phrase-incoming

permissions:
  contents: write
  pull-requests: write

env:
  TRANSLATED_DIR: ${{ vars.TRANSLATED_DIR || 'translated' }}
  PHRASE_INCOMING_BRANCH: ${{ vars.PHRASE_INCOMING_BRANCH || 'phrase-incoming' }}
  # Define the PR branch name here so we can reference it easily in multiple steps
  PR_BRANCH: chore/phrase-sync

jobs:
  sync-incoming:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Fetch all branches
        run: git fetch --all --prune

      - name: Sync translated directory from incoming
        run: |
          echo "Clearing existing translated folder..."
          rm -rf "$TRANSLATED_DIR"

          echo "Copying $TRANSLATED_DIR from origin/${PHRASE_INCOMING_BRANCH}..."
          git checkout "origin/${PHRASE_INCOMING_BRANCH}" -- "$TRANSLATED_DIR"

          echo "Translated directory content:"
          ls -R "$TRANSLATED_DIR"

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: sync translations from phrase-incoming"
          committer: GitHub <noreply@github.com>
          author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
          signoff: false
          
          # Branch configuration (uses the env var we defined)
          branch: ${{ env.PR_BRANCH }}
          delete-branch: true 
          
          title: "Sync: Updated Translations from Phrase"
          body: |
            This PR syncs the latest changes from the `${{ env.PHRASE_INCOMING_BRANCH }}` branch.
            Automated by GitHub Actions.
          base: main

      - name: Enable Auto-Merge
        if: steps.cpr.outputs.pull-request-operation == 'created' || steps.cpr.outputs.pull-request-operation == 'updated'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Merging Pull Request..."
          
          # This command tells GitHub to merge the PR immediately.
          # --merge: Use a merge commit (preserves history). Use --squash if you prefer one clean commit.
          # --auto: If you have required status checks, this waits for them to pass before merging.
          # --delete-branch: Deletes the temp branch after merge.
          
          gh pr merge ${{ env.PR_BRANCH }} --merge --auto --delete-branch