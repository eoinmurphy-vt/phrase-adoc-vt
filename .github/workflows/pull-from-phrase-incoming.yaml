name: Process Phrase Incoming Files

on:
  push:
    branches:
      - phrase-incoming

jobs:
  process-incoming:
    runs-on: ubuntu-latest

    env:
      INCOMING_BRANCH: phrase-incoming
      TRANSLATED_DIR: translated
      MAIN_BRANCH: main

    steps:
      # ----------------------------
      # Checkout incoming branch
      # ----------------------------
      - name: Checkout incoming branch
        uses: actions/checkout@v4
        with:
          ref: phrase-incoming
          fetch-depth: 0

      # ----------------------------
      # Identify changed .adoc files
      # ----------------------------
      - name: Identify changed .adoc files
        id: changes
        run: |
          echo "Detecting changed .adoc filesâ€¦"

          # Find changed .adoc files relative to previous commit
          git diff --name-only HEAD^ HEAD | grep '\.adoc$' > changed_files.txt || true

          echo "Changed files:"
          cat changed_files.txt || echo "(none)"

          # Export to job output as space-separated string
          FILE_LIST=$(paste -sd ' ' changed_files.txt)
          echo "changed_files=$FILE_LIST" >> $GITHUB_OUTPUT

      # ----------------------------
      # Stop workflow if no .adoc files changed
      # ----------------------------
      - name: Stop if no files changed
        if: ${{ steps.changes.outputs.changed_files == '' }}
        run: |
          echo "No changed .adoc files. Exiting workflow."
          exit 0

      # ----------------------------
      # Process each changed file
      # ----------------------------
      - name: Run post-processing on each file
        run: |
          while IFS= read -r file; do
            echo "Processing: $file"
            # ðŸ”§ Replace this with your real script
            ./scripts/postprocess_adoc.sh "$file"
          done < changed_files.txt

      # ----------------------------
      # Checkout main branch separately
      # ----------------------------
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          path: main_branch
          fetch-depth: 0

      # ----------------------------
      # Copy processed files into translated/{targetLang}/
      # ----------------------------
      - name: Copy changed .adoc files into translated/
        run: |
          LANG_NAME="${GITHUB_REF_NAME}" # if you ever use per-language branches
          DEST_DIR="main_branch/${TRANSLATED_DIR}/${LANG_NAME}"

          echo "Copying files to: $DEST_DIR"
          mkdir -p "$DEST_DIR"

          while IFS= read -r file; do
            echo "Copying: $file"

            # Create folder structure
            mkdir -p "$DEST_DIR/$(dirname "$file")"

            # Copy from incoming branch version of the file
            git show "${GITHUB_SHA}:${file}" > "$DEST_DIR/$file"
          done < changed_files.txt

      # ----------------------------
      # Commit to main
      # ----------------------------
      - name: Commit processed files to main
        run: |
          cd main_branch
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add translated/
          git commit -m "Processed incoming files from Phrase TMS" || echo "nothing to commit"
          git push origin main
