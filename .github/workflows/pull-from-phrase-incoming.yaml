name: Pull from Phrase Incoming Branch

on:
  workflow_dispatch:
  push:
    branches:
      - phrase-incoming

permissions:
  contents: write
  pull-requests: write

env:
  TRANSLATED_DIR: ${{ vars.TRANSLATED_DIR || 'translated' }}
  PHRASE_INCOMING_BRANCH: ${{ vars.PHRASE_INCOMING_BRANCH || 'phrase-incoming' }}

jobs:
  sync-incoming:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Fetch incoming branch
        run: |
          git fetch origin "${PHRASE_INCOMING_BRANCH}"

      - name: Prepare translated/ directory
        run: |
          echo "Clearing existing translated folder…"
          rm -rf "$TRANSLATED_DIR"
          mkdir -p "$TRANSLATED_DIR"

      - name: Copy all language folders from phrase-incoming
        run: |
          echo "Copying folders from ${PHRASE_INCOMING_BRANCH}…"

          # Extract files from the incoming branch tree
          git archive "${PHRASE_INCOMING_BRANCH}" | tar -x

          # Detect language folders: xx_xx/
          for lang in $(ls -d */ 2>/dev/null | grep -E "^[a-z]{2}_[a-z]{2}/"); do
            echo "Found language folder: $lang"
            mkdir -p "$TRANSLATED_DIR/$lang"
            cp -R "$lang" "$TRANSLATED_DIR/"
          done

          echo "Translated directory content:"
          ls -R "$TRANSLATED_DIR"

      - name: Commit translated files into main
        run: |
          git config --global user.name "github-actions"
          git config --global user.email actions@github.com

          git add "$TRANSLATED_DIR"

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Sync translated content from phrase-incoming"
          git push origin main
