name: Pull from Phrase Incoming Branch

on:
  workflow_dispatch:
  push:
    branches:
      - phrase-incoming

permissions:
  contents: write
  pull-requests: write

env:
  TRANSLATED_DIR: ${{ vars.TRANSLATED_DIR || 'translated' }}
  PHRASE_INCOMING_BRANCH: ${{ vars.PHRASE_INCOMING_BRANCH || 'phrase-incoming' }}

jobs:
  sync-incoming:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Fetch all branches
        run: |
          git fetch --all --prune
          echo "Available branches:"
          git branch -a

      - name: Overlay translated/ from phrase-incoming
        run: |
          echo "Overlaying translated/ from origin/${PHRASE_INCOMING_BRANCH}…"
          git checkout "origin/${PHRASE_INCOMING_BRANCH}" -- "${TRANSLATED_DIR}/"

          echo "Translated directory content:"
          ls -R "$TRANSLATED_DIR"

      - name: Commit translated files into main
        run: |
          git config --global user.name "github-actions"
          git config --global user.email actions@github.com

          git add "$TRANSLATED_DIR"

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Sync translated content from phrase-incoming"

          # NEW: Authenticate push with PAT to allow triggering other workflows
          git remote set-url origin https://${{ secrets.REPO2_TRIGGER_PAT }}@github.com/${{ github.repository }}.git

          git push origin main
