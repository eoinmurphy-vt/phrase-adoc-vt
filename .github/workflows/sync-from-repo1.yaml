name: Sync Changes from phrase-adoc-client

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes; adjust as needed
  workflow_dispatch:  # Allows manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.get-changes.outputs.changed_files }}
    steps:
      - name: Checkout phrase-adoc-vt
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Clone phrase-adoc-client
        run: |
          git clone https://github.com/e-murph/phrase-adoc-client.git temp_repo1  # Remove ${{ secrets.REPO1_READ_PAT }}@ if phrase-adoc-client is public
          cd temp_repo1
          git fetch origin

      - name: Get last synced commit from phrase-adoc-vt state
        id: get-last-commit
        run: |
          if [ -f .last_synced_commit ]; then
            LAST_COMMIT=$(cat .last_synced_commit)
          else
            LAST_COMMIT=""
          fi
          echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT

      - name: Get changed files since last sync
        working-directory: temp_repo1
        id: get-changes
        run: |
          CURRENT_COMMIT=$(git rev-parse HEAD)
          LAST_COMMIT="${{ steps.get-last-commit.outputs.last_commit }}"

          echo "Last synced commit: $LAST_COMMIT"
          echo "Current commit: $CURRENT_COMMIT"

          # Changed monitoring folder from 'updates/' to 'docs/' below
          if [ -z "$LAST_COMMIT" ]; then
            echo "No last commit recorded, listing all .adoc files under docs/"
            CHANGED_FILES=$(git ls-tree -r --name-only HEAD docs/ | grep '\.adoc$' || true)
            DELETED_FILES=""
          else
            echo "Diffing from $LAST_COMMIT to $CURRENT_COMMIT..."
            CHANGED_FILES=$(git diff --name-only "$LAST_COMMIT" "$CURRENT_COMMIT" -- docs/ | grep '\.adoc$' || true)
            DELETED_FILES=$(git diff --name-only --diff-filter=D "$LAST_COMMIT" "$CURRENT_COMMIT" -- docs/ | grep '\.adoc$' || true)
          fi

          echo "=== Final changed files list ==="
          echo "$CHANGED_FILES"
          echo "=== Final deleted files list ==="
          echo "$DELETED_FILES"

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "deleted_files<<EOF" >> $GITHUB_OUTPUT
          echo "$DELETED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT

      - name: Debug changed/deleted files output
        run: |
          echo "=== Changed files reported by get-changes ==="
          echo "${{ steps.get-changes.outputs.changed_files }}"
          echo "=== Deleted files reported by get-changes ==="
          echo "${{ steps.get-changes.outputs.deleted_files }}"

      - name: Copy changed files to source folder in phrase-adoc-vt
        if: steps.get-changes.outputs.changed_files != ''
        run: |
          mkdir -p source
          # Iterate line by line to preserve spaces and subfolders
          echo "${{ steps.get-changes.outputs.changed_files }}" | while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "temp_repo1/$file" ]; then
              mkdir -p "source/$(dirname "$file")"
              cp "temp_repo1/$file" "source/$file"
              echo "Copied $file"
            else
              echo "Skipping $file (not found or empty line)"
            fi
          done

      - name: Remove deleted files from source folder in phrase-adoc-vt
        if: steps.get-changes.outputs.deleted_files != ''
        run: |
          # Iterate line by line to preserve spaces in paths
          echo "${{ steps.get-changes.outputs.deleted_files }}" | while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "source/$file" ]; then
              rm -f "source/$file"
              echo "Removed source/$file"
            else
              echo "File source/$file not found; skipping removal."
            fi
          done

      - name: Debug source folder contents
        run: |
          echo "Workspace path:"
          pwd
          echo "Contents of source/ after copy/delete:"
          ls -R source/ 2>/dev/null || echo "source/ folder not found or empty."

      - name: Update last synced commit and commit changes to phrase-adoc-vt
        if: steps.get-changes.outputs.changed_files != '' || steps.get-changes.outputs.deleted_files != ''
        run: |
          echo "${{ steps.get-changes.outputs.current_commit }}" > .last_synced_commit
          git add source/ .last_synced_commit
          git commit -m "Synced changed .adoc files from phrase-adoc-client (including deletions)" || echo "No changes to commit"
          git remote set-url origin https://${{ secrets.REPO2_WRITE_PAT }}@github.com/eoinmurphy-vt/phrase-adoc-vt.git
          git push origin main  # Assume main branch; adjust if needed

      - name: Clean up
        run: rm -rf temp_repo1

      - name: Dispatch Preprocess Workflow
        if: steps.get-changes.outputs.changed_files != ''
        run: |
          CHANGED_FILES="${{ steps.get-changes.outputs.changed_files }}"
          PAYLOAD=$(jq -n --arg et "trigger-preprocess" --arg cf "$CHANGED_FILES" '{event_type: $et, client_payload: {changed_files: $cf}}')
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/eoinmurphy-vt/phrase-adoc-vt/dispatches \
            -d "$PAYLOAD"

