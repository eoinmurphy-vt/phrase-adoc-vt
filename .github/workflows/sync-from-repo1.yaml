name: Sync Changes from phrase-adoc-client

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes; adjust as needed
  workflow_dispatch:  # Allows manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.get-changes.outputs.changed_files }}
    steps:
      - name: Checkout phrase-adoc-vt
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Clone phrase-adoc-client
        run: |
          git clone https://github.com/e-murph/phrase-adoc-client.git temp_repo1  # Remove ${{ secrets.REPO1_READ_PAT }}@ if phrase-adoc-client is public
          cd temp_repo1
          git fetch origin

      - name: Get last synced commit from phrase-adoc-vt state
        id: get-last-commit
        run: |
          if [ -f .last_synced_commit ]; then
            LAST_COMMIT=$(cat .last_synced_commit)
          else
            LAST_COMMIT=""
          fi
          echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT

      - name: Get changed files since last sync
        working-directory: temp_repo1
        id: get-changes
        run: |
          CURRENT_COMMIT=$(git rev-parse HEAD)
          if [ -z "${{ steps.get-last-commit.outputs.last_commit }}" ]; then
            CHANGED_FILES=$(git ls-tree -r --name-only HEAD updates/)  # Path to outgoing folder in Repo1
          else
            CHANGED_FILES=$(git diff --name-only ${{ steps.get-last-commit.outputs.last_commit }} HEAD -- updates/)
          fi
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT

      - name: Copy changed files to source folder in phrase-adoc-vt
        if: steps.get-changes.outputs.changed_files != ''
        run: |
          mkdir -p source
          CHANGED_FILES="${{ steps.get-changes.outputs.changed_files }}"
          for file in $CHANGED_FILES; do
            cp temp_repo1/$file source/
          done

      - name: Update last synced commit and commit changes to phrase-adoc-vt
        if: steps.get-changes.outputs.changed_files != ''
        run: |
          echo "${{ steps.get-changes.outputs.current_commit }}" > .last_synced_commit
          git add source/ .last_synced_commit
          git commit -m "Synced changed files from phrase-adoc-client"
          git push origin main  # Assume main branch; adjust if needed

      - name: Clean up
        run: rm -rf temp_repo1
