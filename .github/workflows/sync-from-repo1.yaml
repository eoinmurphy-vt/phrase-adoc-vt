name: Sync Changes from phrase-adoc-client

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes; adjust as needed
  workflow_dispatch:  # Allows manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.get-changes.outputs.changed_files }}
    steps:
      - name: Checkout phrase-adoc-vt
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Clone phrase-adoc-client
        run: |
          git clone https://github.com/e-murph/phrase-adoc-client.git temp_repo1  # Remove ${{ secrets.REPO1_READ_PAT }}@ if phrase-adoc-client is public
          cd temp_repo1
          git fetch origin

      - name: Get last synced commit from phrase-adoc-vt state
        id: get-last-commit
        run: |
          if [ -f .last_synced_commit ]; then
            LAST_COMMIT=$(cat .last_synced_commit)
          else
            LAST_COMMIT=""
          fi
          echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT

      - name: Get changed files since last sync
        working-directory: temp_repo1
        id: get-changes
        run: |
          CURRENT_COMMIT=$(git rev-parse HEAD)
          if [ -z "${{ steps.get-last-commit.outputs.last_commit }}" ]; then
            CHANGED_FILES=$(git ls-tree -r --name-only HEAD updates/ | grep '\.adoc$')
            DELETED_FILES=""
          else
            DIFF_OUTPUT=$(git diff --name-status ${{ steps.get-last-commit.outputs.last_commit }} HEAD -- updates/)
            CHANGED_FILES=$(echo "$DIFF_OUTPUT" | awk '$1 != "D" {print $2}' | grep '\.adoc$' || true)
            DELETED_FILES=$(echo "$DIFF_OUTPUT" | awk '$1 == "D" {print $2}' | grep '\.adoc$' || true)
          fi
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "deleted_files<<EOF" >> $GITHUB_OUTPUT
          echo "$DELETED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT

      - name: Copy changed files to source folder in phrase-adoc-vt
        if: steps.get-changes.outputs.changed_files != ''
        run: |
          mkdir -p source
          CHANGED_FILES="${{ steps.get-changes.outputs.changed_files }}"
          # Preserve directory structure and handle spaces
          for file in $CHANGED_FILES; do
            cp --parents "temp_repo1/$file" source/
          done

      - name: Remove deleted files from source folder in phrase-adoc-vt
        if: steps.get-changes.outputs.deleted_files != ''
        run: |
          DELETED_FILES="${{ steps.get-changes.outputs.deleted_files }}"
          for file in $DELETED_FILES; do
            rm -f "source/$file" || echo "File source/$file not found; skipping removal."
          done

      - name: Update last synced commit and commit changes to phrase-adoc-vt
        if: steps.get-changes.outputs.changed_files != '' || steps.get-changes.outputs.deleted_files != ''
        run: |
          echo "${{ steps.get-changes.outputs.current_commit }}" > .last_synced_commit
          git add source/ .last_synced_commit
          git commit -m "Synced changed .adoc files from phrase-adoc-client (including deletions)" || echo "No changes to commit"
          git remote set-url origin https://${{ secrets.REPO2_WRITE_PAT }}@github.com/eoinmurphy-vt/phrase-adoc-vt.git
          git push origin main  # Assume main branch; adjust if needed

      - name: Clean up
        run: rm -rf temp_repo1

      - name: Dispatch Preprocess Workflow
        if: steps.get-changes.outputs.changed_files != ''
        run: |
          CHANGED_FILES="${{ steps.get-changes.outputs.changed_files }}"
          PAYLOAD=$(jq -n --arg et "trigger-preprocess" --arg cf "$CHANGED_FILES" '{event_type: $et, client_payload: {changed_files: $cf}}')
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/eoinmurphy-vt/phrase-adoc-vt/dispatches \
            -d "$PAYLOAD"

