name: Sync Changes from External Repo

on:
  schedule:
    # LIMITATION: Cron schedules cannot use variables. 
    # This must remain hardcoded.
    - cron: '*/15 * * * *'  
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    outputs:
      changed_files: ${{ steps.get-changes.outputs.changed_files }}
    steps:
      - name: Checkout Current Repo
        uses: actions/checkout@v4

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Clone External Repo
        run: |
          # Uses variable for External Repo URL
          EXT_REPO="${{ vars.EXTERNAL_REPO_URL }}"
          # Fallback if variable is empty
          if [ -z "$EXT_REPO" ]; then EXT_REPO="e-murph/phrase-adoc-client"; fi
          
          git clone "https://github.com/$EXT_REPO.git" temp_repo1
          cd temp_repo1
          git fetch origin

      - name: Get last synced commit
        id: get-last-commit
        run: |
          if [ -f .last_synced_commit ]; then
            LAST_COMMIT=$(cat .last_synced_commit)
          else
            LAST_COMMIT=""
          fi
          echo "last_commit=$LAST_COMMIT" >> $GITHUB_OUTPUT

      - name: Get changed files since last sync
        working-directory: temp_repo1
        id: get-changes
        env:
          # Uses variable for Watch Path
          WATCH_PATH: ${{ vars.EXTERNAL_WATCH_PATH }}
        run: |
          CURRENT_COMMIT=$(git rev-parse HEAD)
          LAST_COMMIT="${{ steps.get-last-commit.outputs.last_commit }}"
          
          # Default if variable is missing
          if [ -z "$WATCH_PATH" ]; then WATCH_PATH="docs/5.4/modules/en/"; fi

          echo "Watching path: $WATCH_PATH"
          echo "Last synced commit: $LAST_COMMIT"
          echo "Current commit: $CURRENT_COMMIT"

          if [ -z "$LAST_COMMIT" ]; then
            echo "No last commit recorded, listing all .adoc files under $WATCH_PATH"
            CHANGED_FILES=$(git ls-tree -r --name-only HEAD "$WATCH_PATH" | grep '\.adoc$' || true)
            DELETED_FILES=""
          else
            echo "Diffing from $LAST_COMMIT to $CURRENT_COMMIT..."
            CHANGED_FILES=$(git diff --name-only "$LAST_COMMIT" "$CURRENT_COMMIT" -- "$WATCH_PATH" | grep '\.adoc$' || true)
            DELETED_FILES=$(git diff --name-only --diff-filter=D "$LAST_COMMIT" "$CURRENT_COMMIT" -- "$WATCH_PATH" | grep '\.adoc$' || true)
          fi

          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "deleted_files<<EOF" >> $GITHUB_OUTPUT
          echo "$DELETED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "current_commit=$CURRENT_COMMIT" >> $GITHUB_OUTPUT

      - name: Debug Output
        run: |
          echo "Changed: ${{ steps.get-changes.outputs.changed_files }}"
          echo "Deleted: ${{ steps.get-changes.outputs.deleted_files }}"

      - name: Copy changed files to source folder
        if: steps.get-changes.outputs.changed_files != ''
        env:
          TARGET_DIR: ${{ vars.CONTENT_DIR || 'source' }}
        run: |
          mkdir -p "$TARGET_DIR"
          echo "${{ steps.get-changes.outputs.changed_files }}" | while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "temp_repo1/$file" ]; then
              mkdir -p "$TARGET_DIR/$(dirname "$file")"
              cp "temp_repo1/$file" "$TARGET_DIR/$file"
              echo "Copied $file"
            fi
          done

      - name: Remove deleted files from source folder
        if: steps.get-changes.outputs.deleted_files != ''
        env:
          TARGET_DIR: ${{ vars.CONTENT_DIR || 'source' }}
        run: |
          echo "${{ steps.get-changes.outputs.deleted_files }}" | while IFS= read -r file; do
            if [ -n "$file" ] && [ -f "$TARGET_DIR/$file" ]; then
              rm -f "$TARGET_DIR/$file"
              echo "Removed $TARGET_DIR/$file"
            fi
          done

      - name: Update last synced commit and push
        if: steps.get-changes.outputs.changed_files != '' || steps.get-changes.outputs.deleted_files != ''
        env:
          TARGET_DIR: ${{ vars.CONTENT_DIR || 'source' }}
          CURRENT_REPO: ${{ vars.CURRENT_REPO_NAME || 'eoinmurphy-vt/phrase-adoc-vt' }}
        run: |
          echo "${{ steps.get-changes.outputs.current_commit }}" > .last_synced_commit
          git add "$TARGET_DIR/" .last_synced_commit
          git commit -m "Synced changes from external repo" || echo "No changes to commit"
          
          # Push using PAT and Variable for Repo Name
          git remote set-url origin https://${{ secrets.REPO2_WRITE_PAT }}@github.com/$CURRENT_REPO.git
          git push origin main

      - name: Clean up
        run: rm -rf temp_repo1

      - name: Dispatch Preprocess Workflow
        if: steps.get-changes.outputs.changed_files != ''
        env:
          CURRENT_REPO: ${{ vars.CURRENT_REPO_NAME || 'eoinmurphy-vt/phrase-adoc-vt' }}
        run: |
          CHANGED_FILES="${{ steps.get-changes.outputs.changed_files }}"
          PAYLOAD=$(jq -n --arg et "trigger-preprocess" --arg cf "$CHANGED_FILES" '{event_type: $et, client_payload: {changed_files: $cf}}')
          
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/$CURRENT_REPO/dispatches" \
            -d "$PAYLOAD"