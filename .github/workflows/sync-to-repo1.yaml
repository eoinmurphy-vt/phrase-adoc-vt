name: Sync Processed Files to phrase-adoc-client

on:
  push:
    paths:
      - 'final/**'  # Trigger on changes to outgoing folder in Repo2
  repository_dispatch:
    types: [trigger-sync-to-repo1]
  workflow_dispatch:

jobs:
  sync-back:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout phrase-adoc-vt
        uses: actions/checkout@v4

      - name: Debug Final Folder Contents
        run: |
          echo "Contents of final/ after checkout:"
          ls -R final/ 2>/dev/null || echo "final/ folder not found or empty."

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email github-actions@github.com

      - name: Clone phrase-adoc-client for writing
        run: |
          git clone https://${{ secrets.REPO1_WRITE_PAT }}@github.com/e-murph/phrase-adoc-client.git temp_repo1
          cd temp_repo1
          git remote set-url origin https://${{ secrets.REPO1_WRITE_PAT }}@github.com/e-murph/phrase-adoc-client.git
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@' || echo "main")
          echo "Detected default branch: $DEFAULT_BRANCH"
          git checkout $DEFAULT_BRANCH

      - name: Copy processed files to phrase-adoc-client
        run: |
          mkdir -p temp_repo1/docs/
          
          # Fix for double nesting: Check if 'final' contains a 'docs' subfolder
          if [ -d "final/docs" ]; then
             echo "Detected nested 'docs' folder in 'final'. Syncing content of 'final/docs/' to 'temp_repo1/docs/'..."
             # IMPORTANT: Removed --delete to ensure we merge languages, not replace them
             rsync -a final/docs/ temp_repo1/docs/
             echo "Copied files (nested structure corrected)"
          elif [ -d "final" ] && find final -type f 2>/dev/null | grep . > /dev/null 2>&1; then
             echo "No nested 'docs' folder found. Syncing content of 'final/' to 'temp_repo1/docs/'..."
             # IMPORTANT: Removed --delete to ensure we merge languages, not replace them
             rsync -a final/ temp_repo1/docs/
             echo "Copied files from final/ to docs/"
          else
             echo "No files in final/ to copy (or folder missing); skipping."
          fi

      - name: Commit and push to phrase-adoc-client
        working-directory: temp_repo1
        run: |
          # Add the 'docs' folder specifically
          git add docs/
          
          if git commit -m "Added processed files from phrase-adoc-vt to docs folder"; then
            MAX_ATTEMPTS=10
            ATTEMPT=1
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "Attempt $ATTEMPT: rebasing and pushing..."
              git fetch origin main
              if ! git rebase origin/main; then
                echo "Rebase failed, aborting."
                exit 1
              fi
              if git push --force-with-lease origin main; then
                echo "Push succeeded on attempt $ATTEMPT."
                break
              else
                echo "Push failed on attempt $ATTEMPT. Retrying..."
                ATTEMPT=$((ATTEMPT+1))
                sleep 10
              fi
            done
            if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
              echo "Failed to push after $MAX_ATTEMPTS attempts."
              exit 1
            fi
          else
            echo "No changes to commit"
          fi

      - name: Clean up
        run: rm -rf temp_repo1