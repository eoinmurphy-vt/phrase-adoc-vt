name: Sync Processed Files to phrase-adoc-client

on:
  push:
    paths:
      - 'final/**'  # Trigger on changes to outgoing folder in Repo2
  repository_dispatch:
    types: [trigger-sync-to-repo1]
  workflow_dispatch:

jobs:
  sync-back:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout phrase-adoc-vt
        uses: actions/checkout@v4

      - name: Debug Final Folder Contents
        run: |
          echo "Contents of final/ after checkout:"
          ls -R final/ 2>/dev/null || echo "final/ folder not found or empty."

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "github-actions@github.com"

      - name: Clone phrase-adoc-client for writing
        run: |
          git clone https://${{ secrets.REPO1_WRITE_PAT }}@github.com/e-murph/phrase-adoc-client.git temp_repo1  # Use PAT for authenticated write access
          cd temp_repo1
          git remote set-url origin https://${{ secrets.REPO1_WRITE_PAT }}@github.com/e-murph/phrase-adoc-client.git  # Explicitly set for push
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@' || echo "main")  # Fallback to 'main' if detection fails
          echo "Detected default branch: $DEFAULT_BRANCH"
          git checkout $DEFAULT_BRANCH

      - name: Copy processed files to phrase-adoc-client
        run: |
          mkdir -p temp_repo1/final/  # Incoming folder in Repo1
          if [ -d "../final" ] && find ../final -type f 2>/dev/null | grep . > /dev/null 2>&1; then  # Check if folder exists and has files
            cp -r ../final/* temp_repo1/final/
            echo "Copied files from final/ (including subdirs)"
          else
            echo "No files in final/ to copy (or folder missing); skipping."
          fi

      - name: Commit and push to phrase-adoc-client
        working-directory: temp_repo1
        run: |
          git add final/
          COMMITTED=false
          git commit -m "Added processed files from phrase-adoc-vt" && COMMITTED=true || echo "No changes to commit"
          if [ "$COMMITTED" = "true" ]; then
            git push origin $(git symbolic-ref --short HEAD)  # Push to current branch
          else
            echo "No push needed as there were no changes."
          fi

      - name: Clean up
        run: rm -rf temp_repo1
