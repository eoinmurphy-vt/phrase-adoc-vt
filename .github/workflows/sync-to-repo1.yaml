name: Sync Processed Files to External Repo

on:
  push:
    # LIMITATION: 'paths' cannot use variables.
    paths:
      - 'final/**'  
  repository_dispatch:
    types: [trigger-sync-to-repo1]
  workflow_dispatch:

jobs:
  sync-back:
    runs-on: ubuntu-latest
    env:
      # Configuration via Variables
      FINAL_DIR: ${{ vars.FINAL_DIR || 'final' }}
      EXT_REPO: ${{ vars.EXTERNAL_REPO_URL || 'e-murph/phrase-adoc-client' }}
      EXT_TARGET_DIR: ${{ vars.EXTERNAL_TARGET_DIR || 'docs' }} # e.g., 'docs'

    steps:
      - name: Checkout Current Repo
        uses: actions/checkout@v4

      - name: Debug Final Folder Contents
        run: |
          echo "Contents of $FINAL_DIR/ after checkout:"
          ls -R "$FINAL_DIR/" 2>/dev/null || echo "$FINAL_DIR/ folder not found or empty."

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email github-actions@github.com

      - name: Clone External Repo for writing
        run: |
          # Use Variable for External Repo
          git clone "https://${{ secrets.REPO1_WRITE_PAT }}@github.com/$EXT_REPO.git" temp_repo1
          
          cd temp_repo1
          git remote set-url origin "https://${{ secrets.REPO1_WRITE_PAT }}@github.com/$EXT_REPO.git"
          
          DEFAULT_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD | sed 's@^refs/remotes/origin/@@' || echo "main")
          echo "Detected default branch: $DEFAULT_BRANCH"
          git checkout $DEFAULT_BRANCH

      - name: Copy processed files to External Repo
        run: |
          # Ensure target folder exists in external repo
          mkdir -p "temp_repo1/$EXT_TARGET_DIR/"
          
          # Fix for double nesting logic using variables
          if [ -d "$FINAL_DIR/$EXT_TARGET_DIR" ]; then
              echo "Detected nested '$EXT_TARGET_DIR' folder in '$FINAL_DIR'. Syncing content..."
              rsync -a "$FINAL_DIR/$EXT_TARGET_DIR/" "temp_repo1/$EXT_TARGET_DIR/"
              echo "Copied files (nested structure corrected)"
          elif [ -d "$FINAL_DIR" ] && find "$FINAL_DIR" -type f 2>/dev/null | grep . > /dev/null 2>&1; then
              echo "No nested '$EXT_TARGET_DIR' folder found. Syncing content of '$FINAL_DIR/' to 'temp_repo1/$EXT_TARGET_DIR/'..."
              rsync -a "$FINAL_DIR/" "temp_repo1/$EXT_TARGET_DIR/"
              echo "Copied files from $FINAL_DIR/ to $EXT_TARGET_DIR/"
          else
              echo "No files in $FINAL_DIR/ to copy (or folder missing); skipping."
          fi

      - name: Commit and push to External Repo
        working-directory: temp_repo1
        run: |
          # Add the target folder specifically
          git add "$EXT_TARGET_DIR/"
          
          if git commit -m "Added processed files from translation pipeline"; then
            MAX_ATTEMPTS=10
            ATTEMPT=1
            while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
              echo "Attempt $ATTEMPT: rebasing and pushing..."
              git fetch origin
              # Detect branch again or hardcode if preferred (using HEAD here is safer)
              BRANCH=$(git rev-parse --abbrev-ref HEAD)
              
              if ! git rebase "origin/$BRANCH"; then
                echo "Rebase failed, aborting."
                exit 1
              fi
              
              if git push --force-with-lease origin "$BRANCH"; then
                echo "Push succeeded on attempt $ATTEMPT."
                break
              else
                echo "Push failed on attempt $ATTEMPT. Retrying..."
                ATTEMPT=$((ATTEMPT+1))
                sleep 10
              fi
            done
            if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
              echo "Failed to push after $MAX_ATTEMPTS attempts."
              exit 1
            fi
          else
            echo "No changes to commit"
          fi

      - name: Clean up
        run: rm -rf temp_repo1