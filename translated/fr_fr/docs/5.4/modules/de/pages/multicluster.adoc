= Gestion multi-cluster d'entreprise
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /04.navigation/02.multicluster/02.multicluster.md
:page-opendocs-slug:  /navigation/multicluster

== Enterprise-Konsole

La {product-name} console peut être utilisée pour gérer de grandes déploiements multi-cluster et multi-cloud. Un cluster doit être sélectionné comme cluster principal, et d'autres clusters distants peuvent alors se connecter au cluster principal. Une fois la connexion établie, le cluster principal peut transmettre des règles fédérées à chaque cluster distant, qui seront affichées dans les consoles de chaque cluster distant comme des règles fédérées. Les enregistrements fédérés scannés synchroniseront également les résultats de scan avec les clusters distants. Seuls les utilisateurs locaux et les utilisateurs Rancher avec des droits d'administrateur peuvent promouvoir un cluster en tant que cluster principal.

En plus de la politique fédérée, la gestion multi-cluster prend en charge la surveillance de chaque cluster distant sur une page de résumé, comme indiqué ci-dessous.

image:multicluster_summary.png[Zusammenfassung]

Il DOIT y avoir une connexion réseau entre les contrôleurs de chaque cluster via les ports requis. Le contrôleur est exposé à l'extérieur de son cluster soit par un service principal, soit par un service distant, comme le montre l'exemple du document YAML de déploiement {product-name}.

== Configuration des clusters principal et distants

Connectez-vous à la console du cluster qui sera le cluster principal. Sélectionnez plusieurs clusters dans le menu déroulant en haut à droite, puis promouvez pour configurer le cluster principal. Remarque : Seuls les utilisateurs locaux et les utilisateurs Rancher avec des droits d'administrateur peuvent promouvoir un cluster en tant que cluster principal. Actuellement, les utilisateurs SSO/LDAP/OIDC avec un rôle d'administrateur ne peuvent pas promouvoir un cluster en tant que cluster principal.
image:master1.png[MasterConfig]

Entrez l'IP publique et le port du service fed-master. Vous pouvez le trouver en

[,shell]
----
kubectl get svc -n neuvector
----

La sortie ressemble à ceci :

[,shell]
----
NAME                                      TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                         AGE
neuvector-service-controller-fed-master   LoadBalancer   10.27.249.147   35.238.131.23    11443:31878/TCP                 17d
neuvector-service-controller-fed-worker   LoadBalancer   10.27.251.1     35.226.199.111   10443:32736/TCP                 17d
----

Dans l'exemple ci-dessus, l'adresse IP/hostname du contrôleur principal est 35.238.131.23 et le port est 11443. Remarque : Assurez-vous que cette adresse IP et le port sont accessibles de l'extérieur (des clusters distants). Remarque : Les horloges système (temps) doivent être identiques pour chaque cluster principal et distant afin de fonctionner correctement.

Après vous être reconnecté à la console, sélectionnez à nouveau "Plusieurs clusters" dans le menu en haut à droite et cliquez sur l'icône pour générer un jeton nécessaire pour connecter les clusters distants. Copiez le jeton pour l'étape suivante. Le jeton est valide pendant environ 1 heure et doit être régénéré s'il a expiré pour connecter des clusters distants à l'avenir.

image:master_token.png[Token]

Pour connecter un cluster distant au principal, connectez-vous en tant qu'administrateur dans la console du cluster distant. Sélectionnez "Plusieurs clusters" dans le menu déroulant en haut à droite et cliquez sur "Rejoindre". Entrez l'adresse IP du contrôleur ou le nom d'hôte pour le cluster distant ainsi que le port. Vous pouvez récupérer ces informations à nouveau depuis le cluster distant en procédant comme suit :

[,shell]
----
kubectl get svc -n neuvector
----

Utilisez la sortie pour le fed-worker du cluster distant pour configurer l'adresse IP et le port. Ensuite, entrez le jeton copié depuis le système principal. Notez qu'après avoir saisi le jeton, l'adresse IP et le port pour le système principal seront automatiquement remplis, mais cela peut être modifié ou saisi manuellement.

image:join_remote.png[JoinRemote]

Déconnectez-vous du cluster distant et reconnectez-vous au système principal. Ou si vous êtes déjà connecté, cliquez sur Actualiser, et le cluster distant sera listé dans le menu "Plusieurs clusters".

image:fed_master_list.png[FedMaster]

Vous pouvez cliquer sur l'icône de gestion dans la liste ou utiliser le menu déroulant pour plusieurs clusters en haut pour basculer entre les clusters à tout moment. Une fois que vous avez basculé vers un cluster distant, tous les éléments de menu à gauche s'appliquent maintenant au cluster distant.

== Dépannage

Pour s'assurer que les services réagissent comme prévu, vous pouvez exécuter les tests depuis l'extérieur des clusters ou, si nécessaire, depuis les pods de test dans les clusters `+fed-master+` et `+fed-managed+` pour vous assurer que la connexion réseau entre les clusters est autorisée.

=== Vérifiez le service fed-master

Le port de service du cluster `+11443+` n'est accessible qu'après activation du service `+fed-master+`. La commande suivante renvoie un code d'erreur si le service `+fed-master+` répond, indiquant que la ressource demandée n'est pas disponible.

.Beispielausgabe
[,shell]
----
{"code":1,"error":"URL not found","message":"URL not found"}
----

[IMPORTANT]
====
L'URL pour la commande `+curl+` dépend de la manière dont les services `+fed-master+` sont fournis. Si un service `+ingress+` est configuré, il n'est pas nécessaire de spécifier un port.
====

[,shell]
----
curl -v https://<fed-master>[:<port>]/v1/eula
----

=== Vérifiez le service fed-managed

Le port de service du cluster `+10443+` est partagé entre `+REST API+` et le service `+fed-managed+`. La commande suivante renvoie un code de succès si le service `+fed-managed+` répond, indiquant qu'il est disponible.

.Beispielausgabe
[,shell]
----
{"eula":{"accepted":true}})
----

[IMPORTANT]
====
L'URL pour la commande `+curl+` dépend de la manière dont les services `+fed-managed+` sont fournis. Si un service `+ingress+` est configuré, il n'est pas nécessaire de spécifier un port.
====

[,shell]
----
curl -v https://<fed-managed>[:<port>]/v1/eula
----

== Föderierte Richtlinie

Veuillez consulter la section sur la politique fédérée -> pour des instructions sur la création de règles fédérées qui seront transférées dans chaque cluster.

== Registries fédérées pour les résultats distribués des analyses d'images

Le cluster principal (Master) peut scanner un registre/repo appelé registre fédéré. Les résultats des analyses provenant de ces registries sont synchronisés avec tous les clusters gérés (distants). Cela permet d'afficher les résultats des analyses dans la console du cluster géré ainsi que d'utiliser les résultats dans les règles de contrôle d'admission du cluster géré. Les registries doivent être scannées une seule fois, plutôt que par chaque cluster, réduisant ainsi l'utilisation du CPU/mémoire et de la bande passante réseau.

Les registries fédérées ne peuvent être configurées que par un administrateur fédéré dans le cluster principal dans les actifs -> registries. Après avoir ajouté et scanné un dépôt fédéré, les résultats des analyses sont synchronisés avec tous les clusters gérés. Règles de contrôle d'admission dans chaque cluster géré qui nécessitent des analyses d'images (z. B. CVE, les règles basées sur la conformité utilisent automatiquement à la fois les résultats de scan fédérés et les résultats de scan de registre configurés localement.

=== Fédérer les résultats des scanners CI/CD (Optionnel)

Les résultats de scan de registre fédérés sont toujours synchronisés avec les clusters gérés, comme décrit ci-dessus. Le cluster principal peut également recevoir des résultats de scan xref:scanners.adoc#_standalone_scanner_for_local_scanning[de scans de scanners autonomes] ou des plugins de scanner appelés depuis un pipeline de build CI/CD. Pour synchroniser également les résultats du scan de dépôt dans la phase de build (CI/CD) avec les clusters gérés, activez cela d'abord en modifiant les paramètres du cluster principal (Master) comme indiqué ci-dessous.

image:fed_primary_config.png[master_settings]

image:fed_reg_sync.png[fed_sync]
