= Gestion d'entreprise Multi-Cluster
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /04.navigation/02.multicluster/02.multicluster.md
:page-opendocs-slug:  /navigation/multicluster

== Unternehmenskonsole

La console {product-name} peut être utilisée pour gérer de grandes implémentations Multi-Cluster et Multi-Cloud. Un cluster doit être sélectionné comme cluster principal, et d'autres clusters distants peuvent alors se connecter au cluster principal. Une fois connecté, le cluster principal peut pousser des règles fédérées à chaque cluster distant, qui seront affichées comme des règles fédérées dans les consoles de chaque cluster distant. Les registres fédérés scannés synchronisent également les résultats de scan avec les clusters distants. Seuls les utilisateurs locaux et les utilisateurs Rancher avec des droits d'administrateur peuvent promouvoir un cluster en tant que cluster principal.

En plus de la politique fédérée, la gestion Multi-Cluster prend en charge la surveillance de chaque cluster distant sur une page de résumé, comme indiqué ci-dessous.

image:multicluster_summary.png[Résumé]

Il DOIT y avoir une connexion réseau entre les contrôleurs de chaque cluster via les ports requis. Le contrôleur est exposé via un service principal ou distant en dehors de son cluster, comme le montre l'exemple de déploiement yaml {product-name}.

== Configuration des clusters principal et distant

Connectez-vous à la console du cluster qui sera le cluster principal. Sélectionnez plusieurs clusters dans le menu déroulant en haut à droite, puis cliquez sur Promouvoir pour configurer le cluster principal. Remarque : Seuls les utilisateurs locaux et les utilisateurs Rancher avec des droits d'administrateur peuvent promouvoir un cluster en tant que cluster principal. Actuellement, les utilisateurs SSO/LDAP/OIDC avec un rôle d'administrateur ne peuvent pas promouvoir un cluster en tant que cluster principal.
image:master1.png[MasterConfig]

Entrez l'IP publique et le port du service fed-master. Vous pouvez le trouver en exécutant

[,shell]
----
kubectl get svc -n neuvector
----

La sortie ressemblera à :

[,shell]
----
NAME                                      TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                         AGE
neuvector-service-controller-fed-master   LoadBalancer   10.27.249.147   35.238.131.23    11443:31878/TCP                 17d
neuvector-service-controller-fed-worker   LoadBalancer   10.27.251.1     35.226.199.111   10443:32736/TCP                 17d
----

Dans l'exemple ci-dessus, le nom d'hôte/IP du contrôleur principal est 35.238.131.23 et le port est 11443. Remarque : Assurez-vous que cette adresse IP et ce port sont accessibles de l'extérieur (des clusters distants). Remarque : Les horloges système (temps) doivent être identiques pour chaque cluster principal et distant afin de fonctionner correctement.

Après vous être reconnecté à la console, sélectionnez à nouveau "Plusieurs Clusters" dans le menu en haut à droite et cliquez sur l'icône pour générer un jeton nécessaire pour connecter les clusters distants. Copiez le jeton pour l'utiliser à l'étape suivante. Le jeton est valide pendant environ 1 heure, et s'il expire, il doit être régénéré pour connecter de futurs clusters distants.

image:master_token.png[Token]

Pour vous connecter à un cluster distant avec le cluster principal, connectez-vous en tant qu'administrateur à la console du cluster distant. Sélectionnez Plusieurs Clusters dans le menu déroulant en haut à droite, et cliquez sur Rejoindre. Entrez l'IP ou le nom d'hôte du contrôleur pour le cluster distant ainsi que le port. Encore une fois, vous pouvez obtenir ces informations du cluster distant en procédant comme suit :

[,shell]
----
kubectl get svc -n neuvector
----

Utilisez la sortie pour le fed-worker du cluster distant pour configurer l'adresse IP et le port. Ensuite, entrez le jeton copié depuis le principal. Notez qu'après avoir saisi le jeton, l'adresse IP et le port pour le cluster principal seront automatiquement remplis, mais cela peut être modifié ou saisi manuellement.

image:join_remote.png[JoinRemote]

Déconnectez-vous du cluster distant et reconnectez-vous au principal. Ou si vous êtes déjà connecté, cliquez sur "Actualiser" et le cluster distant sera répertorié dans le menu "Plusieurs Clusters".

image:fed_master_list.png[FedMaster]

Vous pouvez cliquer sur l'icône d'administration dans la liste ou utiliser le menu déroulant pour plusieurs clusters en haut pour basculer entre les clusters à tout moment. Une fois que vous avez basculé vers un cluster distant, tous les éléments du menu à gauche s'appliquent maintenant au cluster distant.

== Dépannage

Pour s'assurer que les services réagissent comme prévu, vous pouvez exécuter les tests depuis l'extérieur des clusters ou, si nécessaire, depuis les pods de test sur les clusters `+fed-master+` et `+fed-managed+`, pour vous assurer que la connexion réseau entre les clusters est autorisée.

=== Vérifiez le service fed-master

Le port de service du cluster `+11443+` n'est accessible qu'après activation du service `+fed-master+`. La commande suivante renvoie un code d'erreur si le service `+fed-master+` répond, pour indiquer que la ressource demandée n'est pas disponible.

.Beispielausgabe
[,shell]
----
{"code":1,"error":"URL not found","message":"URL not found"}
----

[IMPORTANT]
====
L'URL pour la commande `+curl+` dépend de la manière dont le service `+fed-master+` est déployé. Si un service `+ingress+` est configuré, il n'est pas nécessaire de spécifier un port.
====

[,shell]
----
curl -v https://<fed-master>[:<port>]/v1/eula
----

=== Vérifiez le service fed-managed

Le port de service du cluster `+10443+` est partagé entre `+REST API+` et le service `+fed-managed+`. La commande suivante renvoie un code de succès si le service `+fed-managed+` répond, pour indiquer qu'il est disponible.

.Beispielausgabe
[,shell]
----
{"eula":{"accepted":true}})
----

[IMPORTANT]
====
L'URL pour la commande `+curl+` dépend de la manière dont le service `+fed-managed+` est déployé. Si un service `+ingress+` est configuré, il n'est pas nécessaire de spécifier un port.
====

[,shell]
----
curl -v https://<fed-managed>[:<port>]/v1/eula
----

== Politique fédérée

Veuillez consulter la section Politique -> Politique fédérée pour des instructions sur la création de règles fédérées à transmettre à chaque cluster.

== Registres fédérés pour les résultats de numérisation d'images distribuées

Le cluster principal (maître) peut scanner un registre/dépôt désigné comme registre fédéré. Les résultats de numérisation de ces registres sont synchronisés avec tous les clusters gérés (distants). Cela permet d'afficher les résultats de numérisation dans la console du cluster géré ainsi que d'utiliser les résultats dans les règles d'admission du cluster géré. Les registres doivent être scannés une seule fois, au lieu de chaque cluster, réduisant ainsi l'utilisation du CPU/mémoire et de la bande passante réseau.

Les registres fédérés ne peuvent être configurés que par un administrateur fédéré dans le cluster principal dans les actifs -> Registre. Après qu'un dépôt fédéré a été ajouté et scanné, les résultats de numérisation sont synchronisés avec tous les clusters gérés. Les règles d'admission dans chaque cluster géré qui nécessitent une numérisation d'image (z. B. Les CVE, les règles basées sur la conformité), utilisent automatiquement à la fois les résultats des analyses fédérées et les résultats des analyses de registre configurées localement.

=== Fédération des résultats des analyseurs CI/CD (optionnel)

Les résultats des analyses de registre fédérées sont toujours synchronisés avec les clusters gérés, comme décrit ci-dessus. Le cluster principal peut également recevoir des résultats d'analyse xref:scanners.adoc#_standalone_scanner_for_local_scanning[de scanners autonomes] ou des plugins de scanner appelés à partir d'un pipeline de construction CI/CD. Pour synchroniser également les résultats d'analyse du dépôt de phase de construction (CI/CD) avec les clusters gérés, activez cela d'abord en modifiant les paramètres du cluster principal (Master) comme indiqué ci-dessous.

image:fed_primary_config.png[master_settings]

image:fed_reg_sync.png[fed_sync]
