= OpenID Connect Azure/Okta
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /08.integration/07.openid/07.openid.md
:page-opendocs-slug:  /integration/openid

== Intégration avec OpenID Connect (OIDC) pour Azure et Okta

Pour activer l'authentification OpenID Connect, les paramètres *Émetteur*, *ID client* et *Secret client* sont requis. Avec l'URL de l'émetteur, {product-name} appellera l'API de découverte pour récupérer les points de terminaison d'authentification, de jeton et d'informations utilisateur.

Localisez l'URI de redirection OpenID Connect en haut de la page des paramètres OpenID Connect {product-name}. Vous devrez copier cet URI dans les *URI de redirection de connexion* pour Okta et *URLs de réponse* pour Microsoft Azure.

image:openid1.png[OpenID1]

=== Microsoft Azure Configuration

Dans Azure Active Directory > Enregistrements d'application > Nom de l'application > Page des paramètres, localisez la chaîne ID de l'application. Ceci est utilisé pour définir l'ID client dans {product-name}. Le secret client peut être localisé dans les paramètres des clés d'Azure.

image:openid3.png[OpenID3]

L'URL de l'émetteur prend le format "https://login.microsoftonline.com/{tenantID}/v2.0". Pour localiser le tenantID, allez à menu:Azure Active Directory[Page des propriétés] et trouvez l'ID du répertoire, remplacez-le par le tenantID dans l'URL.

image:openid4.png[OpenID4]

Si les utilisateurs sont assignés aux groupes dans l'annuaire actif, leur appartenance à un groupe peut être ajoutée à la revendication. Trouvez l'application dans *Azure Active Directory -> Enregistrements d'application* et modifiez le manifeste. Modifiez la valeur de "groupMembershipClaims" en "Groupe d'application".  Il y a un nombre maximum de groupes qui seront émis dans un jeton.  Si l'utilisateur appartient à un grand nombre de groupes (> 200) et que la valeur "Tous" est utilisée, le jeton n'inclura pas les groupes et l'autorisation échouera.  Utiliser la valeur "Groupe d'application" au lieu de "Tous" réduira le nombre de groupes applicables retournés dans le jeton.

Par défaut, {product-name} recherche des "groupes" dans la revendication pour identifier l'appartenance de l'utilisateur au groupe. Si un autre nom de revendication est utilisé, vous pouvez personnaliser le nom de la revendication dans la page des paramètres OpenID Connect de {product-name}.

La revendication de groupe renvoyée par Azure est identifiée par l'"ID d'objet" au lieu du nom. L'ID d'objet du groupe peut être localisé dans menu:Azure Active Directory[Groupes > Page du nom du groupe]. Vous devez utiliser cette valeur pour configurer le mappage de rôle basé sur le groupe dans les paramètres de {product-name} ->.

image:openid5.png[OpenID5]

==== Vérifier les autorisations

Assurez-vous que les autorisations suivantes ont été définies à partir de Microsoft Graph

. email - Voir l'adresse e-mail des utilisateurs
. openid - Connecter les utilisateurs
. profile - Voir le profil de base des utilisateurs

=== Okta Configuration

Connectez-vous à votre compte Okta.

Dans le menu à gauche, cliquez sur "`+Applications -> Applications"+`
Dans le panneau central, cliquez sur &quot;`+Create App Integration+`&quot;:

image:okta1.png[créer]

Un nouveau panneau apparaîtra pour sélectionner le &quot;`+Sign-in method+`&quot;:

image:okta2.png[nouvelleapp]

Sélectionnez l'option &quot;`+OIDC -- OpenID Connect+`&quot;.

Un panneau dérivé apparaîtra, pour la sélection de &quot;`+Application Type+`&quot;:

image:okta3.png[typeapp]

Sélectionnez l'option &quot;`+Native Application+`&quot;.

Le panneau central affichera maintenant le formulaire d'intégration de l'application native où vous devez remplir les valeurs suivantes :

Pour la section Paramètres généraux :

Application. Nom de l'intégration : Nom pour cette intégration. Choisissez librement n'importe quel nom Type de grant (cochez) :

* Code d'autorisation
* Jeton d'actualisation
* Mot de passe du propriétaire des ressources
* Implicite (hybride)

Pour la section des URI de redirection de connexion :

Allez sur votre console {product-name} et naviguez vers &quot;`+Settings+`&quot; -> &quot;`+OpenId Connect Settings+`&quot;.  En haut de la page, à côté de l'étiquette &quot;`+OpenID Connect Redirect URI+`&quot;, cliquez sur &quot;`+Copy to Clipboard+`&quot;.

image:okta4.png[copy]

Cela copiera l'URI de redirection dans la mémoire.
Collez-le dans sa zone de texte correspondante :

image:okta5.png[coller]

Pour la section Assignations :

Sélectionnez &quot;`+Allow everyone in your organization to access+`&quot; pour rendre cette intégration disponible pour tout le monde dans votre organisation.

image:okta6.png[assignations]

Ensuite, cliquez sur le bouton enregistrer en bas de la page.

Une fois vos paramètres généraux enregistrés, vous serez dirigé vers la configuration de votre nouvelle intégration d'application et un identifiant client sera généré automatiquement.

Dans la section &quot;`+Client Credentials+`&quot;, cliquez sur modifier et modifiez la section &quot;`+Client Authentication+`&quot; de &quot;`+Use PKCE (for public clients)+`&quot; à &quot;`+Use Client Authentication+`&quot;, puis cliquez sur enregistrer. Cela générera automatiquement un nouveau secret dont nous aurons besoin dans les prochaines étapes de configuration {product-name} :

image:okta7.png[clientauth]

Accédez à l'onglet &quot;`+Sign On+`&quot; et modifiez la section &quot;`+OpenID Connect ID Token+`&quot; :
Changez l'émetteur de &quot;`+Dynamic (based on request domain)+`&quot; à &quot;`+Okta URL+`&quot; fixe :

image:okta8.png[token]

La console Okta peut fonctionner en deux modes, Mode Classique et Mode Développeur.
En mode classique, l'URL de l'émetteur se trouve dans l'onglet Se connecter de la page d'application Okta. Pour que l'appartenance du groupe de l'utilisateur soit renvoyée dans la revendication, vous devez ajouter le champ "groups" dans la page de configuration OpenID Connect {product-name} :

image:okta9.png[claims]

En Mode Développeur, Okta vous permet de personnaliser les revendications. Cela se fait dans la page API en gérant les serveurs d'autorisation (naviguez dans le menu de gauche -> Sécurité -> API). L'URL de l'émetteur se trouve dans l'onglet Paramètres de chaque serveur d'autorisation :

image:okta10.png[api]

Les revendications sont des paires nom/valeur qui contiennent des informations sur un utilisateur ainsi que des méta-informations sur le service OIDC.
Dans la section &quot;`+OpenID Connect ID Token+`&quot;, vous pouvez créer de nouvelles revendications pour les groupes d'utilisateurs et inclure la revendication dans le jeton d'identité (un jeton d'identité est un JSON Web Token, un moyen compact et sûr de représenter des revendications à transférer entre deux parties, de sorte que les informations d'identité sur l'utilisateur sont encodées directement dans le jeton et que le jeton peut être vérifié de manière définitive pour prouver qu'il n'a pas été altéré). Si un champ spécifique est configuré, assurez-vous d'ajouter le champ à la page de paramètres OpenID Connect {product-name}, afin que la revendication puisse être incluse après que l'utilisateur soit authentifié :

image:okta11.png[scopes]

Par défaut, {product-name} recherche des "groupes" dans la revendication pour identifier l'appartenance de l'utilisateur au groupe. Si un autre nom de revendication est utilisé, vous pouvez personnaliser le nom de la revendication dans la page des paramètres OpenID Connect de {product-name}. Pour configurer les revendications, modifiez la section &quot;`+OpenID Connect ID Token+`&quot; comme indiqué dans l'image suivante :

image:okta12.png[claims]

Dans la page d'intégration de votre application, accédez à l'onglet &quot;`+Assignments+`&quot; et assurez-vous que vous avez les affectations correspondantes listées :

image:okta13.png[assignations]

=== {product-name} Configuration OpenID Connect

Configurez l'URL de l'émetteur, l'ID client et le secret client sur la page.

image:openid9.png[OpenID9]

Après que l'utilisateur a été authentifié, le rôle approprié peut être dérivé avec la configuration de mappage de rôle basée sur les groupes. Pour configurer le mappage de rôle basé sur les groupes,

. Si le mappage de rôle basé sur les groupes n'est pas configuré ou si les groupes correspondants ne peuvent pas être localisés, l'utilisateur authentifié se verra attribuer le rôle par défaut. Si le rôle par défaut est défini sur Aucun, lorsque le mappage de rôle basé sur les groupes échoue, l'utilisateur ne peut pas se connecter.
. Spécifiez une liste de groupes respectivement dans la carte de rôle Administrateur et Lecteur. L'appartenance au groupe de l'utilisateur est renvoyée par les revendications dans le jeton d'identité après que l'utilisateur a été authentifié. Si le groupe correspondant est localisé, le rôle correspondant sera attribué à l'utilisateur.

Le groupe peut être mappé au rôle Administrateur dans {product-name}. Les utilisateurs individuels peuvent être 'promus' à un rôle d'Administrateur Fédéré en se connectant en tant qu'administrateur de grappe locale, en sélectionnant l'utilisateur avec le fournisseur d'identité 'OpenID', et en modifiant leur rôle dans les paramètres -> Utilisateurs/Rôles.

=== Mappage des groupes aux rôles et espaces de noms

Veuillez consulter la section xref:users.adoc#_mapping_groups_to_roles_and_namespaces[Utilisateurs et Rôles] pour savoir comment mapper les groupes aux rôles prédéfinis et personnalisés ainsi qu'aux espaces de noms dans {product-name}.
