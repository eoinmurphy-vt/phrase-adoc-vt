= Déploiement de Rancher
:revdate: 2024-12-03
:page-revdate: {revdate}
:page-opendocs-origin: /02.deploying/03.rancher/03.rancher.md
:page-opendocs-slug: /déploiement/rancher

== Déployer et gérer {product-name} via Rancher Extensions ou Apps & Marketplace

{product-name} peut être déployé facilement soit par le biais de Rancher Extensions pour les clients Prime, soit par le biais de Rancher Apps and Marketplace. Le déploiement par défaut (basé sur Helm) de {product-name} déploiera les conteneurs {product-name} dans l'espace de noms cattle-neuvector-system.

[NOTE]
====
Seuls les déploiements de {product-name} via Rancher Extensions ({product-name}) de Rancher version 2.7.0+, ou Apps & Marketplace de Rancher version 2.6.5+ peuvent être gérés directement (single sign on sur la console {product-name} ) via Rancher. Si vous ajoutez des clusters à Rancher avec {product-name} déjà déployé, ou si {product-name} a été déployé directement sur le cluster, ces clusters ne seront pas activés pour l'intégration SSO.
====

=== {product-name} Extension de l'interface utilisateur pour Rancher

Les clients de Rancher Prime peuvent facilement déployer {product-name} et l'extension {product-name} UI pour Rancher. Cela permettra aux utilisateurs Prime de surveiller et de gérer certaines fonctions et certains événements de {product-name} directement via l'interface utilisateur de Rancher. Pour les utilisateurs de la communauté, veuillez consulter la section Déployer {product-name} ci-dessous pour déployer à partir de Rancher Apps et Marketplace.

. La première étape consiste à activer globalement la fonctionnalité Rancher Extensions si elle ne l'est pas déjà.
+
--
image:ui0_extensions.png[extensions]

image:ui1_enable.png[permettre]
--
. Installer le {product-name}-UI-Ext de la liste disponible
+
--
image:ui2_installext.png[installer]
--
. Recharger l'extension une fois l'installation terminée
+
--
image:ui3reload.png[recharger]
--
. Sur le cluster sélectionné, installez l'application {product-name} à partir de l'onglet {product-name} si l'application {product-name} n'est pas déjà installée. Cela devrait vous amener aux étapes d'installation de l'application. Pour plus de détails sur ce processus d'installation, voir la section Déployer {product-name} ci-dessous.
+
--
image:ui5installnv.png[install_nv]
--
. Le tableau de bord {product-name} devrait maintenant s'afficher à partir du menu {product-name} pour ce cluster. Ce tableau de bord permet de surveiller l'état de la sécurité de la grappe. Le tableau de bord comporte des éléments interactifs, tels que l'invocation d'un assistant pour améliorer votre score (de risque de sécurité), y compris la possibilité d'activer l'analyse automatique des vulnérabilités si elle n'est pas activée.
+
--
image:ui6dashboard.png[tableau de bord]

En outre, les liens en haut à droite du tableau de bord permettent d'accéder à la console complète {product-name} pour une analyse et une configuration plus détaillées.
--
. Pour désinstaller l'extension, retournez à la page Extensions.
+
--
image:ui7uninstall.png[ininstaller]

[NOTE]
====
La désinstallation de l'extension de l'interface utilisateur {product-name} ne désinstalle PAS l'application {product-name} de chaque groupe. Le menu {product-name} fournira à nouveau un lien SSO vers la console {product-name}.
====
--

=== Déployer {product-name}

Tout d'abord, trouvez le graphique {product-name} dans les graphiques de Rancher, sélectionnez-le et examinez les instructions et les différentes valeurs de configuration. (Facultatif) Créez un projet à déployer si vous le souhaitez, par exemple {product-name}. Remarque : Si vous voyez plus d'un diagramme {product-name}, ne sélectionnez pas celui qui est destiné à la mise à niveau des déploiements de diagrammes Helm {product-name} 4.x.

image:rancher_chart.png[rancher_chart]

Déployer le graphique {product-name}, en configurant d'abord les valeurs appropriées pour un déploiement Rancher, comme par exemple :

* Exécution du conteneur, par exemple docker pour RKE et containerd pour RKE2, ou sélectionnez la valeur K3s si vous utilisez K3s.
* Manager service type : changez pour LoadBalancer si disponible sur les déploiements en nuage public. Si l'accès n'est souhaité qu'à travers Rancher, n'importe quelle valeur autorisée fonctionnera ici. Voir la note importante ci-dessous concernant la modification du mot de passe administrateur par défaut dans {product-name}.
* Indiquez si ce cluster sera un cluster primaire fédéré multi-clusters ou un cluster distant (ou sélectionnez les deux si vous souhaitez l'une ou l'autre option).
* Volume persistant pour les sauvegardes de configuration

image:rancher_chart_values.png[nv_values]

Cliquez sur "Installer" après avoir vérifié et mis à jour les valeurs des graphiques.

Après le déploiement réussi de {product-name}, vous verrez un résumé des déploiements, des ensembles de démons et des tâches cron pour {product-name}. Vous pourrez également voir les services déployés dans le menu Découverte des services sur la gauche.

image:nv_deployed.png[déployé]

=== Gérer {product-name}

Vous verrez maintenant un élément de menu {product-name} à gauche, et en le sélectionnant, vous verrez apparaître une tuile/bouton {product-name}, qui, lorsque vous cliquez dessus, vous amènera à la console {product-name}, dans un nouvel onglet.

image:nv_access.png[nv_console]

Lorsque cette méthode d'accès SSO (Single Sign On) est utilisée pour la première fois, un utilisateur correspondant dans le cluster {product-name} est créé pour la connexion de l'utilisateur Rancher. Le même nom d'utilisateur que l'utilisateur connecté à Rancher sera créé dans {product-name}, avec un rôle d'administrateur ou de fedAdmin, et le fournisseur d'identité est Rancher.

image:nv_admin.png[utilisateurs]

Notez que dans la capture d'écran ci-dessus, deux utilisateurs Rancher admin et gkosaka ont été automatiquement créés pour le SSO. Si un autre utilisateur est créé manuellement dans {product-name}, le fournisseur d'identité sera répertorié comme {product-name}, comme indiqué ci-dessous. Cet utilisateur local peut se connecter directement à la console {product-name} sans passer par Rancher.

image:local_admin.png[local]

[IMPORTANT]
====
Il est recommandé de se connecter directement à la console {product-name} en tant qu'administrateur/administratrice pour changer manuellement le mot de passe de l'administrateur par un mot de passe fort. Cela ne changera que le mot de passe de l'utilisateur administrateur du fournisseur d'identité {product-name} (vous pouvez voir un autre utilisateur administrateur dont le fournisseur d'identité est Rancher). Une autre solution consiste à inclure un xref:configmap.adoc#_protect_sensitive_data_using_a_secret[ConfigMap en tant que secret] dans le déploiement initial de Rancher (voir les valeurs du tableau pour les paramètres du ConfigMap) afin de définir le mot de passe administrateur par défaut comme un mot de passe fort.
====

=== Ressources de permission SSO de NeuVector/Rancher

L'interface utilisateur de Rancher v2.9.2 permet de sélectionner les ressources de permission NeuVector lors de la création des rôles `+Global/Cluster/Project/Namespaces+`. Lorsqu'un utilisateur de Rancher se voit attribuer un rôle avec une ressource de permission NeuVector, la session SSO NeuVector de l'utilisateur se voit attribuer la permission NeuVector correspondante. Il s'agit de fournir aux utilisateurs SSO des rôles personnalisés autres que les rôles réservés à `+admin/reader/fedAdmin/fedReader+`.

Vous trouverez ci-dessous les ressources d'autorisation mappées utilisées avec les rôles `+Global/Cluster/Project/Namespaces+` applicables.

==== Ressources de permissions mappées pour le rôle `+Global/Cluster+` 

[NOTE]
====
Les utilisateurs devront ajouter manuellement * (Verbes) / services/proxy (Ressource) aux rôles `+Global/Cluster+` liés à NeuVector.
====

Groupes API :

`+permission.neuvector.com+`

Verbes :

[,shell]
----
get    // for read-only(i.e. view)
*      // for read/write(i.e. modify)
----

Ressources :

NeuVector, Scoped en grappe

[,shell]
----
AdmissionControl
Authentication
CI Scan
Cluster
Federation
Vulnerability
----

NeuVector, Namespaced

[,shell]
----
AuditEvents
Authorization
Compliance
Events
Namespace
RegistryScan
RuntimePolicy
RuntimeScan
SecurityEvents
SystemConfig
----

==== Ressources de permissions mappées pour le rôle `+Project/Namespace+` 

[NOTE]
====
Les utilisateurs devront ajouter manuellement * (Verbes) / services/proxy (Ressource) aux rôles `+Project/Namespace+` liés à NeuVector.
====

Groupes API :

`+permission.neuvector.com+`

Verbes :

[,shell]
----
get    // for read-only(i.e. view)
*      // for read/write(i.e. modify)
----

Ressources :

NeuVector, Namespaced

[,shell]
----
AuditEvents
Authorization
Compliance
Events
Namespace
RegistryScan
RuntimePolicy
RuntimeScan
SecurityEvents
SystemConfig
----

=== Désactivation de {product-name}/Rancher SSO

Pour désactiver la possibilité de se connecter à {product-name} depuis Rancher Manager, allez dans Settings -> Configuration.

image:rancher_sso.png[rancher_sso]

=== Déploiements hérités de Rancher

Le fichier d'exemple déploie un gestionnaire et trois contrôleurs. Il déploiera un agent d'exécution sur chaque nœud. Voir la section inférieure pour spécifier des nœuds de gestionnaires ou de contrôleurs dédiés à l'aide d'étiquettes de nœuds. Remarque : Il n'est pas recommandé de déployer (mettre à l'échelle) plus d'un gestionnaire derrière un équilibreur de charge en raison des problèmes potentiels liés à l'état de la session.

[NOTE]
====
Le déploiement sur Rancher 2.x/Kubernetes doit suivre la section de référence Kubernetes et/ou le déploiement basé sur Helm.
====

. Déployer le catalogue docker-compose-dist.yml, les contrôleurs seront déployés sur les nœuds étiquetés, les enforcers seront déployés sur le reste des nœuds. (Le fichier d'exemple peut être modifié de manière à ce que les agents d'exécution ne soient déployés que sur les nœuds spécifiés).
. Choisissez l'un des contrôleurs auxquels le gestionnaire doit se connecter. Modifiez le fichier de catalogue du gestionnaire docker-compose-manager.yml, définissez CTRL_SERVER_IP à l'IP du contrôleur, puis déployez le catalogue du gestionnaire.

Voici les exemples de fichiers de composition. Si vous souhaitez ne déployer qu'un ou deux des composants, utilisez simplement cette section du fichier.

Rancher Manager/Controller/Enforcer Compose Sample File :

[,yaml]
----
manager:
   scale: 1
   image: neuvector/manager
   restart: always
   environment:
     - CTRL_SERVER_IP=controller
   ports:
     - 8443:8443
controller:
   scale: 3
   image: neuvector/controller
   restart: always
   privileged: true
   environment:
     - CLUSTER_JOIN_ADDR=controller
   volumes:
     - /var/run/docker.sock:/var/run/docker.sock
     - /proc:/host/proc:ro
     - /sys/fs/cgroup:/host/cgroup:ro
     - /var/neuvector:/var/neuvector
enforcer:
   image: neuvector/enforcer
   pid: host
   restart: always
   privileged: true
   environment:
     - CLUSTER_JOIN_ADDR=controller
   volumes:
     - /lib/modules:/lib/modules
     - /var/run/docker.sock:/var/run/docker.sock
     - /proc:/host/proc:ro
     - /sys/fs/cgroup/:/host/cgroup/:ro
   labels:
     io.rancher.scheduler.global: true
----

== Déploiement sans mode privilégié

Sur certains systèmes, le déploiement sans passer par le mode privilégié est possible. Ces systèmes doivent permettre d'ajouter des capacités à l'aide du paramètre cap_add et de définir le profil apparmor.

Voir les sections sur le déploiement avec Docker-Compose, Docker UCP/Datacenter pour des exemples de fichiers de composition.

Voici un exemple de fichier de composition Rancher pour un déploiement sans mode privilégié :

[,yaml]
----
manager:
   scale: 1
   image: neuvector/manager
   restart: always
   environment:
     - CTRL_SERVER_IP=controller
   ports:
     - 8443:8443
controller:
   scale: 3
   image: neuvector/controller
   pid: host
   restart: always
   cap_add:
     - SYS_ADMIN
     - NET_ADMIN
     - SYS_PTRACE
   security_opt:
     - apparmor=unconfined
     - seccomp=unconfined
     - label=disable
   environment:
     - CLUSTER_JOIN_ADDR=controller
   volumes:
     - /var/run/docker.sock:/var/run/docker.sock
     - /proc:/host/proc:ro
     - /sys/fs/cgroup:/host/cgroup:ro
     - /var/neuvector:/var/neuvector
enforcer:
   image: neuvector/enforcer
   pid: host
   restart: always
   cap_add:
     - SYS_ADMIN
     - NET_ADMIN
     - SYS_PTRACE
     - IPC_LOCK
   security_opt:
     - apparmor=unconfined
     - seccomp=unconfined
     - label=disable
   environment:
     - CLUSTER_JOIN_ADDR=controller
   volumes:
     - /lib/modules:/lib/modules
     - /var/run/docker.sock:/var/run/docker.sock
     - /proc:/host/proc:ro
     - /sys/fs/cgroup/:/host/cgroup/:ro
   labels:
     io.rancher.scheduler.global: true
----

== Utilisation des étiquettes de nœuds pour les nœuds gestionnaires et contrôleurs

Pour contrôler les nœuds sur lesquels le gestionnaire et le contrôleur sont déployés, étiqueter chaque nœud. Choisissez les nœuds où les contrôleurs doivent être déployés. Etiqueter les avec "nvcontroller=true". (Avec le fichier d'exemple actuel, pas plus d'un contrôleur ne peut fonctionner sur le même nœud).

Le nœud gestionnaire est étiqueté &quot;`+nvmanager=true+`&quot;.

Ajouter des étiquettes dans le fichier yaml. Par exemple pour le gestionnaire :

[,yaml]
----
   labels:
     io.rancher.scheduler.global: true
     io.rancher.scheduler.affinity:host_label: "nvmanager=true"
----

Pour le contrôleur :

[,yaml]
----
   labels:
     io.rancher.scheduler.global: true
     io.rancher.scheduler.affinity:host_label: "nvcontroller=true"
----

Pour l'exécuteur, afin d'éviter qu'il ne s'exécute sur un nœud contrôleur (si souhaité) :

[,yaml]
----
  labels:
     io.rancher.scheduler.global: true
     io.rancher.scheduler.affinity:host_label_ne: "nvcontroller=true"
----
