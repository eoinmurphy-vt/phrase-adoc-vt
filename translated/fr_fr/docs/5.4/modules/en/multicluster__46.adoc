= Gestion des grappes d'entreprises
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /04.navigation/02.multicluster/02.multicluster.md
:page-opendocs-slug:  /navigation/multicluster

== Console d'entreprise

La console {product-name} peut être utilisée pour gérer les déploiements multi-clusters et multi-cloud des grandes entreprises. Un cluster doit être sélectionné comme cluster primaire, et les autres clusters distants pourront alors rejoindre le cluster primaire. Une fois connecté, le cluster primaire peut envoyer des règles fédérées à chaque cluster distant, qui s'affichent en tant que règles fédérées dans les consoles de chaque cluster distant. Les registres fédérés analysés synchroniseront également les résultats de l'analyse avec les clusters distants. Seuls les utilisateurs locaux et les utilisateurs de Rancher disposant d'une autorisation d'administration peuvent promouvoir un cluster pour qu'il devienne le cluster primaire.

En plus de la stratégie fédérée, la gestion multi-clusters prend en charge la surveillance de chaque cluster distant dans une page récapitulative, comme illustré ci-dessous.

image:multicluster_summary.png[Résumé]

Il DOIT y avoir une connectivité réseau entre les contrôleurs de chaque grappe sur les ports requis. Le contrôleur est exposé à l'extérieur de son cluster par un service primaire ou distant, comme le montre l'exemple de fichier yaml de déploiement {product-name}.

== Configuration des clusters primaire et distant

Connectez-vous à la console du cluster qui sera le cluster primaire. Dans le menu déroulant en haut à droite, sélectionnez Multiple Clusters puis Promote pour configurer le Primary. Remarque : Seuls les utilisateurs locaux et les utilisateurs de Rancher disposant d'une autorisation d'administration peuvent promouvoir un cluster pour qu'il devienne le cluster primaire. Actuellement, les utilisateurs SSO/LDAP/OIDC ayant le rôle d'administrateur ne sont pas autorisés à promouvoir un cluster en tant que cluster primaire.image:master1.png[MasterConfig]

Entrez l'adresse IP publique et le port du service fed-master. Vous pouvez le trouver en lançant

[,shell]
----
kubectl get svc -n neuvector
----

Le résultat sera le suivant :

[,shell]
----
NAME                                      TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                         AGE
neuvector-service-controller-fed-master   LoadBalancer   10.27.249.147   35.238.131.23    11443:31878/TCP                 17d
neuvector-service-controller-fed-worker   LoadBalancer   10.27.251.1     35.226.199.111   10443:32736/TCP                 17d
----

Dans l'exemple ci-dessus, le nom d'hôte/IP du contrôleur primaire est 35.238.131.23 et le port est 11443. Remarque : Assurez-vous que cette adresse IP et ce port sont accessibles de l'extérieur (depuis les clusters distants). Remarque : Les horloges système (heure) doivent être identiques pour chaque cluster primaire et distant afin de fonctionner correctement.

Après vous être reconnecté à la console, sélectionnez à nouveau Multiple Clusters dans le menu en haut à droite, et cliquez sur l'icône pour générer un jeton nécessaire à la connexion des clusters distants. Copiez le jeton pour l'utiliser à l'étape suivante. Le jeton est valable pendant environ une heure et, s'il a expiré, il doit être généré à nouveau pour se connecter à de futurs clusters distants.

image:master_token.png[Token]

Pour joindre un cluster distant au cluster primaire, connectez-vous à la console du cluster distant en tant qu'administrateur. Sélectionnez Multiple Clusters dans le menu déroulant en haut à droite, puis cliquez sur Join. Saisissez l'adresse IP ou le nom d'hôte du contrôleur pour le cluster distant, ainsi que le port. Là encore, vous pouvez récupérer ces informations à partir du cluster distant en faisant :

[,shell]
----
kubectl get svc -n neuvector
----

Utilisez la sortie pour le fed-worker du cluster distant pour configurer l'adresse IP et le port. Saisissez ensuite le jeton copié à partir du primaire. Notez qu'après avoir saisi le jeton, l'adresse IP et le port pour le primaire seront automatiquement remplis, mais ils peuvent être modifiés ou saisis manuellement.

image:join_remote.png[JoinRemote]

Déconnectez-vous du cluster distant et reconnectez-vous au cluster primaire. Ou, si vous êtes déjà connecté, cliquez sur rafraîchir et le cluster distant sera listé dans le menu Clusters multiples.

image:fed_master_list.png[FedMaster]

Vous pouvez cliquer sur l'icône de gestion dans la liste ou utiliser le menu déroulant multi-clusters en haut pour changer de cluster à tout moment. Une fois que vous avez basculé vers un cluster distant, tous les éléments de menu à gauche s'appliquent désormais au cluster distant.

== Dépannage

Pour vous assurer que les services répondent comme prévu, vous pouvez exécuter les tests depuis l'extérieur des clusters ou, si nécessaire, depuis les pods de test sur les clusters `+fed-master+` et `+fed-managed+` pour vous assurer que la connexion réseau est autorisée entre les clusters.

=== Vérifier le service fed-master

Le port du service de cluster `+11443+` n'est accessible qu'après avoir activé le service `+fed-master+`. La commande ci-dessous renvoie un code d'erreur lorsque le service `+fed-master+` répond pour indiquer que la ressource demandée n'est pas disponible.

.Exemple de sortie
[,shell]
----
{"code":1,"error":"URL not found","message":"URL not found"}
----

[IMPORTANT]
====
L'URL de la commande `+curl+` dépend de la manière dont les services `+fed-master+` sont exposés. Si un service `+ingress+` est configuré, il n'est pas nécessaire de spécifier un port.
====

[,shell]
----
curl -v https://<fed-master>[:<port>]/v1/eula
----

=== Vérifier le service géré par les fédérations

Le port du service de cluster `+10443+` est partagé entre `+REST API+` et le service `+fed-managed+`. La commande ci-dessous renvoie un code de réussite lorsque le service `+fed-managed+` répond pour indiquer qu'il est disponible.

.Exemple de sortie
[,shell]
----
{"eula":{"accepted":true}})
----

[IMPORTANT]
====
L'URL de la commande `+curl+` dépend de la manière dont les services `+fed-managed+` sont exposés. Si un service `+ingress+` est configuré, il n'est pas nécessaire de spécifier un port.
====

[,shell]
----
curl -v https://<fed-managed>[:<port>]/v1/eula
----

== Politique de la fédération

Veuillez consulter la section Politique -> Politique fédérée pour savoir comment créer des règles fédérées qui seront envoyées à chaque cluster.

== Registres fédérés pour les résultats de la numérisation d'images distribuée

Le cluster primaire (maître) peut analyser un registre/répo désigné comme registre fédéré. Les résultats de l'analyse de ces registres seront synchronisés avec tous les clusters gérés (à distance). Cela permet d'afficher les résultats de l'analyse dans la console du cluster géré et de les utiliser dans les règles de contrôle d'admission du cluster géré. Les registres ne doivent être analysés qu'une seule fois au lieu de l'être par chaque grappe, ce qui réduit l'utilisation de l'unité centrale, de la mémoire et de la bande passante du réseau.

Les registres fédérés ne peuvent être configurés que par un administrateur fédéré sur le cluster primaire dans Assets -> Registries. Après avoir ajouté et analysé un référentiel fédéré, les résultats de l'analyse seront synchronisés avec tous les clusters gérés. Les règles de contrôle d'admission dans chaque cluster géré qui requièrent une analyse d'image (par exemple CVE, règles basées sur la conformité) utiliseront automatiquement les résultats de l'analyse fédérée ainsi que les résultats de l'analyse du registre configurés localement.

=== Fédérer les résultats des scanners CI/CD (optionnel)

Les résultats de l'analyse du registre fédéré sont toujours synchronisés avec les clusters gérés, comme décrit ci-dessus. Le cluster primaire peut également recevoir des résultats d'analyse xref:scanners.adoc#_standalone_scanner_for_local_scanning[provenant de scanners autonomes] ou de plug-ins de scanners invoqués à partir d'un pipeline de construction CI/CD. Pour permettre aux résultats de l'analyse du référentiel de la phase de construction (CI/CD) de se synchroniser également avec les clusters gérés, il faut d'abord l'activer en modifiant les paramètres du cluster primaire (maître) comme indiqué ci-dessous.

image:fed_primary_config.png[master_settings]

image:fed_reg_sync.png[fed_sync]
