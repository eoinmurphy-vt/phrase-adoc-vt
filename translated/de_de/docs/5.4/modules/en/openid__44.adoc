= OpenID-Verbindung Azure/Okta
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /08.integration/07.openid/07.openid.md
:page-opendocs-slug:  /integration/openid

== Integration mit OpenID Connect (OIDC) für Azure und Okta

Um die OpenID Connect-Authentifizierung zu aktivieren, sind die Einstellungen *Issuer*, *Client ID* und *Client secret* erforderlich. Mit der Emittenten-URL ruft {product-name} die Discovery-API auf, um die Endpunkte Authenorization, Token und User info abzurufen.

Suchen Sie die OpenID Connect Redirect URI oben auf der Seite {product-name} OpenID Connect Setting. Sie müssen diese URI in die *Login-Redirect-URIs* für Okta und *Reply-URLs* für Microsoft Azure kopieren.

image:openid1.png[OpenID1]

=== Microsoft Azure-Konfiguration

Suchen Sie in Azure Active Directory > App-Registrierungen > Anwendungsname > Einstellungsseite die Zeichenfolge Anwendungs-ID. Dies wird verwendet, um die Client-ID in {product-name} einzustellen. Das Client-Geheimnis kann in den Azure-Schlüssel-Einstellungen gefunden werden.

image:openid3.png[OpenID3]

Die URL des Ausstellers hat das Format "https://login.microsoftonline.com/{tenantID}/v2.0". Um die TenantID zu finden, gehen Sie auf menu:Azure Active DirectoryProperties[Page] und finden Sie die Directory ID, ersetzen Sie sie durch die TenantID in der URL

image:openid4.png[OpenID4]

Wenn die Benutzer den Gruppen im aktiven Verzeichnis zugeordnet sind, kann ihre Gruppenzugehörigkeit dem Anspruch hinzugefügt werden. Suchen Sie die Anwendung in *Azure Active Directory -> App-Registrierungen* und bearbeiten Sie das Manifest. Ändern Sie den Wert von "groupMembershipClaims" in "Anwendungsgruppe".  Es gibt eine Höchstzahl von Gruppen, die in einem Token ausgegeben werden können.  Wenn der Benutzer einer großen Anzahl von Gruppen angehört ( > 200) und der Wert "Alle" verwendet wird, schließt das Token die Gruppen nicht ein und die Autorisierung schlägt fehl.  Die Verwendung des Wertes "Anwendungsgruppe" anstelle von "Alle" reduziert die Anzahl der anwendbaren Gruppen, die im Token zurückgegeben werden.

Standardmäßig sucht {product-name} nach "Gruppen" im Anspruch, um die Gruppenzugehörigkeit des Benutzers zu identifizieren. Wenn ein anderer Anspruchsname verwendet wird, können Sie den Anspruchsnamen auf der OpenID Connect-Einstellungsseite {product-name} anpassen.

Die von Azure zurückgegebenen Gruppenansprüche werden durch die "Objekt-ID" anstelle des Namens identifiziert. Die Objekt-ID der Gruppe kann unter menu:Azure Active[DirectoryGroups > Group name Page] gefunden werden. Sie sollten diesen Wert verwenden, um die gruppenbasierte Rollenzuordnung in {product-name} -> Einstellungen zu konfigurieren.

image:openid5.png[OpenID5]

==== Berechtigungen überprüfen

Stellen Sie sicher, dass die folgenden Berechtigungen von Microsoft Graph festgelegt wurden

. email - Anzeige der E-Mail-Adressen der Benutzer
. openid - Benutzer anmelden
. Profil - Ansicht des grundlegenden Benutzerprofils

=== Okta-Konfiguration

Melden Sie sich bei Ihrem Okta-Konto an.

Klicken Sie im Menü auf der linken Seite auf "+Anwendungen -> Anwendungen "+` Klicken Sie im mittleren Bereich auf &quot;`+Create App Integration+`&quot;:

image:okta1.png[erstellen.]

Es öffnet sich ein neues Fenster zur Auswahl der &quot;`+Sign-in method+`&quot;:

image:okta2.png[newapp]

Wählen Sie die Option &quot;`+OIDC -- OpenID Connect+`&quot;.

Es erscheint ein abgeleitetes Fenster für die Auswahl von &quot;`+Application Type+`&quot;:

image:okta3.png[apptype]

Wählen Sie die Option &quot;`+Native Application+`&quot;.

Im mittleren Bereich wird nun das Formular Native App Integration angezeigt, in das Sie die folgenden Werte eingeben müssen:

Für den Abschnitt Allgemeine Einstellungen:

App. Name der Integration: Name für diese Integration. Wählen Sie einen beliebigen Namen Grant Type (ankreuzen):

* Berechtigungscode
* Token aktualisieren
* Passwort des Ressourcenbesitzers
* Implizit (hybrid)

Für den Abschnitt Anmeldungsumleitungs-URIs:

Rufen Sie Ihre Konsole {product-name} auf und navigieren Sie zu &quot;`+Settings+`&quot; -> &quot;`+OpenId Connect Settings+`&quot;.  Klicken Sie oben auf der Seite neben dem Label &quot;`+OpenID Connect Redirect URI+`&quot; auf &quot;`+Copy to Clipboard+`&quot;.

image:okta4.png[copy]

Dadurch wird der Umleitungs-URI in den Speicher kopiert.
Fügen Sie ihn in das entsprechende Textfeld ein:

image:okta5.png[einfügen]

Für den Abschnitt Zuweisungen:

Wählen Sie &quot;`+Allow everyone in your organization to access+`&quot;, um diese Integration für alle Mitarbeiter Ihrer Organisation verfügbar zu machen.

image:okta6.png[Zuweisungen]

Klicken Sie dann auf die Schaltfläche "Speichern" unten auf der Seite.

Sobald Sie Ihre allgemeinen Einstellungen gespeichert haben, werden Sie zur Einrichtung Ihrer neuen Anwendungsintegration weitergeleitet, und es wird automatisch eine Client-ID erstellt.

Klicken Sie im Abschnitt &quot;`+Client Credentials+`&quot; auf Bearbeiten und ändern Sie den Abschnitt &quot;`+Client Authentication+`&quot; von &quot;`+Use PKCE (for public clients)+`&quot; in &quot;`+Use Client Authentication+`&quot;, und klicken Sie auf Speichern. Dadurch wird automatisch ein neues Geheimnis generiert, das wir in den nächsten Schritten zur Einrichtung von {product-name} benötigen:

image:okta7.png[Kundenauthentifizierung]

Wechseln Sie zur Registerkarte &quot;`+Sign On+`&quot; und bearbeiten Sie den Abschnitt &quot;`+OpenID Connect ID Token+`&quot;:
Ändern Sie den Emittenten von &quot;`+Dynamic (based on request domain)+`&quot; auf den festen &quot;`+Okta URL+`&quot;:

image:okta8.png[Token]

Die Okta-Konsole kann in zwei Modi betrieben werden: im klassischen Modus und im Entwicklermodus.
Im klassischen Modus befindet sich die Aussteller-URL auf der Registerkarte "Anmelden" der Okta-Anwendungsseite. Damit die Gruppenzugehörigkeit des Benutzers im Anspruch zurückgegeben wird, müssen Sie auf der Konfigurationsseite {product-name} OpenID Connect den Bereich "groups" hinzufügen:

image:okta9.png[Ansprüche]

Im Entwicklermodus ermöglicht Okta die Anpassung der Ansprüche. Dies geschieht auf der API-Seite durch die Verwaltung von Autorisierungsservern (navigieren Sie zum linken Menü -> Sicherheit -> API). Die URL des Ausstellers befindet sich auf der Registerkarte Einstellungen des jeweiligen Autorisierungsservers:

image:okta10.png[api]

Claims sind Name/Wert-Paare, die Informationen über einen Benutzer sowie Metainformationen über den OIDC-Dienst enthalten.
Im Abschnitt &quot;`+OpenID Connect ID Token+`&quot; können Sie neue Ansprüche für Benutzergruppen erstellen und den Anspruch im ID-Token übertragen (ein ID-Token ist ein JSON-Web-Token, ein kompaktes URL-sicheres Mittel zur Darstellung von Ansprüchen, die zwischen zwei Parteien übertragen werden sollen, so dass Identitätsinformationen über den Benutzer direkt im Token kodiert sind und das Token definitiv überprüft werden kann, um zu beweisen, dass es nicht manipuliert wurde). Wenn ein bestimmter Bereich konfiguriert ist, fügen Sie diesen auf der Einstellungsseite {product-name} OpenID Connect hinzu, damit der Anspruch nach der Authentifizierung des Benutzers aufgenommen werden kann:

image:okta11.png[Geltungsbereiche]

Standardmäßig sucht {product-name} nach "Gruppen" im Anspruch, um die Gruppenzugehörigkeit des Benutzers zu identifizieren. Wenn ein anderer Anspruchsname verwendet wird, können Sie den Anspruchsnamen auf der OpenID Connect-Einstellungsseite {product-name} anpassen. Um Ansprüche zu konfigurieren, bearbeiten Sie den Abschnitt &quot;`+OpenID Connect ID Token+`&quot; wie in der nächsten Abbildung gezeigt:

image:okta12.png[Ansprüche]

Navigieren Sie auf Ihrer Anwendungsintegrationsseite zur Registerkarte &quot;`+Assignments+`&quot; und vergewissern Sie sich, dass die entsprechenden Zuordnungen aufgeführt sind:

image:okta13.png[Zuweisungen]

=== {product-name} OpenID Connect Konfiguration

Konfigurieren Sie die richtige Aussteller-URL, die Client-ID und das Client-Geheimnis auf der Seite.

image:openid9.png[OpenID9]

Nachdem der Benutzer authentifiziert ist, kann die richtige Rolle mit der gruppenbasierten Rollenzuordnungskonfiguration abgeleitet werden. So richten Sie eine gruppenbasierte Rollenzuordnung ein,

. Wenn die gruppenbasierte Rollenzuordnung nicht konfiguriert ist oder die entsprechenden Gruppen nicht gefunden werden können, wird dem authentifizierten Benutzer die Standardrolle zugewiesen. Wenn die Standardrolle auf Keine gesetzt ist, kann sich der Benutzer nicht anmelden, wenn die gruppenbasierte Rollenzuordnung fehlschlägt.
. Geben Sie eine Liste von Gruppen in den Rollen Admin und Reader an. Die Gruppenzugehörigkeit des Benutzers wird von den Angaben im ID-Token zurückgegeben, nachdem der Benutzer authentifiziert wurde. Wenn die passende Gruppe gefunden wird, wird dem Benutzer die entsprechende Rolle zugewiesen.

Die Gruppe kann der Rolle Admin in {product-name} zugeordnet werden. Einzelne Benutzer können zu einer Federated Admin-Rolle "befördert" werden, indem sie sich als lokaler Cluster-Administrator anmelden, den Benutzer mit Identify Provider "OpenID" auswählen und seine Rolle unter Einstellungen -> Benutzer/Rollen bearbeiten.

=== Zuordnung von Gruppen zu Rollen und Namensräumen

Wie Sie Gruppen voreingestellten und benutzerdefinierten Rollen sowie Namespaces in {product-name} zuordnen können, erfahren Sie im Abschnitt xref:users.adoc#_mapping_groups_to_roles_and_namespaces[Benutzer und Rollen].
