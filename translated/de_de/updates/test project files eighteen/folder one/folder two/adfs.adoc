= Testprojekt achtzehn SAML (ADFS)
:revdate: 2025-05-08
:page-revdate: {revdate}
:page-opendocs-origin: /08.integration/06.adfs/06.adfs.md
:page-opendocs-slug:  /integration/adfs

== Test_ZweiEinrichtung von ADFS und {product-name} Integration

Dieser Abschnitt beschreibt zuerst die Einrichtungsschritte in ADFS und dann in der {product-name} Konsole.

=== Test_TwoADFS Setup

. Klicken Sie mit der rechten Maustaste auf &quot;`+Relying Party Trusts+`+&quot; und wählen Sie &quot;+`+Add Relying Party Trust...+`+&quot;.
+
image:adfs1.png[adfsSetup]

. Wählen Sie die Schaltfläche &quot;+`+Start+`+&quot; aus dem Willkommensschritt aus.
+
image:adfs2.png[adfsSetup]

. Wählen Sie &quot;+`+Geben Sie Daten über die vertrauende Partei manuell ein+`+&quot; und wählen Sie &quot;+`+Weiter+`+&quot;.
+
image:adfs3.png[adfsSetup]

. Geben Sie einen eindeutigen Namen für das Feld Anzeigename ein und wählen Sie &quot;+`+Weiter+`+&quot;.
+
image:adfs4.png[adfsSetup]

. Wählen Sie &quot;+`+Weiter+`+&quot; aus, um die Token-Verschlüsselung zu überspringen.
+
image:adfs5.png[adfsSetup]

. Überprüfen Sie &quot;+`+Aktivieren Sie die Unterstützung für das SAML 2.0 WebSSO-Protokoll+`+&quot; und geben Sie die SAML-Redirect-URI von {product-name} Einstellungen>SAML-Einstellungsseite in das &quot;+`+SSO-Dienst-URL der vertrauenden Partei SAML 2.0+`+&quot; Feld ein.  Wählen Sie &quot;+`+Weiter+`+&quot; um fortzufahren.
+
image:adfs6.png[adfsSetup]

. Geben Sie dieselbe SAML-Redirect-URI in das &quot;+`+Identifikator der vertrauenden Partei+`+&quot; Feld ein und klicken Sie auf &quot;+`+Hinzufügen+`+&quot;; wählen Sie dann &quot;+`+Weiter+`+&quot; um fortzufahren.
+
image:adfs7.png[adfsSetup]

. Passen Sie die Zugriffskontrolle an; wählen Sie dann &quot;+`+Weiter+`+&quot; um fortzufahren.
+
image:adfs8.png[adfsSetup]

. Wählen Sie &quot;+`+Weiter+`+&quot; um fortzufahren.
+
image:adfs9.png[adfsSetup]

. Wählen Sie &quot;+`+Schließen+`+&quot; um abzuschließen.
. Wählen Sie Bearbeiten der Anspruchsausstellungspolitik...
+
image:adfs10-11.png[adfsSetup]

. Wählen Sie &quot;+`+Regel hinzufügen...+`+&quot; und wählen Sie &quot;+`+LDAP-Attribute als Ansprüche senden+`+&quot;; wählen Sie dann &quot;+`+Weiter+`+&quot;.  Benennen Sie die Regel und wählen Sie Active Directory als Attributspeicher. Nur der ausgehende Anspruch für den Benutzernamen ist für die Authentifizierung erforderlich, wenn die Standardrolle festgelegt ist; andernfalls sind Gruppen für die Rollenzuordnung erforderlich.  E-Mail ist optional.
+
--
* SAM-Konto-Name -> Benutzername
* E-Mail-Adresse -> E-Mail
* Token-Gruppen -- Unqualifizierte Namen -> Gruppen

image:adfs11-12.png[adfsSetup]
--
. Wählen Sie &quot;+`+Regel hinzufügen...+`+&quot; und wählen Sie &quot;+`+Transformieren Sie einen eingehenden Anspruch+`+&quot;; wählen Sie dann &quot;+`+Weiter+`+&quot;.  Benennen Sie die Regel und setzen Sie das Feld wie im Screenshot unten fest.  Das ausgehende Name-ID-Format muss Transient Identifier sein.
+
image:adfs12-13.png[adfsSetup]

=== Test_Two{product-name} Setup

. Identifizieren Sie den Anbieter für die Single Sign-On-URL
* Sehen Sie sich Endpunkte von AD FS-Verwaltung > Dienst an und verwenden Sie &quot;+`+SAML 2.0/WS-Federation+`+&quot; Endpunkt-URL.
* Beispiel: +`+https://<adfs-fqdn>/adfs/ls+`+

. Identitätsanbieter-Aussteller
* Klicken Sie mit der rechten Maustaste auf AD FS in der AD FS-Verwaltungskonsole und wählen Sie &quot;+`+Federationsdienst-Eigenschaften bearbeiten...+`+&quot;; verwenden Sie die &quot;+`+Federationsdienst-Identifikator+`+&quot;.
* Beispiel: +`+http://<adfs-fqdn>/adfs/services/trust+`+

. X.509-Zertifikat
* Wählen Sie in der AD FS-Verwaltung Dienst > Zertifikat, klicken Sie mit der rechten Maustaste auf das Token-Signierungszertifikat und wählen Sie &quot;+`+Zertifikat anzeigen...+`+&quot;
* Wählen Sie die Registerkarte Details und klicken Sie &quot;+`+In Datei kopieren+`+&quot;
* Speichern Sie es als eine Base-64-kodierte x.509 (.CER) Datei
* Kopieren Sie den Inhalt der Datei und fügen Sie ihn in das X.509-Zertifikat-Feld ein

. Gruppenanspruch
* Geben Sie den Namen des ausgehenden Anspruchs für die Gruppen ein
* Beispiel: Gruppen

. Standardrolle
* Es wird empfohlen, &quot;+`+Keine+`+&quot; zu verwenden, es sei denn, Sie möchten, dass jeder authentifizierte Benutzer eine Standardrolle hat.

. Rollenabbildung
* Legen Sie die Gruppennamen der Benutzer für die entsprechende Rolle fest.  (Siehe Screenshot-Beispiel unten.)
+
image:nv_adfs1.png[NVadfsSetup]

=== Test_ZweiMapping Gruppen zu Rollen und Namensräumen

Bitte sehen Sie sich den Abschnitt xref:users.adoc#_mapping_groups_to_roles_and_namespaces[Benutzer und Rollen] an, um zu erfahren, wie Gruppen auf vordefinierte und benutzerdefinierte Rollen sowie Namensräume in {product-name} abgebildet werden.

== Test_TwoTroubleshooting

. ADFS SamlResponseSignature muss entweder MessageOnly oder MessageAndAssertion sein.  Verwenden Sie den Befehl Get-AdfsRelyingPartyTrust, um dies zu überprüfen oder zu aktualisieren.
+
image:nv_adfs2.png[adfsTroubleshooting]

. Zeit-Synchronisation zwischen Kubernetes-Knoten und ADFS-Server

Für eine erfolgreiche Authentifizierung muss die Zeit zwischen den Kubernetes-Knoten und dem ADFS-Server gleich sein, um Probleme mit der Zeit-Synchronisation oder Zeitabweichungen zu vermeiden.

Es wird empfohlen, einen https://en.wikipedia.org/wiki/Network_Time_Protocol[NTP-Server] zu verwenden, mit gleichen Zeiteinstellungen auf allen Servern.

Bitte überprüfen und bestätigen Sie, dass sowohl ADFS als auch {product-name} Hosts synchronisiert sind und die möglichen Verzögerungen 10 Sekunden nicht überschreiten. Sie können Linux- und Windows-Befehle verwenden, um Daten, Zeiten und die Aktivität des NTP-Servers zu überprüfen.

[TIP]
====
Sie können die Authentifizierungszeiten neu laden, indem Sie die Konfiguration in der {product-name} UI wie folgt deaktivieren und erneut aktivieren:

* Melden Sie sich bei {product-name} mit dem Admin-Benutzer an
* Gehen Sie zu Einstellungen
* Klicken Sie auf die Schaltfläche, um die SAML-Einstellung zu deaktivieren und zu aktivieren
** *Stellen Sie sicher, dass Sie die Konfigurationseinstellungen beibehalten!*

Sobald die Einstellung wieder aktiviert ist, können Sie versuchen, sich mit einem ADFS-Benutzer anzumelden. Wenn es funktioniert, bestätigt dies, dass das Problem auf einen Zeit-Synchronisierungsfehler zwischen Kubernetes-Knoten und dem ADFS-Server zurückzuführen war.
====

. SAML-Zeichen müssen in der {product-name} UI groß- und kleinschreibungsempfindlich sein
+
Attributnamen sind groß- und kleinschreibungsempfindlich. Stellen Sie sicher, dass jeder hier konfigurierte SAML-Attributname mit der Anwendungs-Konfiguration genau übereinstimmt. SAML muss auf die richtige URL zeigen, um sich zu authentifizieren.
+
Alle Felder in +`+{product-name} UI -> Einstellungen -> SAML-Einstellungen+`+ sind groß- und kleinschreibungsempfindlich.
+
Die Protokolldateien des {product-name} Controllers enthalten die relevanten Informationen zur Authentifizierung mit dem ADFS-Server und Fehler, die helfen, die Ursache zu identifizieren. Wir empfehlen, die fehlgeschlagene Anmeldebedingung erneut zu erstellen und die Protokolle zu überprüfen.

. Stellen Sie sicher, dass Sie die richtigen Gruppen, Zertifikate und Protokolle eingeben
+
Die SAML-Einstellungen müssen mit der folgenden Konfiguration übereinstimmen:
+
|===
| Einstellung | Wert

| Identifizieren Sie den Anbieter für die Single Sign-On-URL
| Erfordert HTTPS-Protokoll

| Identitätsanbieter-Aussteller
| Erfordert HTTP-Protokoll

| ADFS SamlResponseSignature
| Muss entweder MessageOnly oder MessageAndAssertion sein
|===

[CAUTION]
====
Diese Einstellungen müssen auf Ihrem ADFS-Server und in der {product-name} UI validiert werden.
====

Das ausgewählte Zertifikat muss gültig und korrekt generiert sein, einschließlich seines +`CA Root`+ und +`Intermediate Certificates`+. Sie können sie mit Ihrer vertrauenswürdigen Zertifizierungsstelle, Windows oder einem Automatisierungstool wie https://letsencrypt.org/[LetsEncrypt] generieren.

Wenn einer dieser Parameter falsch ist, erhalten Sie einen +`Authentifizierung fehlgeschlagen` Fehler, wenn Sie versuchen, sich mit einem ADFS-Benutzer über SAML-Authentifizierung bei {product-name} anzumelden.
