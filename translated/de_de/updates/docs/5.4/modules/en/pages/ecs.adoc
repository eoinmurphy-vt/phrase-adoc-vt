= Amazon ECS
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /02.deploying/09.ecs/09.ecs.md
:page-opendocs-slug: /deploying/ecs

== Wichtig: Die Bereitstellung auf Amazon ECS wird nicht mehr unterstützt

Der Referenzabschnitt unten wird nicht mehr gepflegt. Er kann jedoch einige Unterstützung bieten, um zu verstehen, wie man das Allinone auf ECS bereitstellt.

== Bereitstellung auf AWS mit ECS

Dies ist ein Beispiel dafür, wie man {product-name} mit ECS bereitstellt.

[NOTE]
====
Bitte sehen Sie sich die Kubernetes-Beispiele für EKS an.
====

. Bereiten Sie mehrere Amazon ECS-Instanzen vor, die die Docker-Engine und die ECS-Agent-Container integriert haben. Wählen Sie einen Knoten für die Verwaltungs-Konsole aus. Definieren Sie dann Sicherheitsgruppenregeln, die eingehenden TCP-Port 8443 ({product-name}‘s Standardport für die Verwaltungs-Konsole) für den Zugriff durch Ihren Client-Browser zulassen.
. Definieren Sie eine Sicherheitsgruppe, die TCP- und UDP-Ports auf 18300, 18301, 18400, 18401 zulässt. Dies wird von {product-name} Vollstreckern verwendet, um mit den Controllern/Allinone zu kommunizieren. Wenden Sie diese Sicherheitsgruppe auf alle ECS-Instanzen an, die die {product-name} Vollstrecker und Controller/Allinone bereitstellen werden.
. Setzen Sie ein Attribut auf den Knoten, die Sie {product-name} Allinone oder Controller-Container bereitstellen möchten. Wenn Sie beispielsweise {product-name} im Controller-HA-Modus ausführen möchten, wird empfohlen, mindestens 3 Knoten auszuwählen und dann das Attribut zu allen 3 Knoten hinzuzufügen.
+
--
So fügen Sie Attribute zu Ihren ECS-Instanzen hinzu:

Wählen Sie die Instanz aus und wählen Sie dann &quot;`+View/Edit Attributes+`&quot; aus dem Dropdown-Menü Aktionen.

image:1viewattributes.png[Attribute]

Fügen Sie ein neues Attribut hinzu. Zum Beispiel &quot;`+allinone-node+`&quot; mit dem Wert &quot;`+true+`&quot;.

image:2addattribute.png[AddAttributes]
--
. Erstellen Sie die All-in-One-Aufgabendefinition. Erstellen Sie eine neue Aufgabendefinition für den All-in-One-Container. Sie können die ECS-Oberfläche verwenden, um sie manuell zu erstellen oder die Beispiel-JSON-Datei (siehe unten für Beispiele) einzufügen. Verweisen Sie auf Abschnitt &quot;`+1. Deploying {product-name}+`&quot; dieser Dokumentation, um zu erfahren, wie Sie das All-in-One konfigurieren.
+
--
Geben Sie die Platzierungsbeschränkung ein. Wenn Sie beispielsweise die oben genannten Attributbeschriftungen verwendet haben, geben Sie dies in der Einschränkung ein.

[,json]
----
attribute:allinone-node=~true
----

image:3taskdef.png[AllinoneTask]

[NOTE]
====
Wenn Sie die aktualisierte JSON-Datei jetzt überprüfen, sehen Sie die hinzugefügte Platzierungsbeschränkung.
====
--
. Erstellen Sie einen neuen Dienst für die All-in-One-Aufgabe. Setzen Sie die &quot;`+Placement Templates+`&quot; auf &quot;`+One Task Per Host+`&quot;, damit nur ein All-in-One/Controller auf einem Host ausgeführt werden kann. Sie werden auch sehen, dass die Einschränkung "`+memberOf(attribute:allinone-node=~true) verwendet wird, was erfordert, dass der Knoten dieses Attribut hat.
+
--
image:3taskplacement.png[AllinonePlace]
--
. Jetzt können Sie den All-in-One-Dienst bereitstellen. Setzen Sie die "+`Anzahl der Aufgaben`+" auf die gewünschte Anzahl von All-in-One/Controllern. Jetzt werden die {product-name} All-in-One- oder Controller-Container auf den ausgewählten Knoten gestartet. Nachdem das All-in-One ausgeführt wird, sollten Sie in der Lage sein, über HTTPS auf die {product-name} Konsole über Port 8443 zuzugreifen.
. Erstellen Sie die Enforcer-Aufgabendefinition. Dies ist ähnlich wie die All-in-One-Aufgabe. Konfigurieren Sie manuell über die ECS-Konsole oder verwenden Sie das JSON-Beispiel unten.
+
--
Für die Platzierungsbeschränkung des Enforcers müssen Sie sicherstellen, dass der Enforcer NICHT auf demselben Knoten wie das All-in-One ist.

[,json]
----
attribute:allinone-node!~true
----

image:4enforcertask.png[EnforcerTask]
--
. Erstellen Sie einen neuen Dienst für die Enforcer-Aufgabe. Setzen Sie erneut die Aufgabenplatzierung auf "+`Eine Aufgabe pro Host`+", damit nur ein Enforcer auf jedem Host bereitgestellt wird. Beachten Sie auch, dass die zusätzliche Einschränkung zeigt, dass sie die Bereitstellung auf einem All-in-One-Knoten verhindert.
+
--
image:5taskplacement.png[EnforcerPlacement]

Stellen Sie diesen Dienst mit der gewünschten Anzahl von Enforcer-Knoten in "+`Anzahl der Aufgaben`+" bereit. In sehr kurzer Zeit werden alle Enforcer betriebsbereit sein. Von der {product-name}-Konsole aus können Sie alle Knoten sehen, die mit Enforcern erkannt werden.
--

== Beispiel ECS JSON-Aufgabenbeschreibungen

Sie können die folgenden Beispiele als Ausgangspunkt für die Konfiguration der Aufgabenbeschreibungen für die {product-name}-Container verwenden.

Erstellen Sie eine neue Aufgabenbeschreibung und klicken Sie dann unten auf "Über JSON konfigurieren". Bevor Sie das untenstehende JSON einfügen, ersetzen Sie die IP-Adresse und den Bildpfad (finden Sie ERSETZEN in den Beispielen). Typischerweise wäre die IP-Adresse die private IP-Adresse der AWS-Instanz, auf der das All-in-One ausgeführt wird. Sie können auch einen anderen Familiennamen als my-allinone/my-enforcer angeben (unten im JSON).

Beispiel All-in-One JSON-Datei:

.Klicken Sie hier für Details
[%collapsible]
====
[,json]
----
{
    "networkMode": "bridge",
    "taskRoleArn": null,
    "pidMode": "host",
    "containerDefinitions": [
        {
            "volumesFrom": [],
            "memory": null,
            "extraHosts": null,
            "dnsServers": null,
            "disableNetworking": null,
            "dnsSearchDomains": null,
            "portMappings": [
                {
                    "hostPort": 18300,
                    "containerPort": 18300,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18301,
                    "containerPort": 18301,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18400,
                    "containerPort": 18400,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18401,
                    "containerPort": 18401,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18301,
                    "containerPort": 18301,
                    "protocol": "udp"
                },
                {
                    "hostPort": 8443,
                    "containerPort": 8443,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 1443,
                    "containerPort": 10443,
                    "protocol": "tcp"
                }
            ],
            "hostname": null,
            "essential": true,
            "entryPoint": null,
            "mountPoints": [
                {
                    "containerPath": "/lib/modules",
                    "sourceVolume": "modules",
                    "readOnly": null
                },
                {
                    "containerPath": "/var/run/docker.sock",
                    "sourceVolume": "dockersock",
                    "readOnly": null
                },
                {
                    "containerPath": "/host/proc",
                    "sourceVolume": "proc",
                    "readOnly": true
                },
                {
                    "containerPath": "/host/cgroup",
                    "sourceVolume": "cgroup",
                    "readOnly": true
                }
            ],
            "name": "allinone",
            "ulimits": null,
            "dockerSecurityOptions": null,
            "environment": [
                {
                    "name": "CLUSTER_JOIN_ADDR",
                    "value": "REPLACE: Private IP"
                }
            ],
            "links": null,
            "workingDirectory": null,
            "readonlyRootFilesystem": false,
            "image": "REPLACE: Image Path/Name",
            "command": null,
            "user": null,
            "dockerLabels": {
                "com.myself.name": "neuvector"
            },
            "logConfiguration": null,
            "cpu": 0,
            "privileged": true,
            "memoryReservation": 768
        }
    ],
    "volumes": [
        {
            "host": {
                "sourcePath": "/lib/modules"
            },
            "name": "modules"
        },
        {
            "host": {
                "sourcePath": "/var/run/docker.sock"
            },
            "name": "dockersock"
        },
        {
            "host": {
                "sourcePath": "/proc"
            },
            "name": "proc"
        },
        {
            "host": {
                "sourcePath": "/sys/fs/cgroup"
            },
            "name": "cgroup"
        }
    ],
    "family": "my-allinone",
    "placementConstraints": []
}
----
====

Beispiel Enforcer JSON-Datei:

.Klicken Sie hier für Details
[%collapsible]
====
[,json]
----
{
    "networkMode": "bridge",
    "taskRoleArn": null,
    "pidMode": "host",
    "containerDefinitions": [
        {
            "volumesFrom": [],
            "memory": null,
            "extraHosts": null,
            "dnsServers": null,
            "disableNetworking": null,
            "dnsSearchDomains": null,
            "portMappings": [
                {
                    "hostPort": 18301,
                    "containerPort": 18301,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18401,
                    "containerPort": 18401,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18301,
                    "containerPort": 18301,
                    "protocol": "udp"
                }
            ],
            "hostname": null,
            "essential": true,
            "entryPoint": null,
            "mountPoints": [
                {
                    "containerPath": "/lib/modules",
                    "sourceVolume": "modules",
                    "readOnly": null
                },
                {
                    "containerPath": "/var/run/docker.sock",
                    "sourceVolume": "dockersock",
                    "readOnly": null
                },
                {
                    "containerPath": "/host/proc",
                    "sourceVolume": "proc",
                    "readOnly": true
                },
                {
                    "containerPath": "/host/cgroup",
                    "sourceVolume": "cgroup",
                    "readOnly": true
                }
            ],
            "name": "enforcer",
            "ulimits": null,
            "dockerSecurityOptions": null,
            "environment": [
                {
                    "name": "CLUSTER_JOIN_ADDR",
                    "value": "REPLACE: Private IP"
                }
            ],
            "links": null,
            "workingDirectory": null,
            "readonlyRootFilesystem": false,
            "image": "REPLACE: Image Path/Name",
            "command": null,
            "user": null,
            "dockerLabels": {
                "com.myself.name": "neuvector"
            },
            "logConfiguration": null,
            "cpu": 0,
            "privileged": true,
            "memoryReservation": 512
        }
    ],
    "volumes": [
        {
            "host": {
                "sourcePath": "/lib/modules"
            },
            "name": "modules"
        },
        {
            "host": {
                "sourcePath": "/var/run/docker.sock"
            },
            "name": "dockersock"
        },
        {
            "host": {
                "sourcePath": "/proc"
            },
            "name": "proc"
        },
        {
            "host": {
                "sourcePath": "/sys/fs/cgroup"
            },
            "name": "cgroup"
        }
    ],
    "family": "my-enforcer",
    "placementConstraints": []
}
----
====

== Live-Aktualisierung {product-name}

Sie können ein Live-Update der {product-name} Container in ECS durchführen, ohne die Dienste zu unterbrechen. Die Dienste von {product-name} können einfach aktualisiert oder aufgerüstet werden, ohne dass laufende Dienste unterbrochen werden. Um dies in Amazon ECS zu tun:

. Wenn Sie mehrere Controller oder Allinones als Cluster bereitgestellt haben, ignorieren Sie diesen Schritt. Wenn sich nur ein einzelner Allinone/Controller im System befindet, finden Sie eine neue ECS-Instanz und stellen Sie einen 2. Allinone/Controller-Container darauf bereit (folgen Sie den {product-name} Allinone/Controller ECS-Bereitstellungsschritten). Nach der Bereitstellung sehen Sie in der {product-name} Verwaltungs-Konsole diesen neuen Controller, der aktiv ist (unter Ressourcen > Controller). Dies ist erforderlich, damit alle zustandsbehafteten Daten zwischen den Controllern repliziert werden.
. Setzen Sie in den ECS-Diensten den alten Allinone/Controller-Dienst zurück und löschen Sie ihn. Ziehen Sie die aktualisierten {product-name} Bilder manuell oder lösen Sie AWS ECS aus, um neue Versionen der Allinone/Controller-Container von Dockerhub oder Ihrem privaten Repository abzurufen.
. Erstellen Sie eine neue Revision der Allinone/Controller-Aufgabe, aktualisieren Sie die "+\`CLUSTER_JOIN_ADDR`" auf die private IP-Adresse des 2. Allinone/Controllers.
. Erstellen Sie einen neuen Dienst, um diese neue Aufgabe bereitzustellen (folgen Sie denselben Schritten zur Bereitstellung in ECS). Nach Abschluss sollte die neue Version des Allinone/Controllers aktiv sein. Von der {product-name} Verwaltungs-Konsole sollten alle Protokolle und Richtlinien weiterhin vorhanden sein. Optional können Sie den 2. Allinone/Controller-Container jetzt herunterfahren, da jetzt ein Allinone/Controller auf dem ursprünglichen Knoten gestartet sein sollte.
. Fahren Sie die Enforcer von den ECS-Diensten herunter und aktualisieren Sie sie. Ziehen Sie manuell oder automatisch die neuen Enforcer-Bilder ab. Starten oder aktualisieren Sie dann den Enforcer auf allen Knoten neu. Von der {product-name} Konsole aus sehen Sie, dass alle Enforcer auf dem neuesten Stand sind.
. Wenn Sie den separaten Manager-Container anstelle des Allinone verwenden (der bereits den Manager enthält), fahren Sie einfach den alten Manager-Container herunter und entfernen Sie ihn. Ziehen Sie dann die neue Manager-Version ab und stellen Sie sie bereit, wobei Sie die CLUSTER_JOIN_ADDR auf die IP des Controllers verweisen.

Alle {product-name} Container sind jetzt live aktualisiert. Alle Richtlinien, Protokolle und Konfigurationen sind nicht betroffen. Die Live-Diagrammansicht wird automatisch neu generiert, sobald neuer Live-Verkehr zwischen Containern fließt.
