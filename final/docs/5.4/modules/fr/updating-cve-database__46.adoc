= Mise à jour de la base de données CVE
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /06.scanning/05.updating/05.updating.md
:page-opendocs-slug:  /scanning/updating

== Mise à jour de la base de données de vulnérabilités CVE {product-name} 

Le Scanner image/pod effectue les analyses à l'aide de sa base de données CVE interne. L'image du scanner est mise à jour sur le registre {product-name} Docker Hub avec la dernière base de données CVE fréquemment, voire quotidiennement s'il y a des mises à jour. Pour mettre à jour la base de données CVE utilisée pour l'analyse, il suffit d'extraire et de déployer la dernière image du scanner. Le dernier numéro de version de la base de données peut être trouvé dans la liste https://raw.githubusercontent.com/neuvector/manifests/main/versions/scanner[ici.]

Un conteneur appelé Updater se charge de redémarrer les pods d'analyse afin de forcer l'extraction de la dernière image, qui mettra à jour la base de données CVE. Pour vérifier automatiquement les mises à jour et mettre à jour le scanner, il est possible de créer une tâche cron de mise à jour.

Par défaut, la tâche cron de mise à jour présentée ci-dessous est automatiquement lancée à partir des exemples de fichiers yaml de déploiement pour Kubernetes et OpenShift. Il vérifiera automatiquement les nouvelles mises à jour de la base de données CVE par le biais des nouvelles versions des scanners publiées sur le registre du hub Docker {product-name}. Les mises à jour manuelles sur les déploiements natifs de Docker sont indiquées ci-dessous. Pour les déploiements OpenShift ou autres où les images doivent être extraites manuellement de {product-name}, l'analyseur avec la balise "latest" doit être extrait de {product-name} pour mettre à jour la base de données CVE.

Pour l'analyse du registre, si la case "Rescanner après la mise à jour de la base de données CVE" est activée, toutes les images de ce registre seront réanalysées après une mise à jour de la base de données CVE.  Pour l'analyse en cours d'exécution, tous les actifs en cours d'exécution seront réanalysés après une mise à jour de la base de données CVE si la fonction d'analyse automatique est activée.

=== Updater Cron Job

Cette tâche cron est déployée automatiquement par {product-name} dans le cadre de l'exemple de déploiement, et il n'est donc pas nécessaire de la lancer manuellement.

L'Updater est une image conteneur qui, lorsqu'elle est exécutée, redémarre le déploiement du scanner, forçant l'extraction de la dernière image du scanner. L'outil de mise à jour redéploie tous les pods d'analyse en ramenant le déploiement à zéro et en l'augmentant.

L'exemple de job cron neuvector-updater.yaml ci-dessous pour Kubernetes 1.8 et les versions ultérieures exécute le programme de mise à jour tous les jours à minuit. L'horaire peut être modifié à volonté.

Exemple d'updater yaml :

[,yaml]
----
apiVersion: batch/v1
kind: CronJob
metadata:
  name: neuvector-updater-pod
  namespace: neuvector
spec:
  schedule: "0 0 * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: neuvector-updater-pod
        spec:
          containers:
          - name: neuvector-updater-pod
            image: neuvector/updater
            imagePullPolicy: Always
            command:
            - /bin/sh
            - -c
            - TOKEN=`cat /var/run/secrets/kubernetes.io/serviceaccount/token`; /usr/bin/curl -kv -X PATCH -H "Authorization:Bearer $TOKEN" -H "Content-Type:application/strategic-merge-patch+json" -d '{"spec":{"template":{"metadata":{"annotations":{"kubectl.kubernetes.io/restartedAt":"'`date +%Y-%m-%dT%H:%M:%S%z`'"}}}}}' 'https://kubernetes.default/apis/apps/v1/namespaces/neuvector/deployments/neuvector-scanner-pod'
          restartPolicy: Never
----

[NOTE]
====
Si le conteneur allinone a été déployé à la place du contrôleur, remplacez neuvector-svc-controller.neuvector par neuvector-svc-allinone.neuvector.
====

Pour exécuter la tâche cron

[,shell]
----
kubectl create -f neuvector-updater.yaml
----

== Mises à jour de Docker Native

[IMPORTANT]
====
Utilisez toujours la balise :latest lors de l'extraction et de l'exécution de l'image scanner afin de vous assurer que la dernière base de données CVE est déployée.
====

Pour docker native :

[,shell]
----
docker stop scanner
docker rm <scanner id>
docker pull neuvector/scanner:latest
<docker run command from below>
----

[NOTE]
====
`docker rm -f <scanner id>` peut également être utilisée pour forcer l'arrêt et la suppression de l'analyseur en cours.
====

Pour docker-compose

[,shell]
----
docker-compose -f file.yaml down
docker-compose -f file.yaml pull        // pre-pull the image before starting the scanner
docker-compose -f file.yaml up -d
----

Exemple d'exécution de docker

[,bash]
----
docker run -td --name scanner -e CLUSTER_JOIN_ADDR=controller_node_ip -e CLUSTER_ADVERTISED_ADDR=node_ip -e SCANNER_DOCKER_URL=tcp://192.168.1.10:2376 -p 18402:18402 -v /var/run/docker.sock:/var/run/docker.sock:ro neuvector/scanner:latest
----

Et exemple de docker-compose

[,yaml]
----
Scanner:
   image: neuvector/scanner:latest
   container_name: scanner
   environment:
     - SCANNER_DOCKER_URL=tcp://192.168.1.10:2376
     - CLUSTER_JOIN_ADDR=controller_node_ip
     - CLUSTER_ADVERTISED_ADDR=node_ip
   ports:
     - 18402:18402
   volumes:
     - /var/run/docker.sock:/var/run/docker.sock:ro
----

== Version de la base de données CVE

La version de la base de données CVE peut être consultée dans la console, dans l'onglet Vulnérabilités. Vous pouvez également consulter les journaux du conteneur d'analyse ou l'image de mise à jour.

Pour utiliser l'API REST afin d'interroger la version :

[,shell]
----
curl -k -H "Content-Type: application/json" -H "X-Auth-Token: $_TOKEN_" "https://127.0.0.1:10443/v1/scan/scanner"
----

Sortie :

[,json]
----
{
    "scanners": [
        {
            "cvedb_create_time": "2020-07-07T10:34:04Z",
            "cvedb_version": "1.950",
            "id": "0f043705948557828ac1831ee596588a0d050950113117ddd19ecd604982f4d9",
            "port": 18402,
            "server": "127.0.0.1"
        },
        {
            "cvedb_create_time": "2020-07-07T10:34:04Z",
            "cvedb_version": "1.950",
            "id": "9fa02c644d603f59331c95735158d137002d32a75ed1014326f5039f38d4d717",
            "port": 18402,
            "server": "192.168.9.95"
        }
    ]
}
----

Utilisation de kubectl :

[,bash]
----
kubectl logs neuvector-scanner-pod-5687dcb6fd-2h4sj -n neuvector | grep version
----

Exemple de sortie :

[,shell]
----
2020-09-15T00:00:57.909|DEBU|SCN|memdb.ReadCveDb: New DB found - update=2020-09-14T10:37:56Z version=2.04
2020-09-15T00:01:10.06 |DEBU|SCN|main.scannerRegister: - entries=47016 join=neuvector-svc-controller.neuvector:18400 version=2.040
----

Ou pour docker :

[,bash]
----
docker logs <scanner container id or name> | grep version
----

[,shell]
----
2020-09-15T00:00:57.909|DEBU|SCN|memdb.ReadCveDb: New DB found - update=2020-09-14T10:37:56Z version=2.04
2020-09-15T00:01:10.06 |DEBU|SCN|main.scannerRegister: - entries=47016 join=neuvector-svc-controller.neuvector:18400 version=2.040
----

== Mises à jour manuelles sur Kubernetes

Voici un exemple de mise à jour manuelle de la base de données CVE sur Kubernetes ou OpenShift.

Exécutez le fichier de mise à jour ci-dessous

[,shell]
----
kubectl create -f neuvector-manual-updater.yaml
----

Exemple de fichier

[,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: neuvector-updater-pod
  namespace: neuvector
spec:
  containers:
  - name: neuvector-updater-pod
    image: neuvector/updater
    imagePullPolicy: Always
    command:
    - /bin/sh
    - -c
    - TOKEN=`cat /var/run/secrets/kubernetes.io/serviceaccount/token`; /usr/bin/curl -kv -X PATCH -H "Authorization:Bearer $TOKEN" -H "Content-Type:application/strategic-merge-patch+json" -d '{"spec":{"template":{"metadata":{"annotations":{"kubectl.kubernetes.io/restartedAt":"'`date +%Y-%m-%dT%H:%M:%S%z`'"}}}}}' 'https://kubernetes.default/apis/apps/v1/namespaces/neuvector/deployments/neuvector-scanner-pod'
  restartPolicy: Never
----
