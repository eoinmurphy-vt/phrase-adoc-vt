= Numérisation GCR à l'aide de comptes de service
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /06.scanning/02.registry/03.gcr-sa/03.gcr-sa.md
:page-opendocs-slug:  /scanning/registry/gcr-sa

== Google GCR - Authentification/Scanner avec les comptes de service GCP

Une bonne pratique consiste à ne pas dépendre des comptes attribués aux utilisateurs pour les intégrations.  GCP permet d'utiliser un compte de service pour accéder à GCR.  Voici les étapes pour activer un compte de service pour la GCR et l'utiliser pour déclencher des analyses de référentiel à partir de {product-name}.

Commencez par {product-name}, où l'on crée d'abord un nouveau registre :

image:gcr1.png[GCR]

En sélectionnant Google Container Registry comme type de dépôt, ce panneau est personnalisé pour accepter les données nécessaires à l'utilisation de votre GCR.

. Name - C'est ici que vous donnez à cette entrée de repo particulière un nom de votre choix. Il s'agit simplement de l'identifier ultérieurement dans l'interface {product-name}.
. Registre - C'est le premier endroit où vous voudrez vous assurer que les données correctes sont collectées à partir de votre instance GCR. Bien que l'exemple de https://gcr.io soit le plus courant, nous devons nous assurer qu'il reflète exactement la manière dont votre GCR a été mis en place dans GCP. Il peut s'agir de https://us.gcr.io par exemple. Nous le vérifierons dans la section suivante.
. Clé JSON - Comme il va de soi, il s'agit d'une clé au format JSON. Et, comme vous le voyez probablement, nous trouverons cela par le biais du GCP.
. Filter - Soyez conscient que vous devrez probablement remplacer tous les filtres ici par le nom réel du repo. Là encore, il s'agit de l'interface GCR.

image:gcr2.png[GCR]

Passons maintenant à l'écran GCR dans GCP. Une grande partie de ce dont nous avons besoin se trouve sur cette page.

[upperalpha]
. Voir le site "`gcr.io`" sous Hostname ? C'est ce qu'il faut faire à l'article 2, Registre dans l'interface {product-name}. (N'oubliez pas la partie \https://)
. L'ID du repo se trouve en fait sous le projet de premier niveau. C'est ce que vous utiliserez au point 3, Filtre. Voir l'exemple de env-demo ci-dessous.

image:gcr3.png[GCR]

La clé JSON nous amène à explorer une autre étape très importante, qui nous conduit à la section IAM & Admin de GCP où nous allons créer (ou confirmer la configuration) un compte de service. Voir ci-dessous :

image:gcr4.png[GCR]

Une fois que vous avez saisi les données pour la première étape de la création d'un compte de service, vous devez appuyer sur le bouton "`CREATE`" pour que l'étape 2 soit prête à accepter les données saisies.

image:gcr5.png[GCR]

Veillez à sélectionner Basic --> Viewer pour l'accès. Si vous disposez d'un compte de service existant, assurez-vous que l'accès est défini de cette manière. (Indice : Même les autorisations d'accès qui semblent plus puissantes ne semblent pas permettre un accès correct. Ne sautez pas cette étape.

Une fois cette étape franchie, vous pouvez passer rapidement l'étape 3 et procéder à la création du compte de service.

Si vous n'arrivez pas immédiatement sur le panneau d'information de votre nouveau compte de service, assurez-vous d'y aller dans la liste des comptes de service. Voir la figure 5 ci-dessous.

image:gcr6.png[GCR]

Cliquez sur "`ADD KEY`" --> "`Create New Key`"

image:gcr7.png[GCR]

Comme vous l'avez déjà conclu, JSON est la solution idéale. En sélectionnant "`CREATE`", vous obtiendrez un fichier que vous pourrez télécharger dans votre navigateur. Le contenu de ce fichier doit être collé dans le champ 3, JSON Key dans {product-name}; voir figure 1.

Avant d'être trop enthousiaste, il faut encore s'assurer d'une chose. Pour que le scanner de {product-name} puisse utiliser l'API pour numériser et protéger vos images, cette API doit être activée dans votre compte GCP. Vous pouvez l'activer en ligne de commande via

[,shell]
----
gcloud services enable artifactregistry.googleapis.com
----

Vous pouvez également utiliser l'interface utilisateur de GCP. Rendez-vous sur "`API Library`", recherchez "`Artifact Registry API`" et assurez-vous qu'il est activé pour votre projet. Voir figure 7.

image:gcr8.png[GCR]

Vous devriez être prêt ! La figure 8 ci-dessous présente un registre correctement configuré à l'aide des données de notre exemple :

image:gcr9.png[GCR]

=== Obtenir le jeton d'accès à l'aide de l'API REST

L'API REST de {product-name} peut être utilisée pour s'authentifier à l'aide du compte de service. L'exemple ci-dessous utilise gcloud pour obtenir le jeton d'accès.  Le nom d'utilisateur est "`oauth2accesstoken`".

[,shell]
----
gcloud auth print-access-token
ya29.a0AfH6SMAvyZ2zkD3MZD_K8Lqr7qkIsRkGNqhAGthJ_A7lp8OGRe7xh5KmuQY-VJfqu83C9e1gi7A_m1InNm8QIoTGf9WHXnOeAr1gT_O6b6K667NUz1_YDunjdW09jt0XvcBGQaxjJ3c4aHlxdehBFiE_9PMk13JDt_T6f0_6vzS7
----

=== Utiliser le jeton avec {product-name} Repository Scanning

L'exemple de script ci-dessous intègre le jeton d'accès pour déclencher l'analyse du référentiel GCR.

[,shell]
----
_curCase_=`echo $0 | awk -F"." '{print $(NF-1)}' | awk -F"/" '{print $NF}'`
_DESC_="able to scan ubuntu:16.04 image"
_ERRCODE_=0
_ERRTYPE_=1
_RESULT_="pass"

# please remember to specify the controller ip address here
_controllerIP_="10.1.24.252"
_controllerRESTAPIPort_="10443"
_neuvectorUsername_="admin"
_neuvectorPassword_="admin"
_registryURL_="https://us.gcr.io/"

# registry urls could also be gcr.io, eu.gcr.io, asia.gcr.io etc
_registryUsername_="oauth2accesstoken"
_registryPassword_=$(gcloud auth print-access-token)
_repository_="bionic-union-271100/alpine"
_tag_="latest"

curl -k -H "Content-Type: application/json" -d '{"password": {"username": "'$_neuvectorUsername_'", "password": "'$_neuvectorPassword_'"}}' "https://$_controllerIP_:$_controllerRESTAPIPort_/v1/auth" > /dev/null 2>&1 > token.json
_TOKEN_=`cat token.json | jq -r '.token.token'`
echo `date +%Y%m%d_%H%M%S` scanning an image ...
curl -k -H "Content-Type: application/json" -H "X-Auth-Token: $_TOKEN_" -d '{"request": {"registry": "'$_registryURL_'", "username": "'$_registryUsername_'", "password": "'$_registryPassword_'", "repository": "'$_repository_'", "tag": "'$_tag_'"}}' "https://$_controllerIP_:$_controllerRESTAPIPort_/v1/scan/repository" > /dev/null 2>&1 > scan_repository.json

while [ `wc -c < scan_repository.json` = "0" ]; do
 echo `date +%Y%m%d_%H%M%S` scanning is still in progress ...
    sleep 5
    curl -k -H "Content-Type: application/json" -H "X-Auth-Token: $_TOKEN_" -d '{"request": {"registry": "'$_registryURL_'", "username": "'$_registryUsername_'", "password": "'$_registryPassword_'", "repository": "'$_repository_'", "tag": "'$_tag_'"}}' "https://$_controllerIP_:$_controllerRESTAPIPort_/v1/scan/repository" > /dev/null 2>&1 > scan_repository.json
done

echo `date +%Y%m%d_%H%M%S` log out
curl -k -X 'DELETE' -H "Content-Type: application/json" -H "X-Auth-Token: $_TOKEN_" "https://$_controllerIP_:$_controllerRESTAPIPort_/v1/auth" > /dev/null 2>&1
cat scan_repository.json | jq .
rm *.json
echo `date +%Y%m%d_%H%M%S` [$_curCase_] $_DESC_: $_RESULT_-$_ERRCODE_
----
