= Règles d'accès aux fichiers
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /05.policy/07.filerules/07.filerules.md
:page-opendocs-slug:  /policy/filerules

== Politique : Règles d'accès aux fichiers

Il existe deux types de protection des processus/fichiers sur le site {product-name}. La première est la dérive zéro, dans laquelle les processus autorisés et l'activité des fichiers sont automatiquement déterminés sur la base de l'image du conteneur, et la seconde est basée sur l'apprentissage comportemental. Chacune d'entre elles peut être personnalisée (règles ajoutées manuellement) si nécessaire.

{product-name} dispose d'une détection intégrée de l'activité suspecte du système de fichiers. Les fichiers sensibles contenus dans les conteneurs ne sont normalement pas modifiés lors de l'exécution. En modifiant le contenu des fichiers sensibles, un attaquant peut obtenir des privilèges non autorisés, comme dans l'attaque du noyau linux Dirty-Cow, ou porter atteinte à l'intégrité du système, par exemple en manipulant le fichier /etc/hosts. La plupart des conteneurs ne fonctionnent pas en mode lecture seule. Toute activité suspecte dans les conteneurs, les hôtes ou le conteneur {product-name} Enforcer lui-même sera détectée et enregistrée dans Notifications -> Security Events.

=== Protection des fichiers sans dérive

Il s'agit du mode par défaut pour la protection des processus et des fichiers. La dérive zéro n'autorise automatiquement que les processus provenant du processus parent qui se trouve dans l'image originale du conteneur, et ne permet pas l'installation de mises à jour de fichiers ou de nouveaux fichiers. En mode découverte ou surveillance, zero-drift émet des alertes en cas d'activité suspecte d'un processus ou d'un fichier. En mode protection, il bloque ce type d'activité. Zero-drift n'exige pas que l'activité d'un fichier soit ajoutée à une liste d'autorisation. La désactivation de la dérive zéro pour un groupe entraîne l'application des règles relatives aux processus et aux fichiers répertoriées pour ce groupe.

[NOTE]
====
Les règles de traitement/fichier répertoriées pour chaque groupe sont toujours appliquées, même lorsque la dérive zéro est activée. Il s'agit d'un moyen d'ajouter des exceptions aux protections de base contre la dérive zéro. Gardez à l'esprit que si un groupe démarre en mode découverte, des règles de processus/fichier peuvent être automatiquement ajoutées à la liste et doivent être revues et modifiées avant de passer en mode surveillance/protection.
====

La possibilité d'activer/désactiver le mode dérive zéro se trouve dans la console, sous Policy -> Groups. Plusieurs groupes peuvent être sélectionnés pour faire basculer ce paramètre pour tous les groupes sélectionnés.

=== Protections de base des fichiers

Si l'installation d'un paquet est détectée, une nouvelle analyse automatique du conteneur ou de l'hôte sera déclenchée pour détecter d'éventuelles vulnérabilités, SI l'analyse automatique a été activée dans Risques de sécurité -> Vulnérabilités.

Outre la surveillance de fichiers/répertoires prédéfinis, les utilisateurs peuvent ajouter des fichiers/répertoires personnalisés à surveiller et bloquer la modification de ces fichiers/répertoires.

[IMPORTANT]
====
{product-name} et ne bloque pas les modifications des fichiers/répertoires prédéfinis ou dans les conteneurs système tels que ceux de Kubernetes. Le blocage n'est une option que pour les fichiers/répertoires personnalisés configurés par l'utilisateur pour les conteneurs hors système. Ainsi, les mises à jour régulières du dossier système ou les configurations sensibles ne sont pas bloquées involontairement, ce qui entraîne un comportement erratique du système.
====

Les fichiers et répertoires suivants sont surveillés par défaut :

* Fichiers exécutables
* Fichiers setuid/setgid sensibles
* Bibliothèques système, libc, pthread, ...
* Installation de paquets, Debian/Ubuntu, RedHat/CentOS, Alpine
* Fichiers système sensibles, /etc/passwd, /etc/hosts, /etc/resolv.conf ...
* Exécution des fichiers exécutables des processus

Les activités suivantes sont contrôlées :

* Fichiers, répertoires, liens symboliques (hard link et soft link)
* créé, supprimé, modifié (changement de contenu) et déplacé

Vous trouverez ci-dessous une liste de la surveillance du système de fichiers et de ce qui est surveillé (conteneur, hôte/nœud, et/ou conteneur {product-name} enforcer lui-même) :

* /bin, /usr/bin, /usr/sbin, /usr/local/bin - conteneur, exécutant
* Fichiers des attributs setuid et setgid - container, host, enforcer
* Bibliothèques : libc, pthread, ld-linux.* - container, host, enforcer
* Installation de paquets : dpkg, rpm, apk - container, host, enforcer
* /etc/hosts, /etc/passwd, /etc/resolv.conf - conteneur, hôte, exécutant
* Binaires des processus en cours d'exécution - conteneur

=== Applications autorisées basées sur l'apprentissage comportemental en mode découverte

En mode découverte, {product-name} peut apprendre et mettre sur liste blanche des applications UNIQUEMENT pour des répertoires ou des fichiers spécifiés. Pour activer l'apprentissage, une règle personnalisée doit être créée et l'action doit être définie sur Bloquer, comme décrit ci-dessous.

=== Création de règles personnalisées de surveillance des fichiers/répertoires

Des règles d'accès aux fichiers personnalisées peuvent être créées pour les groupes personnalisés définis par l'utilisateur ainsi que pour les groupes appris automatiquement.

Les utilisateurs peuvent ajouter de nouvelles entrées pour les règles relatives aux fichiers/répertoires.

* Filtre : Configurer le fichier/dossier à protéger (les caractères génériques sont pris en charge)
* Définir le drapeau récursif (si tous les fichiers des sous-répertoires doivent être protégés)
* Sélectionnez l'action, Surveiller ou Bloquer (voir Actions ci-dessous).
* Saisir les applications autorisées (voir note 1 ci-dessous)

image:file_rules.png[Règles relatives aux fichiers]

Actions :

* Surveiller les modifications de fichiers. Générer des alertes (notifications) pour tout changement
* Bloquer les accès non autorisés.
** Service en mode découverte : le comportement d'accès au fichier est appris (les processus/applications qui accèdent au fichier protégé) et ajouté aux applications autorisées.
** Service en mode surveillance : le comportement inattendu d'un fichier est signalé.
** Service en mode protection : l'accès inattendu (lecture, modification) est bloqué. La création de nouveaux fichiers dans les dossiers protégés sera également bloquée.

[NOTE]
====
Si la règle est définie sur Bloquer et que le service est en mode Découverte, {product-name} apprend les applications qui accèdent au fichier et les ajoute aux applications autorisées pour la règle.
====

[NOTE]
====
Les plates-formes de conteneurs utilisant le pilote de stockage AUFS ne prendront pas en charge l'action de refus (bloc) en mode protection pour la création/modification de fichiers en raison des limitations du pilote. Le comportement sera le même qu'en mode surveillance, avec des alertes en cas d'activité suspecte.
====

=== Ordre de préséance des règles d'accès aux fichiers

Un conteneur peut hériter des règles d'accès aux fichiers de plusieurs groupes personnalisés et des règles d'accès aux fichiers créées par l'utilisateur sur un groupe appris automatiquement.

Les règles d'accès aux fichiers sont classées par ordre de priorité dans l'ordre ci-dessous si le nom du fichier est en conflit avec les règles d'accès prédéfinies du groupe d'apprentissage automatique et avec les règles héritées de plusieurs groupes.

* Règle d'accès aux fichiers avec accès par bloc (ordre le plus élevé)
* Règle d'accès aux fichiers avec récursivité activée
* Règle d'accès aux fichiers avec désactivation récursive
* Règles d'accès aux fichiers créées par l'utilisateur autres que les règles d'accès aux fichiers prédéfinies

==== Exemples

Afficher une règle d'accès aux fichiers pour protéger le fichier /etc/hostname du service node-pod et permettre à l'application vi de modifier le fichier.

image:example1.png[Règles relatives aux fichiers]

Affichage d'une règle d'accès aux fichiers pour protéger les fichiers du répertoire /var/opt/ de manière récursive, tant pour la modification que pour la lecture. L'application autorisée python peut accéder à ces fichiers en lecture et en modification.

image:example2.png[Règles relatives aux fichiers]

Afficher la règle d'accès qui protège le fichier /etc/passwd, qui est l'un des fichiers couverts par la règle d'accès prédéfinie afin de modifier l'action d'accès au fichier, aussi bien pour la modification que pour la lecture. Cette règle personnalisée modifie l'action par défaut de la règle d'accès aux fichiers prédéfinie. L'application Nano peut accéder à ces fichiers en lecture et en modification. Il faut également ajouter l'application Nano (processus) en tant que règle "allow" dans la règle du profil de processus pour ce service afin d'exécuter l'application Nano à l'intérieur du service (si elle n'est pas déjà sur liste blanche), sinon le processus sera bloqué par {product-name}.

image:example3.png[Règles relatives aux fichiers]

Montrant que l'application python a appris à accéder à un fichier dans le répertoire /var/opt lorsque le mode de service de node-pod était en Discover. Cela ne se produit que lorsque la règle est définie sur Bloquer et que le service est en mode Découverte.

image:example4.png[Règles relatives aux fichiers]

Afficher les règles d'accès aux fichiers prédéfinies pour le service node-pod.demo-nvqa. Cette information peut être consultée pour ce service en cliquant sur l'icône d'information "`show predefined filters`" dans le coin droit de l'onglet des règles d'accès aux fichiers.

image:predefined.png[Règles relatives aux fichiers]

Présentation d'un exemple d'événement de sécurité dans Notifications -> Security Events, alerté comme File access denial lorsque la modification du fichier /etc/hostname par l'application python a été refusée en raison d'une règle personnalisée d'accès aux fichiers avec une action de blocage.

image:securityevent.png[Règles relatives aux fichiers]

=== Autres réponses

Si d'autres mesures d'atténuation, réponses ou alertes spéciales sont souhaitées pour les violations du système de fichiers, une règle de réponse peut être créée. Pour plus de détails, voir l'exemple ci-dessous et la section Politique de sécurité en temps réel -> Response Rules (Règles de réponse).

image:file-response1.png[FileResponse]

== Protection des fichiers en mode fractionné

Les groupes de conteneurs peuvent avoir des règles de processus/fichier dans un mode différent des règles de réseau, comme décrit xref:modes.adoc#_network_service_policy_mode[ici.]
