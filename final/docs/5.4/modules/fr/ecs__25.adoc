= Amazon ECS
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /02.deploying/09.ecs/09.ecs.md
:page-opendocs-slug: /déploiement/ecs

== Important : Le déploiement sur Amazon ECS n'est plus pris en charge

La section de référence ci-dessous n'est pas maintenue. Cependant, il peut aider à comprendre comment déployer l'Allinone sur ECS.

== Déploiement sur AWS à l'aide d'ECS

Voici un exemple de déploiement de {product-name} à l'aide d'ECS.

[NOTE]
====
Veuillez consulter les exemples de Kubernetes pour l'EKS.
====

. Préparez plusieurs instances Amazon ECS qui intègrent le moteur Docker et les conteneurs de l'agent ECS. Choisissez un nœud pour la console de gestion. Définissez ensuite des règles de groupe de sécurité qui autorisent le port TCP entrant 8443 (port par défaut de la console de gestion de{product-name}) pour l'accès par votre navigateur client.
. Définir un groupe de sécurité qui autorise les ports TCP et UDP sur 18300, 18301, 18400, 18401. Elle est utilisée par les agents d'exécution du site {product-name} pour communiquer avec les contrôleurs/Allinone. Appliquez ce groupe de sécurité à toutes les instances ECS qui déploieront les enforcers {product-name} et les controllers/allinone.
. Définissez un attribut sur les nœuds que vous souhaitez déployer {product-name} allinone ou controller container. Par exemple, si vous souhaitez exécuter {product-name} en mode contrôleur HA, il est recommandé de choisir au moins 3 nœuds, puis d'ajouter l'attribut à ces 3 nœuds.
+
--
Voici comment ajouter des attributs à vos instances ECS :

Sélectionnez l'instance, puis choisissez "`View/Edit Attributes`" dans le menu déroulant Actions.

image:1viewattributes.png[Attributs]

Ajoutez ensuite un nouvel attribut. Par exemple "`allinone-node`" avec la valeur "`true`".

image:2addattribute.png[AddAttributes]
--
. Créer la définition de la tâche Allinone. Créer une nouvelle définition de tâche pour le conteneur Allinone. Vous pouvez utiliser l'interface ECS pour le créer manuellement ou coller l'exemple de fichier JSON (voir ci-dessous pour des exemples). Reportez-vous à la section "`1. Deploying {product-name}`" de ces documents pour savoir comment configurer l'Allinone.
+
--
Saisissez la contrainte de placement. Par exemple, si vous avez utilisé le libellé de l'attribut ci-dessus, indiquez-le dans la contrainte.

[,json]
----
attribute:allinone-node=~true
----

image:3taskdef.png[AllinoneTask]

[NOTE]
====
Si vous examinez le fichier JSON mis à jour, vous verrez que la contrainte de placement y a été ajoutée.
====
--
. Créer un nouveau service pour la tâche Allinone. Réglez l'adresse "`Placement Templates`" sur "`One Task Per Host`" afin qu'un seul Allinone/contrôleur puisse fonctionner sur un hôte. Vous verrez également que la contrainte sera utilisée "`memberOf(attribute:allinone-node=~true) qui exige que le nœud ait cet attribut.
+
--
image:3taskplacement.png[AllinonePlace]
--
. Vous pouvez maintenant déployer le service Allinone. Réglez le site "`Number of tasks`" sur le numéro d'Allinone/Contrôleur souhaité. Les conteneurs {product-name} Allinone ou Controller commenceront à fonctionner sur les nœuds sélectionnés. Après le démarrage de l'Allinone, vous devriez pouvoir vous connecter à la console {product-name} via HTTPS sur le port 8443.
. Créer la définition de la tâche de l'Enforcer. Cette tâche est similaire à celle d'Allinone. Configurez manuellement via la console ECS ou utilisez l'exemple JSON ci-dessous.
+
--
Pour la contrainte de placement de l'Enforcer, vous exigerez que l'Enforcer ne soit PAS sur le même nœud que l'allinone.

[,json]
----
attribute:allinone-node!~true
----

image:4enforcertask.png[EnforcerTask]
--
. Créez un nouveau service pour la tâche Enforcer. Encore une fois, définissez le placement des tâches sur "`One Task Per Host`" afin qu'un seul Enforcer soit déployé sur chaque hôte. Notez également que la contrainte supplémentaire doit montrer qu'elle empêche le déploiement sur un nœud allinone.
+
--
image:5taskplacement.png[EnforcerPlacement]

Déployer ce service avec le nombre souhaité de nœuds d'exécution à l'adresse "`Number of tasks`". Très bientôt, tous les agents d'exécution seront opérationnels. Dans la console {product-name}, vous pourrez voir tous les nœuds détectés par les enforcers.
--

== Exemple de définitions de tâches ECS JSON

Vous pouvez utiliser les exemples suivants comme points de départ pour configurer les définitions de tâches pour les conteneurs {product-name}.

Créez une nouvelle définition de tâche, puis cliquez sur Configurer via JSON en bas. Avant de coller le json ci-dessous, remplacez l'adresse IP et le chemin de l'image (trouvez REPLACE dans les exemples). En règle générale, l'adresse IP est l'adresse IP privée de l'instance AWS dans laquelle l'allinone sera exécutée. Vous pouvez également spécifier un nom de famille différent de my-allinone/my-enforcer (au bas du json).

Exemple de fichier json d'Allinone :

.Cliquez ici pour plus d'informations
[%collapsible]
====
[,json]
----
{
    "networkMode": "bridge",
    "taskRoleArn": null,
    "pidMode": "host",
    "containerDefinitions": [
        {
            "volumesFrom": [],
            "memory": null,
            "extraHosts": null,
            "dnsServers": null,
            "disableNetworking": null,
            "dnsSearchDomains": null,
            "portMappings": [
                {
                    "hostPort": 18300,
                    "containerPort": 18300,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18301,
                    "containerPort": 18301,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18400,
                    "containerPort": 18400,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18401,
                    "containerPort": 18401,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18301,
                    "containerPort": 18301,
                    "protocol": "udp"
                },
                {
                    "hostPort": 8443,
                    "containerPort": 8443,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 1443,
                    "containerPort": 10443,
                    "protocol": "tcp"
                }
            ],
            "hostname": null,
            "essential": true,
            "entryPoint": null,
            "mountPoints": [
                {
                    "containerPath": "/lib/modules",
                    "sourceVolume": "modules",
                    "readOnly": null
                },
                {
                    "containerPath": "/var/run/docker.sock",
                    "sourceVolume": "dockersock",
                    "readOnly": null
                },
                {
                    "containerPath": "/host/proc",
                    "sourceVolume": "proc",
                    "readOnly": true
                },
                {
                    "containerPath": "/host/cgroup",
                    "sourceVolume": "cgroup",
                    "readOnly": true
                }
            ],
            "name": "allinone",
            "ulimits": null,
            "dockerSecurityOptions": null,
            "environment": [
                {
                    "name": "CLUSTER_JOIN_ADDR",
                    "value": "REPLACE: Private IP"
                }
            ],
            "links": null,
            "workingDirectory": null,
            "readonlyRootFilesystem": false,
            "image": "REPLACE: Image Path/Name",
            "command": null,
            "user": null,
            "dockerLabels": {
                "com.myself.name": "neuvector"
            },
            "logConfiguration": null,
            "cpu": 0,
            "privileged": true,
            "memoryReservation": 768
        }
    ],
    "volumes": [
        {
            "host": {
                "sourcePath": "/lib/modules"
            },
            "name": "modules"
        },
        {
            "host": {
                "sourcePath": "/var/run/docker.sock"
            },
            "name": "dockersock"
        },
        {
            "host": {
                "sourcePath": "/proc"
            },
            "name": "proc"
        },
        {
            "host": {
                "sourcePath": "/sys/fs/cgroup"
            },
            "name": "cgroup"
        }
    ],
    "family": "my-allinone",
    "placementConstraints": []
}
----
====

Exemple de fichier json Enforcer :

.Cliquez ici pour plus d'informations
[%collapsible]
====
[,json]
----
{
    "networkMode": "bridge",
    "taskRoleArn": null,
    "pidMode": "host",
    "containerDefinitions": [
        {
            "volumesFrom": [],
            "memory": null,
            "extraHosts": null,
            "dnsServers": null,
            "disableNetworking": null,
            "dnsSearchDomains": null,
            "portMappings": [
                {
                    "hostPort": 18301,
                    "containerPort": 18301,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18401,
                    "containerPort": 18401,
                    "protocol": "tcp"
                },
                {
                    "hostPort": 18301,
                    "containerPort": 18301,
                    "protocol": "udp"
                }
            ],
            "hostname": null,
            "essential": true,
            "entryPoint": null,
            "mountPoints": [
                {
                    "containerPath": "/lib/modules",
                    "sourceVolume": "modules",
                    "readOnly": null
                },
                {
                    "containerPath": "/var/run/docker.sock",
                    "sourceVolume": "dockersock",
                    "readOnly": null
                },
                {
                    "containerPath": "/host/proc",
                    "sourceVolume": "proc",
                    "readOnly": true
                },
                {
                    "containerPath": "/host/cgroup",
                    "sourceVolume": "cgroup",
                    "readOnly": true
                }
            ],
            "name": "enforcer",
            "ulimits": null,
            "dockerSecurityOptions": null,
            "environment": [
                {
                    "name": "CLUSTER_JOIN_ADDR",
                    "value": "REPLACE: Private IP"
                }
            ],
            "links": null,
            "workingDirectory": null,
            "readonlyRootFilesystem": false,
            "image": "REPLACE: Image Path/Name",
            "command": null,
            "user": null,
            "dockerLabels": {
                "com.myself.name": "neuvector"
            },
            "logConfiguration": null,
            "cpu": 0,
            "privileged": true,
            "memoryReservation": 512
        }
    ],
    "volumes": [
        {
            "host": {
                "sourcePath": "/lib/modules"
            },
            "name": "modules"
        },
        {
            "host": {
                "sourcePath": "/var/run/docker.sock"
            },
            "name": "dockersock"
        },
        {
            "host": {
                "sourcePath": "/proc"
            },
            "name": "proc"
        },
        {
            "host": {
                "sourcePath": "/sys/fs/cgroup"
            },
            "name": "cgroup"
        }
    ],
    "family": "my-enforcer",
    "placementConstraints": []
}
----
====

== Mise à jour en direct {product-name}

Vous pouvez effectuer une mise à jour en direct des conteneurs {product-name} dans ECS sans interrompre les services. Les services {product-name} peuvent être facilement mis à jour ou mis à niveau sans interrompre les services en cours d'exécution. Pour ce faire dans Amazon ECS :

. Si vous disposez de plusieurs contrôleurs ou Allinones déployés en cluster, ignorez cette étape. S'il n'y a qu'un seul Allinone/contrôleur dans le système, trouvez une nouvelle instance ECS et déployez-y un deuxième conteneur Allinone/contrôleur (suivez les étapes de déploiement ECS de {product-name} allinone/contrôleur). Après le déploiement, dans la console de gestion {product-name}, vous verrez que ce nouveau contrôleur est opérationnel (sous Ressources > Contrôleurs). Cela est nécessaire pour que toutes les données avec état soient répliquées entre les contrôleurs.
. Dans ECS Services, réinitialisez et supprimez l'ancien service Allinone/contrôleur. Tirez manuellement les images {product-name} mises à jour ou demandez à AWS ECS de tirer les nouvelles versions des conteneurs Allinone/contrôleur depuis Dockerhub ou votre registre privé.
. Créez une nouvelle révision de la tâche Allinone/Contrôleur, mettez à jour le site "`CLUSTER_JOIN_ADDR`" avec l'adresse IP du nœud privé du deuxième Allinone/contrôleur.
. Créez un nouveau service pour déployer cette nouvelle tâche (suivez les mêmes étapes pour le déploiement sur ECS). Une fois cette opération terminée, la nouvelle version de l'Allinone/contrôleur devrait être opérationnelle. Depuis la console de gestion {product-name}, tous les journaux et toutes les politiques devraient toujours être présents. Optionnellement, vous pouvez fermer le 2ème conteneur Allinone/Controller maintenant puisqu'il devrait y avoir un Allinone/Controller maintenant démarré sur le nœud d'origine.
. À partir des services ECS, arrêtez et mettez à jour les Enforcers. Déclencher manuellement ou automatiquement l'extraction de nouvelles images Enforcer. Redémarrez ou mettez à jour l'Enforcer sur tous les nœuds. Dans la console {product-name}, vous verrez que tous les Enforcers sont à jour.
. Si vous utilisez le conteneur Manager séparé au lieu de l'Allinone (qui contient déjà le manager), il suffit d'arrêter et de supprimer l'ancien conteneur Manager. Ensuite, il faut extraire la nouvelle version du gestionnaire et la déployer, en faisant pointer le CLUSTER_JOIN_ADDR sur l'IP du contrôleur.

Tous les conteneurs {product-name} sont maintenant mis à jour en direct. Toutes les politiques, tous les journaux et toutes les configurations ne sont pas affectés. L'affichage du graphique en direct sera régénéré automatiquement dès qu'il y aura un nouveau trafic en direct entre les conteneurs.
