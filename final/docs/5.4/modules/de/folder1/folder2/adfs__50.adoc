= SAML (ADFS)
:revdate: 2025-05-08
:page-revdate: {revdate}
:page-opendocs-origin: /08.integration/06.adfs/06.adfs.md
:page-opendocs-slug:  /integration/adfs

== Einrichten der ADFS- und {product-name} -Integration

In diesem Abschnitt werden zunächst die Einrichtungsschritte in ADFS und anschließend in der Konsole {product-name} beschrieben.

=== ADFS-Einrichtung

. Klicken Sie in AD FS Management mit der rechten Maustaste auf "`Relying Party Trusts`" und wählen Sie "`Add Relying Party Trust...`".
+
image:adfs1.png[adfsSetup]

. Wählen Sie im Schritt Willkommen die Schaltfläche "`Start`".
+
image:adfs2.png[adfsSetup]

. Wählen Sie "`Enter data about the relying party manually`" und wählen Sie "`Next`".
+
image:adfs3.png[adfsSetup]

. Geben Sie einen eindeutigen Namen für das Feld Anzeigename ein und wählen Sie "`Next`".
+
image:adfs4.png[adfsSetup]

. Wählen Sie "`Next`", um die Token-Verschlüsselung zu überspringen.
+
image:adfs5.png[adfsSetup]

. Markieren Sie "`Enable support for the SAML 2.0 WebSSO protocol`" und geben Sie die SAML-Redirect-URI von der Seite {product-name} Einstellungen>SAML-Einstellungen in das Feld "`Relying party SAML 2.0 SSO service URL`" ein.  Wählen Sie "`Next`", um fortzufahren.
+
image:adfs6.png[adfsSetup]

. Geben Sie denselben SAML-Redirect-URI in das Feld "`Relying party trust identifier`" ein und klicken Sie auf "`Add`"; wählen Sie dann "`Next`", um fortzufahren.
+
image:adfs7.png[adfsSetup]

. Zugriffskontrolle anpassen; wählen Sie dann "`Next`", um fortzufahren.
+
image:adfs8.png[adfsSetup]

. Wählen Sie "`Next`", um fortzufahren.
+
image:adfs9.png[adfsSetup]

. Wählen Sie zum Abschluss "`Close`".
. Wählen Sie Richtlinie für die Erteilung von Ansprüchen bearbeiten...
+
image:adfs10-11.png[adfsSetup]

. Wählen Sie "`Add Rule...`" und wählen Sie "`Send LDAP Attributes as Claims`"; wählen Sie dann "`Next`".  Benennen Sie die Regel und wählen Sie Active Directory als Attributspeicher. Nur der ausgehende Anspruch Benutzername ist für die Authentifizierung erforderlich, wenn die Standardrolle eingestellt ist; andernfalls werden Gruppen für die Rollenzuordnung benötigt.  E-Mail ist fakultativ.
+
--
* SAM-Account-Name -> Benutzername
* E-Mail Adresse -> E-Mail
* Token-Gruppen -- Unqualifizierte Namen -> gruppen

image:adfs11-12.png[adfsSetup]
--
. Wählen Sie "`Add Rule...`" und wählen Sie "`Transform an Incoming Claim`"; wählen Sie dann "`Next`".  Benennen Sie die Regel und legen Sie das Feld fest, wie in der folgenden Abbildung dargestellt.  Das Format der ausgehenden Namens-ID muss Transient Identifier sein.
+
image:adfs12-13.png[adfsSetup]

=== {product-name} Einrichtung

. Identifizieren Sie Provider Single Sign-On URL
* Zeigen Sie Endpunkte unter AD FS-Verwaltung > Dienst an und verwenden Sie "`SAML 2.0/WS-Federation`" endpoint URL.
* Beispiel: `https://<adfs-fqdn>/adfs/ls`

. Identitätsanbieter Emittent
* Klicken Sie mit der rechten Maustaste auf AD FS in der AD FS-Verwaltungskonsole und wählen Sie "`Edit Federation Service Properties...`"; verwenden Sie die "`Federation Service identifier`".
* Beispiel: `http://<adfs-fqdn>/adfs/services/trust`

. X.509-Zertifikat
* Wählen Sie in der AD FS-Verwaltung Dienst > Zertifikat, klicken Sie mit der rechten Maustaste auf Token-signierendes Zertifikat und wählen Sie "`View Certificate...`"
* Wählen Sie die Registerkarte Details und klicken Sie auf "`Copy to File`"
* Speichern Sie sie als Base-64-kodierte x.509-Datei (.CER)
* Kopieren Sie den Inhalt der Datei und fügen Sie ihn in das Feld X.509-Zertifikat ein.

. Forderung der Gruppe
* Geben Sie den Namen des ausgehenden Anspruchs für die Gruppen ein.
* Beispiel: Gruppen

. Standard-Rolle
* Es wird empfohlen, "`None`" zu wählen, es sei denn, Sie möchten jedem authentifizierten Benutzer eine Standardrolle zuweisen.

. Rollenkarte
* Legen Sie die Gruppennamen der Benutzer für die entsprechende Rolle fest.  (Siehe Screenshot-Beispiel unten.)
+
image:nv_adfs1.png[NVadfsSetup]

=== Zuordnung von Gruppen zu Rollen und Namensräumen

Wie Sie Gruppen voreingestellten und benutzerdefinierten Rollen sowie Namespaces in {product-name} zuordnen können, erfahren Sie im Abschnitt xref:users.adoc#_mapping_groups_to_roles_and_namespaces[Benutzer und Rollen].

== Fehlersuche

. ADFS SamlResponseSignature muss entweder MessageOnly oder MessageAndAssertion sein.  Verwenden Sie den Befehl Get-AdfsRelyingPartyTrust, um ihn zu überprüfen oder zu aktualisieren.
+
image:nv_adfs2.png[adfsTroubleshooting]

. Zeitsynchronisation zwischen Kubernetes-Knoten x ADFS-Server

Für eine erfolgreiche Authentifizierung muss die Zeit zwischen den Kubernetes-Knoten und dem ADFS-Server übereinstimmen, um Probleme mit der Zeitsynchronisation oder Uhrendrift zu vermeiden.

Es wird empfohlen, einen https://en.wikipedia.org/wiki/Network_Time_Protocol[NTP-Server] mit gleichen Zeiteinstellungen auf allen Servern zu verwenden.

Bitte überprüfen Sie, ob die ADFS- und {product-name} -Hosts synchronisiert sind und die möglichen Verzögerungen nicht mehr als 10 Sekunden betragen. Sie können Linux- und Windows-Befehle verwenden, um Datum, Uhrzeit und NTP-Server-Aktivität zu überprüfen.

[TIP]
====
Sie können die Anmeldezeiten neu laden, indem Sie die Konfiguration in der Benutzeroberfläche {product-name} wie folgt deaktivieren und wieder aktivieren:

* Melden Sie sich bei {product-name} mit dem Benutzer Admin an.
* Gehen Sie zu Einstellungen
* Klicken Sie auf die Schaltfläche, um die SAML-Einstellung zu aktivieren und zu deaktivieren
** *Achten Sie darauf, dass Sie die Konfigurationseinstellungen beibehalten!*

Sobald die Einstellung wieder aktiviert ist, können Sie versuchen, sich mit einem ADFS-Benutzer anzumelden. Wenn es funktioniert, bestätigt dies, dass das Problem auf einen Zeitsynchronisationsfehler zwischen Kubernetes-Knoten und dem ADFS-Server zurückzuführen ist.
====

. SAML-Zeichen müssen in {product-name} UI zwischen Groß- und Kleinschreibung unterschieden werden.
+
Bei den Attributnamen wird zwischen Groß- und Kleinschreibung unterschieden. Stellen Sie sicher, dass jeder hier konfigurierte SAML-Attributname genau mit der Anwendungskonfiguration übereinstimmt. SAML muss zur Authentifizierung auf die richtige URL verweisen.
+
Bei allen Feldern in `{product-name} UI -> Settings -> SAML Settings` wird zwischen Groß- und Kleinschreibung unterschieden.
+
Die Protokolle des Controllers {product-name} enthalten relevante Informationen über die Authentifizierung mit dem ADFS-Server und Fehler, die bei der Ermittlung der Grundursache helfen. Wir empfehlen, den Zustand der fehlgeschlagenen Anmeldung wiederherzustellen und die Protokolle zu überprüfen.

. Stellen Sie sicher, dass Sie die richtigen Gruppen, Zertifikate und Protokolle eingeben.
+
Die SAML-Einstellungen müssen mit der folgenden Konfiguration übereinstimmen:
+
|===
| Einstellung | Wert

| Identifizieren Sie Provider Single Sign-On URL
| Erfordert HTTPS-Protokoll

| Identitätsanbieter Emittent
| Erfordert HTTP-Protokoll

| ADFS SamlResponseSignatur
| Muss entweder MessageOnly oder MessageAndAssertion sein
|===

[CAUTION]
====
Diese Einstellungen müssen auf Ihrem ADFS-Server und in der Benutzeroberfläche {product-name} validiert werden.
====

Das ausgewählte Zertifikat muss gültig und korrekt generiert sein, einschließlich seiner `CA Root` und `Intermediate Certificates`. Sie können sie mit Ihrer vertrauenswürdigen Zertifizierungsstelle, mit Windows oder einem Automatisierungstool wie https://letsencrypt.org/[] LetsEncrypt erstellen.

Wenn einer dieser Parameter nicht korrekt ist, erhalten Sie eine `Authentication Failed` Fehlermeldung, wenn Sie versuchen, sich bei {product-name} mit einem ADFS-Benutzer unter Verwendung der SAML-Authentifizierung anzumelden.
