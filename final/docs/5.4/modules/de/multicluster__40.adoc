= Multi-Cluster-Management für Unternehmen
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /04.navigation/02.multicluster/02.multicluster.md
:page-opendocs-slug:  /navigation/multicluster

== Unternehmens-Konsole

Die Konsole {product-name} kann für die Verwaltung großer Multi-Cluster- und Multi-Cloud-Bereitstellungen in Unternehmen verwendet werden. Ein Cluster sollte als primärer Cluster ausgewählt werden, und andere Remote-Cluster können dann dem primären Cluster beitreten. Sobald die Verbindung hergestellt ist, kann der primäre Cluster Regeln im Verbund an jeden entfernten Cluster weitergeben, die dann als Regeln im Verbund in den Konsolen der einzelnen entfernten Cluster angezeigt werden. Gescannte Federated Registries synchronisieren die Scanergebnisse auch mit entfernten Clustern. Nur lokale Benutzer und Rancher-Benutzer mit Administratorrechten können einen Cluster zum primären Cluster ernennen.

Zusätzlich zur Federated Policy unterstützt die Multicluster-Verwaltung die Überwachung jedes entfernten Clusters auf einer Übersichtsseite, wie unten dargestellt.

image:multicluster_summary.png[Zusammenfassung]

Es MUSS eine Netzwerkverbindung zwischen den Steuerungen in jedem Cluster an den erforderlichen Ports bestehen. Der Controller wird außerhalb seines Clusters entweder durch einen primären oder einen entfernten Dienst ausgesetzt, wie in der Beispielsdatei {product-name} deployment yaml zu sehen ist.

== Konfigurieren des primären und des entfernten Clusters

Melden Sie sich an der Konsole des Clusters an, der der primäre Cluster sein wird. Wählen Sie im oberen rechten Dropdown-Menü die Option Mehrere Cluster und dann Promote, um den Primary zu konfigurieren. Anmerkung: Nur lokale Benutzer und Rancher-Benutzer mit Administratorrechten können einen Cluster zum primären Cluster ernennen. Derzeit ist es SSO/LDAP/OIDC-Benutzern mit Admin-Rolle nicht erlaubt, einen Cluster zum Primary zu befördern.image:master1.png[MasterConfig]

Geben Sie die öffentliche IP und den Port des fed-master-Dienstes ein. Sie können dies herausfinden, indem Sie

[,shell]
----
kubectl get svc -n neuvector
----

Die Ausgabe wird wie folgt aussehen:

[,shell]
----
NAME                                      TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)                         AGE
neuvector-service-controller-fed-master   LoadBalancer   10.27.249.147   35.238.131.23    11443:31878/TCP                 17d
neuvector-service-controller-fed-worker   LoadBalancer   10.27.251.1     35.226.199.111   10443:32736/TCP                 17d
----

Im obigen Beispiel lautet der Hostname/IP des primären Controllers 35.238.131.23 und der Port 11443. Anmerkung: Vergewissern Sie sich, dass diese IP-Adresse und dieser Port von außen (von den entfernten Clustern) zugänglich sind. Anmerkung: Die Systemuhren (Zeit) müssen für jeden primären und entfernten Cluster übereinstimmen, damit sie ordnungsgemäß funktionieren.

Nachdem Sie sich wieder in die Konsole eingeloggt haben, wählen Sie im Menü oben rechts erneut Multiple Clusters aus und klicken auf das Symbol, um ein Token zu generieren, das für die Verbindung mit den Remote Clusters benötigt wird. Kopieren Sie den Token zur Verwendung im nächsten Schritt. Das Token ist etwa 1 Stunde lang gültig und muss nach Ablauf erneut generiert werden, um eine Verbindung zu künftigen Remote-Clustern herzustellen.

image:master_token.png[Token]

Um einen Remote-Cluster mit dem primären Cluster zu verbinden, melden Sie sich als Administrator an der Konsole des Remote-Clusters an. Wählen Sie in der oberen rechten Dropdown-Liste die Option Mehrere Cluster aus und klicken Sie auf Verbinden. Geben Sie die Controller-IP oder den Hostnamen für den Remote-Cluster sowie den Port ein. Auch hier können Sie diese Informationen vom Remote-Cluster abrufen:

[,shell]
----
kubectl get svc -n neuvector
----

Verwenden Sie die Ausgabe für den fed-worker des entfernten Clusters, um die IP-Adresse und den Port zu konfigurieren. Geben Sie dann den von der Primärseite kopierten Token ein. Beachten Sie, dass nach der Eingabe des Tokens die IP-Adresse und der Port für das primäre System automatisch ausgefüllt werden, diese können jedoch bearbeitet oder manuell eingegeben werden.

image:join_remote.png[JoinRemote]

Melden Sie sich bei dem entfernten Cluster ab und melden Sie sich wieder bei dem primären Cluster an. Wenn Sie bereits angemeldet sind, klicken Sie auf "Aktualisieren" und der Remote-Cluster wird im Menü "Mehrere Cluster" aufgeführt.

image:fed_master_list.png[FedMaster]

Sie können auf das Verwaltungssymbol in der Liste klicken oder das Pulldown-Menü am oberen Rand verwenden, um jederzeit zwischen den Clustern zu wechseln. Sobald Sie zu einem Remote-Cluster gewechselt haben, gelten alle Menüpunkte auf der linken Seite nun für den Remote-Cluster.

== Fehlersuche

Um sicherzustellen, dass die Dienste wie erwartet reagieren, können Sie die Tests von außerhalb der Cluster oder, falls erforderlich, von den Testpods auf den Clustern `fed-master` und `fed-managed` ausführen, um sicherzustellen, dass die Netzwerkverbindung zwischen den Clustern zulässig ist.

=== Überprüfen des fed-master-Dienstes

Der Clusterdienst-Port `11443` ist nur nach Aktivierung des Dienstes `fed-master` zugänglich. Der folgende Befehl gibt einen Fehlercode zurück, wenn der Dienst `fed-master` antwortet, dass die angeforderte Ressource nicht verfügbar ist.

.Beispiel für die Ausgabe
[,shell]
----
{"code":1,"error":"URL not found","message":"URL not found"}
----

[IMPORTANT]
====
Die URL für den Befehl `curl` hängt davon ab, wie der Dienst `fed-master` bereitgestellt wird. Wenn ein `ingress` Dienst konfiguriert ist, ist es nicht notwendig, einen Port anzugeben.
====

[,shell]
----
curl -v https://<fed-master>[:<port>]/v1/eula
----

=== Überprüfen von fed-managed service

Der Port `10443` des Clusterdienstes wird von `REST API` und dem Dienst `fed-managed` gemeinsam genutzt. Der folgende Befehl gibt einen Erfolgscode zurück, wenn der Dienst `fed-managed` antwortet, um anzuzeigen, dass er verfügbar ist.

.Beispiel für die Ausgabe
[,shell]
----
{"eula":{"accepted":true}})
----

[IMPORTANT]
====
Die URL für den Befehl `curl` hängt davon ab, wie der Dienst `fed-managed` bereitgestellt wird. Wenn ein `ingress` Dienst konfiguriert ist, ist es nicht notwendig, einen Port anzugeben.
====

[,shell]
----
curl -v https://<fed-managed>[:<port>]/v1/eula
----

== Föderale Politik

Anweisungen zum Erstellen von Regeln für den Verbund, die an die einzelnen Cluster weitergegeben werden, finden Sie im Abschnitt Richtlinien -> Verbundrichtlinien.

== Föderierte Register für verteiltes Bildscannen Ergebnisse

Der primäre (Master-)Cluster kann eine als Verbundregistry bezeichnete Registry/Repo scannen. Die Scanergebnisse aus diesen Registern werden mit allen verwalteten (entfernten) Clustern synchronisiert. Dies ermöglicht die Anzeige der Scan-Ergebnisse in der Konsole des verwalteten Clusters sowie die Verwendung der Ergebnisse in den Regeln für die Zugangskontrolle des verwalteten Clusters. Die Register müssen nur einmal gescannt werden, anstatt von jedem Cluster, was die CPU/Speicher- und Netzwerkbandbreitennutzung reduziert.

Verbundregistrierungen können nur von einem Verbundadministrator auf dem primären Cluster unter Assets -> Registries konfiguriert werden. Nach dem Hinzufügen und Scannen eines Verbund-Repositorys werden die Scanergebnisse mit allen verwalteten Clustern synchronisiert. Zulassungskontrollregeln in jedem verwalteten Cluster, die Image-Scans erfordern (z. B. CVE- und Compliance-basierte Regeln), verwenden automatisch sowohl die Ergebnisse von Verbund-Scans als auch alle lokal konfigurierten Ergebnisse von Registrierungs-Scans.

=== Ergebnisse von CI/CD-Scannern zusammenführen (optional)

Die Ergebnisse von Federated Registry Scans werden immer mit den verwalteten Clustern synchronisiert, wie oben beschrieben. Der primäre Cluster kann auch Scan-Ergebnisse xref:scanners.adoc#_standalone_scanner_for_local_scanning[von eigenständigen Scanner-Scans] oder Scanner-Plug-ins empfangen, die von einer Build-CI/CD-Pipeline aufgerufen werden. Damit die Ergebnisse der Repository-Scans in der Build-Phase (CI/CD) auch mit den verwalteten Clustern synchronisiert werden können, müssen Sie dies zunächst aktivieren, indem Sie die Einstellungen des primären (Master-)Clusters wie unten dargestellt bearbeiten.

image:fed_primary_config.png[master_settings]

image:fed_reg_sync.png[fed_sync]
