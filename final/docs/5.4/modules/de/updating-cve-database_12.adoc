= Aktualisierung der CVE-Datenbank
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /06.scanning/05.updating/05.updating.md
:page-opendocs-slug:  /scanning/updating

== Aktualisierung der {product-name} CVE-Sicherheitsanfälligkeiten-Datenbank

Das Scanner-Image/POD führt die Scans mit seiner internen CVE-Datenbank durch. Das Scanner-Image wird häufig auf dem {product-name} Docker Hub-Registry mit der neuesten CVE-Datenbank aktualisiert, so oft wie täglich, wenn es Updates gibt. Um die in Scans verwendete CVE-Datenbank zu aktualisieren, ziehen Sie einfach das neueste Scanner-Image und setzen Sie es ein. Die neueste Datenbankversionsnummer finden Sie https://raw.githubusercontent.com/neuvector/manifests/main/versions/scanner[hier].

Ein Container namens Updater führt die Aufgabe aus, die Scanner-Pods neu zu starten, um einen Pull des neuesten Images zu erzwingen, was die CVE-Datenbank aktualisiert. Um automatisch nach Updates zu suchen und den Scanner zu aktualisieren, kann ein Updater-Cron-Job erstellt werden.

Standardmäßig wird der unten gezeigte Updater-Cron-Job automatisch aus den Beispiel-Deployment-YAML-Dateien für Kubernetes und OpenShift gestartet. Dies wird automatisch nach neuen CVE-Datenbank-Updates durch neue Scanner-Versionen suchen, die im {product-name} Docker Hub-Registry veröffentlicht wurden. Manuelle Updates bei Docker-nativen Deployments sind unten aufgeführt. Für OpenShift-Deployments oder andere, bei denen Images manuell von {product-name} gezogen werden müssen, sollte das Scanner-Image mit dem 'latest'-Tag von {product-name} gezogen werden, um die CVE-Datenbank zu aktualisieren.

Für das Scannen von Registries, wenn das Kästchen 'Nach CVE-DB-Update erneut scannen' aktiviert ist, werden alle Images in dieser Registry nach einem CVE-Datenbank-Update erneut gescannt.  Für das Scannen zur Laufzeit werden alle laufenden Assets nach einem CVE-Datenbank-Update erneut gescannt, wenn die Auto-Scan-Funktion aktiviert ist.

=== Updater-Cron-Job

Dieser Cron-Job wird automatisch von {product-name} als Teil des Beispiel-Deployments bereitgestellt, sodass er normalerweise nicht manuell gestartet werden muss.

Der Updater ist ein Container-Image, das, wenn es ausgeführt wird, das Scanner-Deployment neu startet und den Pull des neuesten Scanner-Images erzwingt. Der Updater setzt alle Scanner-Pods neu ein, indem er das Deployment auf null setzt und es wieder hochskaliert.

Das Beispiel für den Cron-Job neuvector-updater.yaml unten für Kubernetes 1.8 und höher führt den Updater jeden Tag um Mitternacht aus. Der Zeitplan kann nach Belieben angepasst werden.

Beispiel für Updater yaml:

[,yaml]
----
apiVersion: batch/v1
kind: CronJob
metadata:
  name: neuvector-updater-pod
  namespace: neuvector
spec:
  schedule: "0 0 * * *"
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app: neuvector-updater-pod
        spec:
          containers:
          - name: neuvector-updater-pod
            image: neuvector/updater
            imagePullPolicy: Always
            command:
            - /bin/sh
            - -c
            - TOKEN=`cat /var/run/secrets/kubernetes.io/serviceaccount/token`; /usr/bin/curl -kv -X PATCH -H "Authorization:Bearer $TOKEN" -H "Content-Type:application/strategic-merge-patch+json" -d '{"spec":{"template":{"metadata":{"annotations":{"kubectl.kubernetes.io/restartedAt":"'`date +%Y-%m-%dT%H:%M:%S%z`'"}}}}}' 'https://kubernetes.default/apis/apps/v1/namespaces/neuvector/deployments/neuvector-scanner-pod'
          restartPolicy: Never
----

[NOTE]
====
Wenn der All-in-One-Container anstelle des Controllers bereitgestellt wurde, ersetzen Sie neuvector-svc-controller.neuvector durch neuvector-svc-allinone.neuvector
====

Um den Cron-Job auszuführen

[,shell]
----
kubectl create -f neuvector-updater.yaml
----

== Docker Native Updates

[IMPORTANT]
====
Verwenden Sie immer das Tag :latest, wenn Sie das Scanner-Image ziehen und ausführen, um sicherzustellen, dass die neueste CVE-Datenbank bereitgestellt wird.
====

Für Docker Native:

[,shell]
----
docker stop scanner
docker rm <scanner id>
docker pull neuvector/scanner:latest
<docker run command from below>
----

[NOTE]
====
`docker rm -f <scanner id>` kann auch verwendet werden, um das laufende Scanner zu stoppen und zu entfernen.
====

Für Docker-Compose

[,shell]
----
docker-compose -f file.yaml down
docker-compose -f file.yaml pull        // pre-pull the image before starting the scanner
docker-compose -f file.yaml up -d
----

Beispiel für Docker Run

[,bash]
----
docker run -td --name scanner -e CLUSTER_JOIN_ADDR=controller_node_ip -e CLUSTER_ADVERTISED_ADDR=node_ip -e SCANNER_DOCKER_URL=tcp://192.168.1.10:2376 -p 18402:18402 -v /var/run/docker.sock:/var/run/docker.sock:ro neuvector/scanner:latest
----

Und Beispiel für Docker-Compose

[,yaml]
----
Scanner:
   image: neuvector/scanner:latest
   container_name: scanner
   environment:
     - SCANNER_DOCKER_URL=tcp://192.168.1.10:2376
     - CLUSTER_JOIN_ADDR=controller_node_ip
     - CLUSTER_ADVERTISED_ADDR=node_ip
   ports:
     - 18402:18402
   volumes:
     - /var/run/docker.sock:/var/run/docker.sock:ro
----

== CVE-Datenbankversion

Die CVE-Datenbankversion kann in der Konsole im Tab "Schwachstellen" angezeigt werden. Sie können auch die Protokolle des Scanner-Containers oder das Updater-Image überprüfen.

Um die REST-API zu verwenden, um die Version abzufragen:

[,shell]
----
curl -k -H "Content-Type: application/json" -H "X-Auth-Token: $_TOKEN_" "https://127.0.0.1:10443/v1/scan/scanner"
----

Ausgabe:

[,json]
----
{
    "scanners": [
        {
            "cvedb_create_time": "2020-07-07T10:34:04Z",
            "cvedb_version": "1.950",
            "id": "0f043705948557828ac1831ee596588a0d050950113117ddd19ecd604982f4d9",
            "port": 18402,
            "server": "127.0.0.1"
        },
        {
            "cvedb_create_time": "2020-07-07T10:34:04Z",
            "cvedb_version": "1.950",
            "id": "9fa02c644d603f59331c95735158d137002d32a75ed1014326f5039f38d4d717",
            "port": 18402,
            "server": "192.168.9.95"
        }
    ]
}
----

Verwendung von kubectl:

[,bash]
----
kubectl logs neuvector-scanner-pod-5687dcb6fd-2h4sj -n neuvector | grep version
----

Beispielausgabe:

[,shell]
----
2020-09-15T00:00:57.909|DEBU|SCN|memdb.ReadCveDb: New DB found - update=2020-09-14T10:37:56Z version=2.04
2020-09-15T00:01:10.06 |DEBU|SCN|main.scannerRegister: - entries=47016 join=neuvector-svc-controller.neuvector:18400 version=2.040
----

Oder für Docker:

[,bash]
----
docker logs <scanner container id or name> | grep version
----

[,shell]
----
2020-09-15T00:00:57.909|DEBU|SCN|memdb.ReadCveDb: New DB found - update=2020-09-14T10:37:56Z version=2.04
2020-09-15T00:01:10.06 |DEBU|SCN|main.scannerRegister: - entries=47016 join=neuvector-svc-controller.neuvector:18400 version=2.040
----

== Manuelle Updates auf Kubernetes

Unten ist ein Beispiel für das manuelle Aktualisieren der CVE-Datenbank auf Kubernetes oder OpenShift.

Führen Sie die untenstehende Aktualisierungsdatei aus

[,shell]
----
kubectl create -f neuvector-manual-updater.yaml
----

Beispiel-Datei

[,yaml]
----
apiVersion: v1
kind: Pod
metadata:
  name: neuvector-updater-pod
  namespace: neuvector
spec:
  containers:
  - name: neuvector-updater-pod
    image: neuvector/updater
    imagePullPolicy: Always
    command:
    - /bin/sh
    - -c
    - TOKEN=`cat /var/run/secrets/kubernetes.io/serviceaccount/token`; /usr/bin/curl -kv -X PATCH -H "Authorization:Bearer $TOKEN" -H "Content-Type:application/strategic-merge-patch+json" -d '{"spec":{"template":{"metadata":{"annotations":{"kubectl.kubernetes.io/restartedAt":"'`date +%Y-%m-%dT%H:%M:%S%z`'"}}}}}' 'https://kubernetes.default/apis/apps/v1/namespaces/neuvector/deployments/neuvector-scanner-pod'
  restartPolicy: Never
----
