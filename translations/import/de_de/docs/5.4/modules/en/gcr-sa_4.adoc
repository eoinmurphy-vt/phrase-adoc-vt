= GCR-Scanning mit Dienstkonten
:revdate: 2024-09-27
:page-revdate: {revdate}
:page-opendocs-origin: /06.scanning/02.registry/03.gcr-sa/03.gcr-sa.md
:page-opendocs-slug:  /scanning/registry/gcr-sa

== Google GCR - Authentifizierung/Scanning mit GCP-Dienstkonten

Es ist eine bewährte Praxis, nicht von benutzterattributierten Konten für Integrationen abhängig zu sein.  GCP unterstützt die Verwendung eines Dienstkontos zum Zugriff auf GCR.  Hier sind die Schritte, um ein Dienstkonto für GCR zu aktivieren und es zu verwenden, um Repository-Scans von {product-name} aus auszulösen.

Beginnen Sie in {product-name}, wo man zunächst ein neues Registry einrichtet:

image:gcr1.png[GCR]

Durch die Auswahl von Google Container Registry als Repo-Typ wird dieses Panel angepasst, um die Eingaben zu akzeptieren, die erforderlich sind, um Ihr GCR zu verwenden.

. Name - Hier geben Sie diesem speziellen Repo-Eintrag einen Namen Ihrer Wahl. Es dient lediglich dazu, es später in der {product-name}-Schnittstelle zu identifizieren.
. Registry - Dies ist der erste Ort, an dem Sie sicherstellen möchten, dass die richtigen Daten von Ihrer GCR-Instanz gesammelt werden. Während das Beispiel von https://gcr.io das häufigste ist, möchten wir sicherstellen, dass es genau widerspiegelt, wie Ihr GCR in GCP eingerichtet wurde. Es könnte zum Beispiel https://us.gcr.io sein. Wir werden es im nächsten Abschnitt überprüfen.
. JSON-Schlüssel - Wie offensichtlich ist, wird dies ein im JSON-Format vorliegender Schlüssel sein. Und, wie Sie wahrscheinlich ein Muster erkennen, werden wir das über GCP finden.
. Filter - Seien Sie sich bewusst, dass Sie wahrscheinlich alle Filter hier durch den tatsächlichen Namen des Repos ersetzen müssen. Nochmals, das ist in der GCR-Schnittstelle.

image:gcr2.png[GCR]

Jetzt gehen wir zu diesem GCR-Bildschirm in GCP. Vieles von dem, was wir brauchen, ist direkt hier auf dieser Seite.

[upperalpha]
. Siehe die &quot;`+gcr.io+`&quot; unter Hostname? Das gehört in Punkt #2, Registry in der {product-name} Schnittstelle. (Vergessen Sie nicht den https:// Teil)
. Die ID des Repos befindet sich tatsächlich unter dem obersten Projekt. Das ist das, was Sie in #3, Filter verwenden werden. Siehe Beispiel von env-demo unten.

image:gcr3.png[GCR]

Der JSON-Schlüssel führt uns dazu, einen weiteren sehr wichtigen Schritt zu erkunden, und das bringt uns zum IAM & Admin-Bereich von GCP, wo wir ein Dienstkonto erstellen (oder die Einstellung bestätigen) werden. Siehe unten:

image:gcr4.png[GCR]

Sobald Sie die Daten für den ersten Schritt zur Erstellung eines Dienstkontos eingegeben haben, müssen Sie die &quot;`+CREATE+`&quot; Schaltfläche drücken, damit Schritt 2 bereit ist, Eingaben zu akzeptieren.

image:gcr5.png[GCR]

Stellen Sie sicher, dass Sie Basic --> Viewer für den Zugriff auswählen. Wenn Sie ein bestehendes Dienstkonto haben, stellen Sie sicher, dass der Zugriff so eingestellt ist. (Hinweis: Selbst Zugriffsberechtigungen, die mächtiger erscheinen, scheinen keinen ordnungsgemäßen Zugriff zu erlauben. Überspringen Sie diesen Schritt nicht.

Sobald Sie diesen Schritt abgeschlossen haben, können Sie Schritt 3 problemlos überspringen und mit der Erstellung des Dienstkontos fortfahren.

Wenn Sie nicht sofort auf das Informationsfeld für Ihr neues Dienstkonto gelangen, stellen Sie sicher, dass Sie dort in der Liste der Dienstkonten gehen. Siehe Abbildung 5 unten.

image:gcr6.png[GCR]

Klicken Sie auf &quot;`+ADD KEY+`&quot; --> &quot;`+Create New Key+`&quot;

image:gcr7.png[GCR]

Wie Sie bereits festgestellt haben, ist JSON hier der Weg. Die Auswahl von &quot;`+CREATE+`&quot; führt zu einer Datei, die Sie in Ihrem Browser herunterladen können. Der Inhalt dieser Datei sollte in das Feld 3, JSON-Schlüssel in {product-name} eingefügt werden; siehe Abbildung 1.

Bevor Sie zu aufgeregt werden, gibt es noch eine Sache zu beachten. Damit der Scanner in {product-name} die API verwenden kann, um Ihre Bilder zu scannen und zu schützen, muss die genannte API in Ihrem GCP-Konto aktiviert sein. Sie können es entweder über die Befehlszeile aktivieren über

[,shell]
----
gcloud services enable artifactregistry.googleapis.com
----

Oder Sie können die GCP-GUI verwenden. Gehen Sie zu &quot;`+API Library+`&quot; und suchen Sie nach &quot;`+Artifact Registry API+`&quot; und stellen Sie sicher, dass es für Ihr Projekt aktiviert ist. Siehe Abbildung 7.

image:gcr8.png[GCR]

Sie sollten bereit sein! Siehe Abbildung 8 unten für ein richtig konfiguriertes Registry mit den Daten aus unserem Beispiel:

image:gcr9.png[GCR]

=== Erhalten Sie das Zugriffstoken über die REST-API

Die {product-name} REST-API kann verwendet werden, um sich mit dem Dienstkonto zu authentifizieren. Das folgende Beispiel verwendet gcloud, um das Zugriffstoken zu erhalten.  Der Benutzername ist &quot;`+oauth2accesstoken+`&quot;.

[,shell]
----
gcloud auth print-access-token
ya29.a0AfH6SMAvyZ2zkD3MZD_K8Lqr7qkIsRkGNqhAGthJ_A7lp8OGRe7xh5KmuQY-VJfqu83C9e1gi7A_m1InNm8QIoTGf9WHXnOeAr1gT_O6b6K667NUz1_YDunjdW09jt0XvcBGQaxjJ3c4aHlxdehBFiE_9PMk13JDt_T6f0_6vzS7
----

=== Verwenden Sie das Token mit der {product-name} Repository-Scannung

Das folgende Beispielskript integriert das Zugriffstoken, um den GCR-Repository-Scan auszulösen.

[,shell]
----
_curCase_=`+echo $0 | awk -F"." '{print $(NF-1)}' | awk -F"/" '{print $NF}'+`
_DESC_="able to scan ubuntu:16.04 image"
_ERRCODE_=0
_ERRTYPE_=1
_RESULT_="pass"

# please remember to specify the controller ip address here
_controllerIP_="10.1.24.252"
_controllerRESTAPIPort_="10443"
_neuvectorUsername_="admin"
_neuvectorPassword_="admin"
_registryURL_="https://us.gcr.io/"

# registry urls could also be gcr.io, eu.gcr.io, asia.gcr.io etc
_registryUsername_="oauth2accesstoken"
_registryPassword_=$(gcloud auth print-access-token)
_repository_="bionic-union-271100/alpine"
_tag_="latest"

curl -k -H "Content-Type: application/json" -d '{"password": {"username": "'$_neuvectorUsername_'", "password": "'$_neuvectorPassword_'"}}' "https://$_controllerIP_:$_controllerRESTAPIPort_/v1/auth" > /dev/null 2>&1 > token.json
_TOKEN_=`+cat token.json | jq -r '.token.token'+`
echo `+date +%Y%m%d_%H%M%S+` scanning an image ...
curl -k -H "Content-Type: application/json" -H "X-Auth-Token: $_TOKEN_" -d '{"request": {"registry": "'$_registryURL_'", "username": "'$_registryUsername_'", "password": "'$_registryPassword_'", "repository": "'$_repository_'", "tag": "'$_tag_'"}}' "https://$_controllerIP_:$_controllerRESTAPIPort_/v1/scan/repository" > /dev/null 2>&1 > scan_repository.json

while [ `+wc -c < scan_repository.json+` = "0" ]; do
 echo `+date +%Y%m%d_%H%M%S+` scanning is still in progress ...
    sleep 5
    curl -k -H "Content-Type: application/json" -H "X-Auth-Token: $_TOKEN_" -d '{"request": {"registry": "'$_registryURL_'", "username": "'$_registryUsername_'", "password": "'$_registryPassword_'", "repository": "'$_repository_'", "tag": "'$_tag_'"}}' "https://$_controllerIP_:$_controllerRESTAPIPort_/v1/scan/repository" > /dev/null 2>&1 > scan_repository.json
done

echo `+date +%Y%m%d_%H%M%S+` log out
curl -k -X 'DELETE' -H "Content-Type: application/json" -H "X-Auth-Token: $_TOKEN_" "https://$_controllerIP_:$_controllerRESTAPIPort_/v1/auth" > /dev/null 2>&1
cat scan_repository.json | jq .
rm *.json
echo `+date +%Y%m%d_%H%M%S+` [$_curCase_] $_DESC_: $_RESULT_-$_ERRCODE_
----
